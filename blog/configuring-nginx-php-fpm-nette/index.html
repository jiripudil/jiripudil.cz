<!DOCTYPE html><html lang="en"> <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><title>Configuring Nginx and PHP-FPM (and Nette) – Blog – Jiří Pudil</title><style>.body[data-astro-cid-relfimn4]{padding:1.5rem 0}h1[data-astro-cid-relfimn4]{text-wrap:balance}.metadata[data-astro-cid-relfimn4]{display:flex;align-items:start;justify-content:space-between;gap:1rem;margin-bottom:3rem;ul{margin:0;padding:0;list-style:none;display:flex;flex-wrap:wrap;gap:0 .5rem;font-size:.9rem;a{color:var(--body-diminished-color);&:hover{color:var(--body-text-color)}}}time{flex-shrink:0;color:var(--body-diminished-color)}}.perex[data-astro-cid-relfimn4]{font-size:1.15rem}.content[data-astro-cid-relfimn4]{h2{margin-top:3rem}h3{margin-top:2.25rem}p{text-wrap:pretty;hyphens:auto}:is(ul,ol) li{line-height:1.6;margin-bottom:.5rem}blockquote{position:relative;&:before{content:"“";position:absolute;left:-2.25rem;top:0;color:var(--body-accent-color);font-size:4rem}}img{max-width:100%;height:auto}iframe{max-width:100%;aspect-ratio:16 / 9}code{hyphens:none}.astro-code{margin:.5rem 0;padding:.5rem;font-size:.9rem;tab-size:4}}.comments[data-astro-cid-relfimn4]{margin-top:3rem}@media (max-width: 40rem){.metadata[data-astro-cid-relfimn4]{flex-direction:column;align-items:start;justify-content:start}}
</style><link rel="stylesheet" href="/_astro/about.BrkH-_VM.css"><meta name="generator" content="Astro v5.7.8"><meta name="theme-color" content="#fff" media="(prefers-color-scheme: light)"><meta name="theme-color" content="#242428" media="(prefers-color-scheme: dark)"><link rel="sitemap" href="/sitemap-index.xml"><link rel="alternate" type="application/rss+xml" title="Blog – Jiří Pudil" href="/blog/rss.xml"><link rel="alternate" type="application/rss+xml" title="Notes – Jiří Pudil" href="/notes/rss.xml"><link rel="webmention" href="https://webmention.io/jiripudil.cz/webmention"><meta name="google-site-verification" content="7fHBkeNq7LXO24W8IjCc37NT9MX-6RJxD3Co5F-bRQw"><meta property="og:site_name" content="Jiří Pudil"><meta property="og:title" content="Configuring Nginx and PHP-FPM (and Nette) – Blog"><meta property="og:type" content="article"><meta property="article:published_time" content="2014-06-17T17:30:00.000Z"><meta property="article:tag" content="nettefw"><meta property="article:tag" content="nginx"><meta property="article:tag" content="php"><meta property="article:tag" content="server"><link rel="manifest" href="/manifest.webmanifest"><meta name="mobile-web-app-capable" content="yes"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#fff"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#000"><meta name="application-name" content="Jiří Pudil"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-precomposed.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#fff"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="apple-mobile-web-app-title" content="Jiří Pudil"><link rel="icon" type="image/x-icon" href="/favicon.ico"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="48x48" href="/favicon-48x48.png"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><meta name="msapplication-TileColor" content="#fff"><meta name="msapplication-TileImage" content="/mstile-144x144.png"><meta name="msapplication-config" content="/browserconfig.xml"><link rel="yandex-tableau-widget" href="/yandex-browser-manifest.json"></head> <body> <div class="header" data-astro-cid-3ef6ksr2> <div class="container" data-astro-cid-d6puh33w>  <nav class="menu" data-astro-cid-3ef6ksr2> <ul data-astro-cid-3ef6ksr2> <li class="name" data-astro-cid-3ef6ksr2> <a href="/" title="Home" data-astro-cid-3ef6ksr2>
Jiří Pudil
</a> </li> <li data-astro-cid-3ef6ksr2> <a href="/about" data-astro-cid-3ef6ksr2>
About
</a> </li> <li data-astro-cid-3ef6ksr2> <a href="/projects" data-astro-cid-3ef6ksr2>
Projects
</a> </li> <li data-astro-cid-3ef6ksr2> <a href="/blog" class="active" data-astro-cid-3ef6ksr2>
Blog
</a> </li> <li data-astro-cid-3ef6ksr2> <a href="/notes" data-astro-cid-3ef6ksr2>
Notes
</a> </li> <li data-astro-cid-3ef6ksr2> <a href="/talks" data-astro-cid-3ef6ksr2>
Talks
</a> </li> </ul> </nav>  </div>  </div>    <div class="container" data-astro-cid-d6puh33w>  <div class="body" data-astro-cid-relfimn4> <h1 data-astro-cid-relfimn4>Configuring Nginx and PHP-FPM (and Nette)</h1> <div class="metadata" data-astro-cid-relfimn4> <ul data-astro-cid-relfimn4> <li data-astro-cid-relfimn4><a href="/blog/tag/nettefw" data-astro-cid-relfimn4>#nettefw</a></li><li data-astro-cid-relfimn4><a href="/blog/tag/nginx" data-astro-cid-relfimn4>#nginx</a></li><li data-astro-cid-relfimn4><a href="/blog/tag/php" data-astro-cid-relfimn4>#php</a></li><li data-astro-cid-relfimn4><a href="/blog/tag/server" data-astro-cid-relfimn4>#server</a></li> </ul> <time datetime="2014-06-17T17:30:00.000Z" data-astro-cid-relfimn4> Jun 17, 2014 </time> </div> <p class="perex" data-astro-cid-relfimn4>This text provides a comprehensive guide on how to configure Nginx and PHP-FPM and make it run smoothly with Nette framework.</p> <div class="content" data-astro-cid-relfimn4> <p>Apache has been the most proliferated webserver for ages. But it has its limitations. Once the number of concurrent
requests reaches certain heights (which can be <a href="http://www.theorganicagency.com/apache-vs-nginx-performance-comparison/">as little as tens</a>),
it starts to fall behind. That’s when Nginx comes to the rescue with its event-driven, asynchronous, single-threaded
architecture. Let’s get started right away.</p>
<h2 id="installation">Installation</h2>
<p>Nginx comes <a href="http://nginx.org/en/linux_packages.html">prepackaged</a> for most Linux distros and can be of course <a href="http://nginx.org/en/docs/configure.html">built
from source</a>. Since Nginx, unlike Apache, doesn’t have any PHP module, you
also need to have PHP built with the <code>--enable-fpm</code> option, so that the FPM (FastCGI Process Manager) SAPI is installed.
Alternatively, various distros have FPM bundled in an easy-to-install package (e.g. <code>php5-fpm</code> in Debian’s <code>apt</code>).</p>
<h2 id="configuring-the-web-server">Configuring the web server</h2>
<p>Nginx has a very expressive configuration syntax and very powerful and easy-to-master rewrite module. Now, before
moving on, you should read thoroughly through Martin Fjordvald’s <a href="http://blog.martinfjordvald.com/2010/07/nginx-primer/">primer</a>
and the documentation entry on the <a href="http://nginx.org/en/docs/http/ngx_http_core_module.html#location"><code>location</code> directive</a>.
It should give you the gist of the location-based way Nginx is configured and the hierarchy of its configuration contexts.</p>
<p>The main configuration file resides in <code>/etc/nginx/nginx.conf</code> and contains lots of directives. I’ll just pin-point
the options which configure how many concurrent connections Nginx can handle - the actual number is the product
of <code>worker_processes</code> and <code>worker_connections</code>. I recommend setting <code>worker_processes</code> to the number of CPU cores
to prevent Nginx from getting locked waiting for slow I/O operations. As for <code>worker_connections</code>, I’d stick with 1024,
as it keeps a good balance between performance and effective resource usage. You can raise the number though if your
needs are more demanding.</p>
<h3 id="setting-up-a-virtual-host">Setting up a virtual host</h3>
<p>Now, one of the most important lines in the config file is this:</p>
<pre class="astro-code astro-code-themes OneLight OneDark" style="background-color:#FAFAFA;--shiki-dark-bg:#282C34;color:#383A42;--shiki-dark:#ABB2BF; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>	include /etc/nginx/sites-enabled/*;</span></span></code></pre>
<p>It includes all virtual hosts configurations from given folder - a concept with which you might be familiar from Apache.
And as in Apache, it is a good practice to keep all configurations in <code>sites-available</code> directory and only symlink
to them in <code>sites-enabled</code>. Without further jibber-jabber, here’s my <code>/etc/nginx/sites-available/jiripudil.cz</code>
virtual host definition:</p>
<pre class="astro-code astro-code-themes OneLight OneDark" style="background-color:#FAFAFA;--shiki-dark-bg:#282C34;color:#383A42;--shiki-dark:#ABB2BF; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>server {</span></span>
<span class="line"><span>	server_name	*.jiripudil.cz;</span></span>
<span class="line"><span>	rewrite		^(.*)	http://jiripudil.cz$1 permanent;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>server {</span></span>
<span class="line"><span>	server_name	jiripudil.cz;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>	root		/var/www/jiripudil.cz/www;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>	access_log	/var/www/jiripudil.cz/log/access.log;</span></span>
<span class="line"><span>	error_log	/var/www/jiripudil.cz/log/error.log;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>	include		common.conf;</span></span>
<span class="line"><span>	include		php.conf;</span></span>
<span class="line"><span>	include		nette.conf;</span></span>
<span class="line"><span>}</span></span></code></pre>
<p>As you can see, there are two server definitions. The first one is fair easy. It listens for all requests for any
subdomain and redirects them to the second-level domain URL. Which is, in turn, what the second server listens for.
It sets up the document root and some logging files, and includes three cryptic configurations.</p>
<p><code>common.conf</code> (which gets expanded to <code>/etc/nginx/common.conf</code>) contains some common options:</p>
<pre class="astro-code astro-code-themes OneLight OneDark" style="background-color:#FAFAFA;--shiki-dark-bg:#282C34;color:#383A42;--shiki-dark:#ABB2BF; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span># sets up index file</span></span>
<span class="line"><span>index index.html index.htm;</span></span>
<span class="line"><span></span></span>
<span class="line"><span># hide Nginx server tokens and version number</span></span>
<span class="line"><span>server_tokens off;</span></span>
<span class="line"><span></span></span>
<span class="line"><span># set max post size (for file upload)</span></span>
<span class="line"><span>client_max_body_size 16m;</span></span>
<span class="line"><span>client_body_buffer_size 128k;</span></span>
<span class="line"><span></span></span>
<span class="line"><span># deny access to hidden files</span></span>
<span class="line"><span>location ~ /\.|^\. {</span></span>
<span class="line"><span>	deny all;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span># cache static files</span></span>
<span class="line"><span>location ~* \.(jpe?g|gif|png|css|js|ico|xml)$ {</span></span>
<span class="line"><span>	access_log off;</span></span>
<span class="line"><span>	log_not_found off;</span></span>
<span class="line"><span>	expires max;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span># allow server-side includes for combined files</span></span>
<span class="line"><span>location ~ \.combined\.(js|css)$ {</span></span>
<span class="line"><span>	ssi on;</span></span>
<span class="line"><span>	ssi_types text/css text/javascript application/x-javascript;</span></span>
<span class="line"><span>}</span></span></code></pre>
<p><code>/etc/nginx/nette.conf</code> contains three lines that forward all non-file and non-directory requests to Nette’s front
controller so that it can handle routing on its own. As you can see, Nginx has a mechanism that allows you to write
this in three lines, as opposed to Apache’s mod_rewrite beast:</p>
<pre class="astro-code astro-code-themes OneLight OneDark" style="background-color:#FAFAFA;--shiki-dark-bg:#282C34;color:#383A42;--shiki-dark:#ABB2BF; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>location / {</span></span>
<span class="line"><span>	try_files $uri $uri/ index.php$is_args$args;</span></span>
<span class="line"><span>}</span></span></code></pre>
<h2 id="connecting-to-fpm">Connecting to FPM</h2>
<p>Well, we’ve got our web server set up. But how does PHP know what to do? FPM runs as a separate process after all.
That’s where the third file, <code>/etc/nginx/php.conf</code>, comes to play. In my case, it contains this code:</p>
<pre class="astro-code astro-code-themes OneLight OneDark" style="background-color:#FAFAFA;--shiki-dark-bg:#282C34;color:#383A42;--shiki-dark:#ABB2BF; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>index index.php index.html index.htm;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>location ~ \.php$ {</span></span>
<span class="line"><span>	include fastcgi_params;</span></span>
<span class="line"><span>	fastcgi_pass unix:/var/run/php-fpm/$server_name.socket;</span></span>
<span class="line"><span>	fastcgi_index $document_root/index.php;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>	fastcgi_split_path_info ^((?U).+\.php)(/?.+)$;</span></span>
<span class="line"><span>	fastcgi_param SCRIPT_FILENAME $document_root/$fastcgi_script_name;</span></span>
<span class="line"><span>	fastcgi_param PATH_TRANSLATED $document_root/$fastcgi_path_info;</span></span>
<span class="line"><span>	fastcgi_param PATH_INFO $fastcgi_path_info;</span></span>
<span class="line"><span>}</span></span></code></pre>
<p>This sets the directory index to <code>index.php</code> and makes sure that PHP files are passed to the FPM through a Unix socket.
The <code>fastcgi_params</code> file populates the <code>$_SERVER</code> variable. The trick with <code>fastcgi_split_path_info</code> is a prevention
to a possible security flaw which allows an attacker to execute their own PHP code supplied e.g. via file upload. (You
can read more on this issue <a href="http://blog.martinfjordvald.com/2011/06/why-path-info-is-the-worst-php-feature-since-register-globals/">here</a>.)</p>
<p>We’ve configured Nginx to communicate with PHP over Unix socket. Now we need to make PHP listen on that socket. Head
to <code>/etc/php5/fpm</code> directory and open <code>php-fpm.conf</code> file. Make sure there is a line that contains</p>
<pre class="astro-code astro-code-themes OneLight OneDark" style="background-color:#FAFAFA;--shiki-dark-bg:#282C34;color:#383A42;--shiki-dark:#ABB2BF; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>include=/etc/php5/fpm/pool.d/*.conf</span></span></code></pre>
<p>It includes all pool definitions. If you’re running multiple websites on one server, always have a separate FPM pool
for a each virtual host. You can even go deeper and keep separate pools for different parts of a single website, e.g.
store and forum. Here’s my <code>/etc/php5/fpm/pool.d/jiripudil.cz.conf</code>:</p>
<pre class="astro-code astro-code-themes OneLight OneDark" style="background-color:#FAFAFA;--shiki-dark-bg:#282C34;color:#383A42;--shiki-dark:#ABB2BF; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>[jiripudil.cz]</span></span>
<span class="line"><span></span></span>
<span class="line"><span>listen = /var/run/php-fpm/jiripudil.cz.socket</span></span>
<span class="line"><span>listen.backlog = -1</span></span>
<span class="line"><span></span></span>
<span class="line"><span>user = jiripudil</span></span>
<span class="line"><span>group = www-data</span></span>
<span class="line"><span></span></span>
<span class="line"><span>pm = dynamic</span></span>
<span class="line"><span>pm.max_children = 5</span></span>
<span class="line"><span>pm.min_spare_servers = 2</span></span>
<span class="line"><span>pm.max_spare_servers = 4</span></span></code></pre>
<p>Let’s focus on the <code>pm</code> part. It tells FPM to use dynamic process management, which means that the daemon will control
the number of child processes on its own, based on the other directives. In this rather basic setup, it cannot start
more than 5 processes, i.e. it cannot handle more than five concurrent requests. Low values can lead to bottlenecks
when processes are waiting for I/O operations, while high numbers will most certainly increase the memory usage.
Find the right value for you by measuring the average memory consumption of your website.</p>
<p>The <code>pm.min_spare_servers</code> and <code>pm.max_spare_servers</code> determine how many idle processes FPM can keep and use when needed.
There’re also <code>pm.start_servers</code> option which tells how many processes FPM should create on startup (in this setup it
defaults to 2), and <code>pm.max_requests</code> option which can limit the number of requests one process can handle in its lifetime.
It defaults to 0 (unlimited), but can be set to an exact number to prevent memory leaks.</p>
<p>With PHP-FPM ready, there is still a thing that needs to be pointed out. As <code>/var/run</code> is often mounted onto a temporary
filesystem, you need to ensure that the <code>php-fpm</code> directory in which you store the Unix sockets for different websites
is created after each server reboot. Luckily, this can be done in as little as a single line of shell code. Put the
following script into <code>/etc/init.d/</code> directory and don’t forget to make it executable.</p>
<pre class="astro-code astro-code-themes OneLight OneDark" style="background-color:#FAFAFA;--shiki-dark-bg:#282C34;color:#383A42;--shiki-dark:#ABB2BF; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>#!/bin/sh</span></span>
<span class="line"><span>[ -d /var/run/php-fpm ] || install -m 755 -o www-data -g root -d /var/run/php-fpm</span></span></code></pre>
<h2 id="the-end-and-the-beginning">The end… and the beginning</h2>
<p>You should now have everything set up, where by <em>everything</em> I mean <em>just the tip of the iceberg</em>. Nginx is really
flexible and lets you set up almost everything that comes to your mind, ranging from common tasks including
<a href="http://nginx.org/en/docs/http/ngx_http_auth_request_module.html">authentication</a>,
<a href="http://nginx.org/en/docs/http/ngx_http_ssl_module.html">SSL encryption</a>,
<a href="http://nginx.org/en/docs/http/ngx_http_gzip_module.html">gzip compression</a>,
or <a href="http://nginx.org/en/docs/http/ngx_http_limit_req_module.html">request rate restrictions</a>,
to really cool stuff like <a href="http://nginx.org/en/docs/http/ngx_http_image_filter_module.html">image filtering</a>
or even <a href="http://wiki.nginx.org/HttpUploadModule">direct file upload</a> without the need to pass the whole thing
through PHP backend (and block a PHP process).</p>
<p>There’re dozens of other topics that this post doesn’t cover, but I’ll leave that to your googling skills. So go on
and tweak your Nginx and PHP-FPM installation, and don’t forget to share your tips in the comments.</p> </div> <div class="comments" data-astro-cid-relfimn4> <div id="giscus-container"></div> <script type="module">const t=document.createElement("script");t.src="https://giscus.app/client.js";t.crossOrigin="anonymous";t.async=!0;t.setAttribute("data-repo","jiripudil/jiripudil.cz");t.setAttribute("data-repo-id","MDEwOlJlcG9zaXRvcnkyNTI5NzY3Nw==");t.setAttribute("data-category","Blog discussions");t.setAttribute("data-category-id","DIC_kwDOAYIDDc4CAfUM");t.setAttribute("data-mapping","og:title");t.setAttribute("data-reactions-enabled","1");t.setAttribute("data-emit-metadata","0");t.setAttribute("data-theme","preferred_color_scheme");t.setAttribute("data-lang","en");t.setAttribute("data-loading","lazy");const e=document.getElementById("giscus-container");e.appendChild(t);</script> </div> </div>  </div>   <div class="footer" data-astro-cid-sz7xmlte> <div class="container" data-astro-cid-d6puh33w> 
Content licensed under
<a href="https://creativecommons.org/licenses/by/4.0/" title="Creative Commons Attribution 4.0 International" aria-label="Creative Commons Attribution 4.0 International" data-astro-cid-sz7xmlte> <svg width="0.97em" height="1em" data-astro-cid-sz7xmlte="true" data-icon="fa6-brands:creative-commons">   <symbol id="ai:fa6-brands:creative-commons" viewBox="0 0 496 512"><path fill="currentColor" d="m245.83 214.87l-33.22 17.28c-9.43-19.58-25.24-19.93-27.46-19.93c-22.13 0-33.22 14.61-33.22 43.84c0 23.57 9.21 43.84 33.22 43.84c14.47 0 24.65-7.09 30.57-21.26l30.55 15.5c-6.17 11.51-25.69 38.98-65.1 38.98c-22.6 0-73.96-10.32-73.96-77.05c0-58.69 43-77.06 72.63-77.06c30.72-.01 52.7 11.95 65.99 35.86m143.05 0l-32.78 17.28c-9.5-19.77-25.72-19.93-27.9-19.93c-22.14 0-33.22 14.61-33.22 43.84c0 23.55 9.23 43.84 33.22 43.84c14.45 0 24.65-7.09 30.54-21.26l31 15.5c-2.1 3.75-21.39 38.98-65.09 38.98c-22.69 0-73.96-9.87-73.96-77.05c0-58.67 42.97-77.06 72.63-77.06c30.71-.01 52.58 11.95 65.56 35.86M247.56 8.05C104.74 8.05 0 123.11 0 256.05c0 138.49 113.6 248 247.56 248c129.93 0 248.44-100.87 248.44-248c0-137.87-106.62-248-248.44-248m.87 450.81c-112.54 0-203.7-93.04-203.7-202.81c0-105.42 85.43-203.27 203.72-203.27c112.53 0 202.82 89.46 202.82 203.26c-.01 121.69-99.68 202.82-202.84 202.82"/></symbol><use href="#ai:fa6-brands:creative-commons"></use>  </svg> <svg width="0.97em" height="1em" data-astro-cid-sz7xmlte="true" data-icon="fa6-brands:creative-commons-by">   <symbol id="ai:fa6-brands:creative-commons-by" viewBox="0 0 496 512"><path fill="currentColor" d="M314.9 194.4v101.4h-28.3v120.5h-77.1V295.9h-28.3V194.4c0-4.4 1.6-8.2 4.6-11.3c3.1-3.1 6.9-4.7 11.3-4.7H299c4.1 0 7.8 1.6 11.1 4.7c3.1 3.2 4.8 6.9 4.8 11.3m-101.5-63.7c0-23.3 11.5-35 34.5-35s34.5 11.7 34.5 35q0 34.5-34.5 34.5c-34.5 0-34.5-11.5-34.5-34.5M247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8m.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3"/></symbol><use href="#ai:fa6-brands:creative-commons-by"></use>  </svg> </a>  </div>  </div>  </body></html> 