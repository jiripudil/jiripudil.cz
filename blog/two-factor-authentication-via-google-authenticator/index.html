<!DOCTYPE html><html lang="en"> <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><title>Two-factor authentication via Google Authenticator – Blog – Jiří Pudil</title><style>.body[data-astro-cid-relfimn4]{padding:1.5rem 0}h1[data-astro-cid-relfimn4]{text-wrap:balance}.metadata[data-astro-cid-relfimn4]{display:flex;align-items:start;justify-content:space-between;gap:1rem;margin-bottom:3rem;ul{margin:0;padding:0;list-style:none;display:flex;flex-wrap:wrap;gap:0 .5rem;font-size:.9rem;a{color:var(--body-diminished-color);&:hover{color:var(--body-text-color)}}}time{flex-shrink:0;color:var(--body-diminished-color)}}.perex[data-astro-cid-relfimn4]{font-size:1.15rem}.content[data-astro-cid-relfimn4]{h2{margin-top:3rem}h3{margin-top:2.25rem}p{text-wrap:pretty;hyphens:auto}:is(ul,ol) li{line-height:1.6;margin-bottom:.5rem}blockquote{position:relative;&:before{content:"“";position:absolute;left:-2.25rem;top:0;color:var(--body-accent-color);font-size:4rem}}img{max-width:100%;height:auto}iframe{max-width:100%;aspect-ratio:16 / 9}code{hyphens:none}.astro-code{margin:.5rem 0;padding:.5rem;font-size:.9rem;tab-size:4}}.comments[data-astro-cid-relfimn4]{margin-top:3rem}@media (max-width: 40rem){.metadata[data-astro-cid-relfimn4]{flex-direction:column;align-items:start;justify-content:start}}
</style><link rel="stylesheet" href="/_astro/about.BrkH-_VM.css"><meta name="generator" content="Astro v5.7.8"><meta name="theme-color" content="#fff" media="(prefers-color-scheme: light)"><meta name="theme-color" content="#242428" media="(prefers-color-scheme: dark)"><link rel="sitemap" href="/sitemap-index.xml"><link rel="alternate" type="application/rss+xml" title="Blog – Jiří Pudil" href="/blog/rss.xml"><link rel="alternate" type="application/rss+xml" title="Notes – Jiří Pudil" href="/notes/rss.xml"><link rel="webmention" href="https://webmention.io/jiripudil.cz/webmention"><meta name="google-site-verification" content="7fHBkeNq7LXO24W8IjCc37NT9MX-6RJxD3Co5F-bRQw"><meta property="og:site_name" content="Jiří Pudil"><meta property="og:title" content="Two-factor authentication via Google Authenticator – Blog"><meta property="og:type" content="article"><meta property="article:published_time" content="2014-11-16T13:00:00.000Z"><meta property="article:tag" content="2fa"><meta property="article:tag" content="nettefw"><meta property="article:tag" content="open-source"><meta property="article:tag" content="php"><meta property="article:tag" content="security"><link rel="manifest" href="/manifest.webmanifest"><meta name="mobile-web-app-capable" content="yes"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#fff"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#000"><meta name="application-name" content="Jiří Pudil"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-precomposed.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#fff"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="apple-mobile-web-app-title" content="Jiří Pudil"><link rel="icon" type="image/x-icon" href="/favicon.ico"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="48x48" href="/favicon-48x48.png"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><meta name="msapplication-TileColor" content="#fff"><meta name="msapplication-TileImage" content="/mstile-144x144.png"><meta name="msapplication-config" content="/browserconfig.xml"><link rel="yandex-tableau-widget" href="/yandex-browser-manifest.json"></head> <body> <div class="header" data-astro-cid-3ef6ksr2> <div class="container" data-astro-cid-d6puh33w>  <nav class="menu" data-astro-cid-3ef6ksr2> <ul data-astro-cid-3ef6ksr2> <li class="name" data-astro-cid-3ef6ksr2> <a href="/" title="Home" data-astro-cid-3ef6ksr2>
Jiří Pudil
</a> </li> <li data-astro-cid-3ef6ksr2> <a href="/about" data-astro-cid-3ef6ksr2>
About
</a> </li> <li data-astro-cid-3ef6ksr2> <a href="/projects" data-astro-cid-3ef6ksr2>
Projects
</a> </li> <li data-astro-cid-3ef6ksr2> <a href="/blog" class="active" data-astro-cid-3ef6ksr2>
Blog
</a> </li> <li data-astro-cid-3ef6ksr2> <a href="/notes" data-astro-cid-3ef6ksr2>
Notes
</a> </li> <li data-astro-cid-3ef6ksr2> <a href="/talks" data-astro-cid-3ef6ksr2>
Talks
</a> </li> </ul> </nav>  </div>  </div>    <div class="container" data-astro-cid-d6puh33w>  <div class="body" data-astro-cid-relfimn4> <h1 data-astro-cid-relfimn4>Two-factor authentication via Google Authenticator</h1> <div class="metadata" data-astro-cid-relfimn4> <ul data-astro-cid-relfimn4> <li data-astro-cid-relfimn4><a href="/blog/tag/2fa" data-astro-cid-relfimn4>#2fa</a></li><li data-astro-cid-relfimn4><a href="/blog/tag/nettefw" data-astro-cid-relfimn4>#nettefw</a></li><li data-astro-cid-relfimn4><a href="/blog/tag/open-source" data-astro-cid-relfimn4>#open-source</a></li><li data-astro-cid-relfimn4><a href="/blog/tag/php" data-astro-cid-relfimn4>#php</a></li><li data-astro-cid-relfimn4><a href="/blog/tag/security" data-astro-cid-relfimn4>#security</a></li> </ul> <time datetime="2014-11-16T13:00:00.000Z" data-astro-cid-relfimn4> Nov 16, 2014 </time> </div> <p class="perex" data-astro-cid-relfimn4>The need for authentication mechanisms that provide more security has been rising during the recent years. Google has ventured into this field with their Authenticator application which is now used not only by Google itself, but also other big players like Github or Dropbox. And you know what? It's not really that difficult to join this elite group. I'm going to show you how.</p> <div class="content" data-astro-cid-relfimn4> <p>The whole thing is based on a Time-Based One-Time Password Algorithm as specified in <a href="https://tools.ietf.org/html/rfc6238">RFC 6238</a>.
The TOTP algorithm - or more generally the HOTP algorithm - generates a pseudo-random numeric passcode based on a secret
and a counter (which in this case is current Unix time). More specifically, you get a new 6-digit code every half a minute.</p>
<p>I’ve written this little <a href="https://github.com/o2ps/TotpAuthenticator">tool</a> that implements the TOTP algorithm in the
same way Google Authenticator does and also can build the URI to exchange the required information with Google Authenticator
application.</p>
<h2 id="installation-and-configuration">Installation and configuration</h2>
<p>Oops/TotpAuthenticator requires PHP >= 5.4 because I’m too lazy to write <code>array()</code>. You can install the package via Composer:</p>
<pre class="astro-code astro-code-themes OneLight OneDark" style="background-color:#FAFAFA;--shiki-dark-bg:#282C34;color:#383A42;--shiki-dark:#ABB2BF; overflow-x: auto;" tabindex="0" data-language="sh"><code><span class="line"><span style="color:#4078F2;--shiki-dark:#61AFEF">$</span><span style="color:#50A14F;--shiki-dark:#98C379"> composer</span><span style="color:#50A14F;--shiki-dark:#98C379"> require</span><span style="color:#50A14F;--shiki-dark:#98C379"> oops/totp-authenticator:~2.0</span></span></code></pre>
<p>If you use Nette, you can easily integrate it. Just add the extension and configure it:</p>
<pre class="astro-code astro-code-themes OneLight OneDark" style="background-color:#FAFAFA;--shiki-dark-bg:#282C34;color:#383A42;--shiki-dark:#ABB2BF; overflow-x: auto;" tabindex="0" data-language="yaml"><code><span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">extensions</span><span style="color:#383A42;--shiki-dark:#ABB2BF">:</span></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">    totp</span><span style="color:#383A42;--shiki-dark:#ABB2BF">: </span><span style="color:#50A14F;--shiki-dark:#98C379">Oops\TotpAuthenticator\DI\TotpAuthenticatorExtension</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">totp</span><span style="color:#383A42;--shiki-dark:#ABB2BF">:</span></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">    issuer</span><span style="color:#383A42;--shiki-dark:#ABB2BF">: </span><span style="color:#50A14F;--shiki-dark:#98C379">MyApplication</span></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">    timeWindow</span><span style="color:#383A42;--shiki-dark:#ABB2BF">: </span><span style="color:#986801;--shiki-dark:#D19A66">1</span></span></code></pre>
<p>The <code>Oops\TotpAuthenticator\Security\TotpAuthenticator</code> will then become available for you to autowire into your
application.</p>
<p>If you don’t use Nette, you can directly instantiate the class:</p>
<pre class="astro-code astro-code-themes OneLight OneDark" style="background-color:#FAFAFA;--shiki-dark-bg:#282C34;color:#383A42;--shiki-dark:#ABB2BF; overflow-x: auto;" tabindex="0" data-language="php"><code><span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">$totpAuthenticator</span><span style="color:#383A42;--shiki-dark:#C678DD"> =</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> (</span><span style="color:#A626A4;--shiki-dark:#C678DD">new</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> Oops\TotpAuthenticator\Security\</span><span style="color:#C18401;--shiki-dark:#E5C07B">TotpAuthenticator</span><span style="color:#383A42;--shiki-dark:#ABB2BF">)</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#C678DD">    -></span><span style="color:#4078F2;--shiki-dark:#61AFEF">setIssuer</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#50A14F;--shiki-dark:#98C379">'MyApp'</span><span style="color:#383A42;--shiki-dark:#ABB2BF">)</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#C678DD">    -></span><span style="color:#4078F2;--shiki-dark:#61AFEF">setTimeWindow</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#986801;--shiki-dark:#D19A66">1</span><span style="color:#383A42;--shiki-dark:#ABB2BF">);</span></span></code></pre>
<p>The <code>timeWindow</code> option sets a benevolence that compensates for possible differences between your server’s time and
Google Authenticator’s time. The default value is 1, which means the code for previous or next 30-second block would
be also considered valid. You can set it to zero if you want to be super strict, but I’d strongly recommend not setting
it to a higher value than one.</p>
<p>The <code>issuer</code> is optional, but is quite useful if you use some generic value as the user’s account name, such as their
email address. As multiple services can use that same value as a way of identifying the user, you should provide <code>issuer</code>
to distinguish your app’s code in the Google Authenticator app.</p>
<h2 id="setting-up-2fa">Setting up 2FA</h2>
<p>In the first step, we need to generate a random secret and store it somewhere with the user, likely in the database.
A security sidenote: The secret is a value that, once exploited, can directly be used to compute the correct 6-digit
code and thus possibly compromise the user’s account. So - and I can’t stress this enough - in your <code>storeSecret()</code>
implementation, a must-have security measure is to encrypt the secret.</p>
<pre class="astro-code astro-code-themes OneLight OneDark" style="background-color:#FAFAFA;--shiki-dark-bg:#282C34;color:#383A42;--shiki-dark:#ABB2BF; overflow-x: auto;" tabindex="0" data-language="php"><code><span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">$secret</span><span style="color:#383A42;--shiki-dark:#C678DD"> =</span><span style="color:#E45649;--shiki-dark:#E06C75"> $totpAuthenticator</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">getRandomSecret</span><span style="color:#383A42;--shiki-dark:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">$this</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#E45649;--shiki-dark:#E06C75">userManager</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">storeSecret</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#E45649;--shiki-dark:#E06C75">$user</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#E45649;--shiki-dark:#E06C75">id</span><span style="color:#383A42;--shiki-dark:#ABB2BF">, </span><span style="color:#E45649;--shiki-dark:#E06C75">$secret</span><span style="color:#383A42;--shiki-dark:#ABB2BF">);</span></span></code></pre>
<p>Now we need to share the secret with the Google Authenticator app. This is most conveniently done via a QR code
(I’ll leave that up to you, you can use e.g Filip Procházka’s <code>qrencode</code> wrapper <a href="https://github.com/Kdyby/QrEncode"><code>Kdyby/QrEncode</code></a>).
The QR code should contain a URI with the secret and the user’s account name. You can pass whatever you use as a unique
identifier for the user, for example an email address:</p>
<pre class="astro-code astro-code-themes OneLight OneDark" style="background-color:#FAFAFA;--shiki-dark-bg:#282C34;color:#383A42;--shiki-dark:#ABB2BF; overflow-x: auto;" tabindex="0" data-language="php"><code><span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">$uri</span><span style="color:#383A42;--shiki-dark:#C678DD"> =</span><span style="color:#E45649;--shiki-dark:#E06C75"> $totpAuthenticator</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">getTotpUri</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#E45649;--shiki-dark:#E06C75">$secret</span><span style="color:#383A42;--shiki-dark:#ABB2BF">, </span><span style="color:#E45649;--shiki-dark:#E06C75">$user</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#E45649;--shiki-dark:#E06C75">email</span><span style="color:#383A42;--shiki-dark:#ABB2BF">);</span></span>
<span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic">// display $uri in a QR code</span></span></code></pre>
<p>You might as well want to display the secret and account name to the user so that they can punch those into Google
Authenticator directly, without scanning the code.</p>
<h2 id="verification">Verification</h2>
<p>The user has just set up the account in Google Authenticator and 6-digit codes have started showing up to them in
30-second cycles. You should, at this moment, ask them to enter the code to verify that everything worked correctly.
Let them enter the code via a form and verify it against their stored secret:</p>
<pre class="astro-code astro-code-themes OneLight OneDark" style="background-color:#FAFAFA;--shiki-dark-bg:#282C34;color:#383A42;--shiki-dark:#ABB2BF; overflow-x: auto;" tabindex="0" data-language="php"><code><span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">if</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> (</span><span style="color:#E45649;--shiki-dark:#E06C75">$totpAuthenticator</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">verifyCode</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#E45649;--shiki-dark:#E06C75">$code</span><span style="color:#383A42;--shiki-dark:#ABB2BF">, </span><span style="color:#E45649;--shiki-dark:#E06C75">$secret</span><span style="color:#383A42;--shiki-dark:#ABB2BF">)) {</span></span>
<span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic">	// successfully verified</span></span>
<span class="line"></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">} </span><span style="color:#A626A4;--shiki-dark:#C678DD">else</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic">	// incorrect code</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">}</span></span></code></pre>
<p>And that’s it. Your users can now enhance their accounts’ security with two-factor authentication via Google
Authenticator app.</p>
<h2 id="closing-thoughts">Closing thoughts</h2>
<p>You might want to take a few further security considerations into account. First, as with any other manipulation with
sensitive data, it’s generally a good idea to have the user enter their account password to prove both that they are
still who they claim they are and that they really know what they’re doing.</p>
<p>Also, at the moment of setting up 2FA, it is quite a good idea to generate a set of recovery codes that the user can
store somewhere secure, so that they don’t get locked out of their account in case they lose access to their phone.
Please make sure that these codes are complex enough and, more importantly, super encrypted.</p>
<h2 id="update-2014-12-03">Update 2014-12-03</h2>
<p><a href="https://www.michalspacek.cz/">Michal Špaček</a> pointed out that - however it may be prominent - Google Authenticator
is not the only TOTP app out there. After a deep thought, I decided to rename the package to something more general:
TotpAuthenticator. I’ve updated all necessary references in this post except the references to Google Authenticator
mobile app. While those remain intact, be assured that the TotpAuthenticator package should be just fine with any
other 2FA app that utilizes the TOTP algorithm.</p> </div> <div class="comments" data-astro-cid-relfimn4> <div id="giscus-container"></div> <script type="module">const t=document.createElement("script");t.src="https://giscus.app/client.js";t.crossOrigin="anonymous";t.async=!0;t.setAttribute("data-repo","jiripudil/jiripudil.cz");t.setAttribute("data-repo-id","MDEwOlJlcG9zaXRvcnkyNTI5NzY3Nw==");t.setAttribute("data-category","Blog discussions");t.setAttribute("data-category-id","DIC_kwDOAYIDDc4CAfUM");t.setAttribute("data-mapping","og:title");t.setAttribute("data-reactions-enabled","1");t.setAttribute("data-emit-metadata","0");t.setAttribute("data-theme","preferred_color_scheme");t.setAttribute("data-lang","en");t.setAttribute("data-loading","lazy");const e=document.getElementById("giscus-container");e.appendChild(t);</script> </div> </div>  </div>   <div class="footer" data-astro-cid-sz7xmlte> <div class="container" data-astro-cid-d6puh33w> 
Content licensed under
<a href="https://creativecommons.org/licenses/by/4.0/" title="Creative Commons Attribution 4.0 International" aria-label="Creative Commons Attribution 4.0 International" data-astro-cid-sz7xmlte> <svg width="0.97em" height="1em" data-astro-cid-sz7xmlte="true" data-icon="fa6-brands:creative-commons">   <symbol id="ai:fa6-brands:creative-commons" viewBox="0 0 496 512"><path fill="currentColor" d="m245.83 214.87l-33.22 17.28c-9.43-19.58-25.24-19.93-27.46-19.93c-22.13 0-33.22 14.61-33.22 43.84c0 23.57 9.21 43.84 33.22 43.84c14.47 0 24.65-7.09 30.57-21.26l30.55 15.5c-6.17 11.51-25.69 38.98-65.1 38.98c-22.6 0-73.96-10.32-73.96-77.05c0-58.69 43-77.06 72.63-77.06c30.72-.01 52.7 11.95 65.99 35.86m143.05 0l-32.78 17.28c-9.5-19.77-25.72-19.93-27.9-19.93c-22.14 0-33.22 14.61-33.22 43.84c0 23.55 9.23 43.84 33.22 43.84c14.45 0 24.65-7.09 30.54-21.26l31 15.5c-2.1 3.75-21.39 38.98-65.09 38.98c-22.69 0-73.96-9.87-73.96-77.05c0-58.67 42.97-77.06 72.63-77.06c30.71-.01 52.58 11.95 65.56 35.86M247.56 8.05C104.74 8.05 0 123.11 0 256.05c0 138.49 113.6 248 247.56 248c129.93 0 248.44-100.87 248.44-248c0-137.87-106.62-248-248.44-248m.87 450.81c-112.54 0-203.7-93.04-203.7-202.81c0-105.42 85.43-203.27 203.72-203.27c112.53 0 202.82 89.46 202.82 203.26c-.01 121.69-99.68 202.82-202.84 202.82"/></symbol><use href="#ai:fa6-brands:creative-commons"></use>  </svg> <svg width="0.97em" height="1em" data-astro-cid-sz7xmlte="true" data-icon="fa6-brands:creative-commons-by">   <symbol id="ai:fa6-brands:creative-commons-by" viewBox="0 0 496 512"><path fill="currentColor" d="M314.9 194.4v101.4h-28.3v120.5h-77.1V295.9h-28.3V194.4c0-4.4 1.6-8.2 4.6-11.3c3.1-3.1 6.9-4.7 11.3-4.7H299c4.1 0 7.8 1.6 11.1 4.7c3.1 3.2 4.8 6.9 4.8 11.3m-101.5-63.7c0-23.3 11.5-35 34.5-35s34.5 11.7 34.5 35q0 34.5-34.5 34.5c-34.5 0-34.5-11.5-34.5-34.5M247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8m.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3"/></symbol><use href="#ai:fa6-brands:creative-commons-by"></use>  </svg> </a>  </div>  </div>  </body></html> 