<!DOCTYPE html><html lang="en"> <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><title>The case for contravariant template types – Blog – Jiří Pudil</title><style>.body[data-astro-cid-relfimn4]{padding:1.5rem 0}h1[data-astro-cid-relfimn4]{text-wrap:balance}.metadata[data-astro-cid-relfimn4]{display:flex;align-items:start;justify-content:space-between;gap:1rem;margin-bottom:3rem;ul{margin:0;padding:0;list-style:none;display:flex;flex-wrap:wrap;gap:0 .5rem;font-size:.9rem;a{color:var(--body-diminished-color);&:hover{color:var(--body-text-color)}}}time{flex-shrink:0;color:var(--body-diminished-color)}}.perex[data-astro-cid-relfimn4]{font-size:1.15rem}.content[data-astro-cid-relfimn4]{h2{margin-top:3rem}h3{margin-top:2.25rem}p{text-wrap:pretty;hyphens:auto}:is(ul,ol) li{line-height:1.6;margin-bottom:.5rem}blockquote{position:relative;&:before{content:"“";position:absolute;left:-2.25rem;top:0;color:var(--body-accent-color);font-size:4rem}}img{max-width:100%;height:auto}iframe{max-width:100%;aspect-ratio:16 / 9}code{hyphens:none}.astro-code{margin:.5rem 0;padding:.5rem;font-size:.9rem;tab-size:4}}.comments[data-astro-cid-relfimn4]{margin-top:3rem}@media (max-width: 40rem){.metadata[data-astro-cid-relfimn4]{flex-direction:column;align-items:start;justify-content:start}}
</style><link rel="stylesheet" href="/_astro/about.BrkH-_VM.css"><meta name="generator" content="Astro v5.7.8"><meta name="theme-color" content="#fff" media="(prefers-color-scheme: light)"><meta name="theme-color" content="#242428" media="(prefers-color-scheme: dark)"><link rel="sitemap" href="/sitemap-index.xml"><link rel="alternate" type="application/rss+xml" title="Blog – Jiří Pudil" href="/blog/rss.xml"><link rel="alternate" type="application/rss+xml" title="Notes – Jiří Pudil" href="/notes/rss.xml"><link rel="webmention" href="https://webmention.io/jiripudil.cz/webmention"><meta name="google-site-verification" content="7fHBkeNq7LXO24W8IjCc37NT9MX-6RJxD3Co5F-bRQw"><meta property="og:site_name" content="Jiří Pudil"><meta property="og:title" content="The case for contravariant template types – Blog"><meta property="og:type" content="article"><meta property="article:published_time" content="2022-12-14T09:30:00.000Z"><meta property="article:tag" content="generics"><meta property="article:tag" content="php"><meta property="article:tag" content="phpstan"><meta property="article:tag" content="static-analysis"><link rel="manifest" href="/manifest.webmanifest"><meta name="mobile-web-app-capable" content="yes"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#fff"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#000"><meta name="application-name" content="Jiří Pudil"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-precomposed.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#fff"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="apple-mobile-web-app-title" content="Jiří Pudil"><link rel="icon" type="image/x-icon" href="/favicon.ico"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="48x48" href="/favicon-48x48.png"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><meta name="msapplication-TileColor" content="#fff"><meta name="msapplication-TileImage" content="/mstile-144x144.png"><meta name="msapplication-config" content="/browserconfig.xml"><link rel="yandex-tableau-widget" href="/yandex-browser-manifest.json"></head> <body> <div class="header" data-astro-cid-3ef6ksr2> <div class="container" data-astro-cid-d6puh33w>  <nav class="menu" data-astro-cid-3ef6ksr2> <ul data-astro-cid-3ef6ksr2> <li class="name" data-astro-cid-3ef6ksr2> <a href="/" title="Home" data-astro-cid-3ef6ksr2>
Jiří Pudil
</a> </li> <li data-astro-cid-3ef6ksr2> <a href="/about" data-astro-cid-3ef6ksr2>
About
</a> </li> <li data-astro-cid-3ef6ksr2> <a href="/projects" data-astro-cid-3ef6ksr2>
Projects
</a> </li> <li data-astro-cid-3ef6ksr2> <a href="/blog" class="active" data-astro-cid-3ef6ksr2>
Blog
</a> </li> <li data-astro-cid-3ef6ksr2> <a href="/notes" data-astro-cid-3ef6ksr2>
Notes
</a> </li> <li data-astro-cid-3ef6ksr2> <a href="/talks" data-astro-cid-3ef6ksr2>
Talks
</a> </li> </ul> </nav>  </div>  </div>    <div class="container" data-astro-cid-d6puh33w>  <div class="body" data-astro-cid-relfimn4> <h1 data-astro-cid-relfimn4>The case for contravariant template types</h1> <div class="metadata" data-astro-cid-relfimn4> <ul data-astro-cid-relfimn4> <li data-astro-cid-relfimn4><a href="/blog/tag/generics" data-astro-cid-relfimn4>#generics</a></li><li data-astro-cid-relfimn4><a href="/blog/tag/php" data-astro-cid-relfimn4>#php</a></li><li data-astro-cid-relfimn4><a href="/blog/tag/phpstan" data-astro-cid-relfimn4>#phpstan</a></li><li data-astro-cid-relfimn4><a href="/blog/tag/static-analysis" data-astro-cid-relfimn4>#static-analysis</a></li> </ul> <time datetime="2022-12-14T09:30:00.000Z" data-astro-cid-relfimn4> Dec 14, 2022 </time> </div> <p class="perex" data-astro-cid-relfimn4>PHPStan has only supported invariant and covariant template types because they are so prevalent in real-world applications. But contravariant template types also have their use cases, and the latest release of PHPStan adds support for them, among other small improvements to generics.</p> <div class="content" data-astro-cid-relfimn4> <p>If used correctly, generics are an awesome tool of abstraction. They’ve been one of the most requested PHP features, and while it’s complicated to introduce them into PHP itself, thanks to PHPStan, we have been allowed to use them for <a href="https://phpstan.org/blog/generics-in-php-using-phpdocs">over two years</a>.</p>
<p>It’s been a blast, and now they are getting even more powerful in <a href="https://github.com/phpstan/phpstan/releases/tag/1.9.3">the latest patch release</a>.</p>
<p>For a long time, PHPStan has only supported invariant and covariant template types. Mainly because for a long time, nobody has asked for contravariant templates. But they have their use cases too, a typical one being comparison. Imagine we have a collection and want to sort it using a <code>Comparator</code>:</p>
<pre class="astro-code astro-code-themes OneLight OneDark" style="background-color:#FAFAFA;--shiki-dark-bg:#282C34;color:#383A42;--shiki-dark:#ABB2BF; overflow-x: auto;" tabindex="0" data-language="php"><code><span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic">/**</span></span>
<span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic"> * @template T</span></span>
<span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic"> */</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">interface</span><span style="color:#C18401;--shiki-dark:#E5C07B"> Collection</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">{</span></span>
<span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic">    /**</span></span>
<span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic">     * </span><span style="color:#A626A4;font-style:italic;--shiki-dark:#C678DD;--shiki-dark-font-style:italic">@param</span><span style="color:#C18401;font-style:italic;--shiki-dark:#E5C07B;--shiki-dark-font-style:italic"> Comparator</span><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic">&#x3C;</span><span style="color:#C18401;font-style:italic;--shiki-dark:#E5C07B;--shiki-dark-font-style:italic">T</span><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic">> $comparator</span></span>
<span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic">     */</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">    public</span><span style="color:#A626A4;--shiki-dark:#C678DD"> function</span><span style="color:#4078F2;--shiki-dark:#61AFEF"> sort</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#C18401;--shiki-dark:#E5C07B">Comparator</span><span style="color:#E45649;--shiki-dark:#E06C75"> $comparator</span><span style="color:#383A42;--shiki-dark:#ABB2BF">)</span><span style="color:#383A42;--shiki-dark:#C678DD">:</span><span style="color:#A626A4;--shiki-dark:#C678DD"> void</span><span style="color:#383A42;--shiki-dark:#ABB2BF">;</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">}</span></span></code></pre>
<p>The comparator is a simple functional interface that accepts two values of the same type and, well, compares them.</p>
<pre class="astro-code astro-code-themes OneLight OneDark" style="background-color:#FAFAFA;--shiki-dark-bg:#282C34;color:#383A42;--shiki-dark:#ABB2BF; overflow-x: auto;" tabindex="0" data-language="php"><code><span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic">/**</span></span>
<span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic"> * @template T</span></span>
<span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic"> */</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">interface</span><span style="color:#C18401;--shiki-dark:#E5C07B"> Comparator</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">{</span></span>
<span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic">    /**</span></span>
<span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic">     * </span><span style="color:#A626A4;font-style:italic;--shiki-dark:#C678DD;--shiki-dark-font-style:italic">@param</span><span style="color:#C18401;font-style:italic;--shiki-dark:#E5C07B;--shiki-dark-font-style:italic"> T</span><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic"> $a</span></span>
<span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic">     * </span><span style="color:#A626A4;font-style:italic;--shiki-dark:#C678DD;--shiki-dark-font-style:italic">@param</span><span style="color:#C18401;font-style:italic;--shiki-dark:#E5C07B;--shiki-dark-font-style:italic"> T</span><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic"> $b</span></span>
<span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic">     */</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">    public</span><span style="color:#A626A4;--shiki-dark:#C678DD"> function</span><span style="color:#4078F2;--shiki-dark:#61AFEF"> compare</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#A626A4;--shiki-dark:#C678DD">mixed</span><span style="color:#E45649;--shiki-dark:#E06C75"> $a</span><span style="color:#383A42;--shiki-dark:#ABB2BF">, </span><span style="color:#A626A4;--shiki-dark:#C678DD">mixed</span><span style="color:#E45649;--shiki-dark:#E06C75"> $b</span><span style="color:#383A42;--shiki-dark:#ABB2BF">)</span><span style="color:#383A42;--shiki-dark:#C678DD">:</span><span style="color:#A626A4;--shiki-dark:#C678DD"> int</span><span style="color:#383A42;--shiki-dark:#ABB2BF">;</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">}</span></span></code></pre>
<p>Now let’s say we have a collection of dogs (in other words, <code>Collection&#x3C;Dog></code>), and a comparator that is able to compare <em>any</em> pair of animals based on their weight:</p>
<pre class="astro-code astro-code-themes OneLight OneDark" style="background-color:#FAFAFA;--shiki-dark-bg:#282C34;color:#383A42;--shiki-dark:#ABB2BF; overflow-x: auto;" tabindex="0" data-language="php"><code><span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic">/**</span></span>
<span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic"> * @implements Comparator&#x3C;Animal></span></span>
<span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic"> */</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">class</span><span style="color:#C18401;--shiki-dark:#E5C07B"> AnimalByWeightComparator</span><span style="color:#A626A4;--shiki-dark:#C678DD"> implements</span><span style="color:#C18401;--shiki-dark:#E5C07B"> Comparator</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">{</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">    public</span><span style="color:#A626A4;--shiki-dark:#C678DD"> function</span><span style="color:#4078F2;--shiki-dark:#61AFEF"> compare</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#E45649;--shiki-dark:#E06C75">$a</span><span style="color:#383A42;--shiki-dark:#ABB2BF">, </span><span style="color:#E45649;--shiki-dark:#E06C75">$b</span><span style="color:#383A42;--shiki-dark:#ABB2BF">)</span><span style="color:#383A42;--shiki-dark:#C678DD">:</span><span style="color:#A626A4;--shiki-dark:#C678DD"> int</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">    {</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">        return</span><span style="color:#E45649;--shiki-dark:#E06C75"> $a</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">weight</span><span style="color:#383A42;--shiki-dark:#ABB2BF">() </span><span style="color:#383A42;--shiki-dark:#C678DD">&#x3C;=></span><span style="color:#E45649;--shiki-dark:#E06C75"> $b</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">weight</span><span style="color:#383A42;--shiki-dark:#ABB2BF">();</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">}</span></span></code></pre>
<p>You’ll be surprised that you cannot use this comparator to sort dogs. PHPStan will adamantly report the following error:</p>
<pre class="astro-code astro-code-themes OneLight OneDark" style="background-color:#FAFAFA;--shiki-dark-bg:#282C34;color:#383A42;--shiki-dark:#ABB2BF; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>Parameter #1 $comparator of method Collection&#x3C;Dog>::sort() expects Comparator&#x3C;Dog>, AnimalByWeightComparator given.</span></span></code></pre>
<p>But why shouldn’t you be able to use this comparator? It compares animals by their weight, and dogs <em>are</em> animals and all dogs <em>weigh</em> something. Logically, there is no reason why this shouldn’t be able to work out.</p>
<p>Type-wise, there is: generics are invariant by default, which means that <code>Comparator&#x3C;Animal></code> and <code>Comparator&#x3C;Dog></code> are two <em>entirely</em> different, distinct types. Which is quite impractical.</p>
<p>What we want is to establish a relationship in which <code>Comparator&#x3C;Animal></code> is a subtype of <code>Comparator&#x3C;Dog></code> – even though it’s the other way around for the inner types (<code>Dog</code> is a subtype of <code>Animal</code>). This kind of reversed relationship is called contravariance, and is now supported by PHPStan. All it takes is a tiny change in the interface:</p>
<pre class="astro-code astro-code-themes OneLight OneDark" style="background-color:#FAFAFA;--shiki-dark-bg:#282C34;color:#383A42;--shiki-dark:#ABB2BF; overflow-x: auto;" tabindex="0" data-language="php"><code><span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic">/**</span></span>
<span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic"> * @template-contravariant T</span></span>
<span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic"> */</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">interface</span><span style="color:#C18401;--shiki-dark:#E5C07B"> Comparator</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">{</span></span>
<span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic">    /**</span></span>
<span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic">     * </span><span style="color:#A626A4;font-style:italic;--shiki-dark:#C678DD;--shiki-dark-font-style:italic">@param</span><span style="color:#C18401;font-style:italic;--shiki-dark:#E5C07B;--shiki-dark-font-style:italic"> T</span><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic"> $a</span></span>
<span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic">     * </span><span style="color:#A626A4;font-style:italic;--shiki-dark:#C678DD;--shiki-dark-font-style:italic">@param</span><span style="color:#C18401;font-style:italic;--shiki-dark:#E5C07B;--shiki-dark-font-style:italic"> T</span><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic"> $b</span></span>
<span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic">     */</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">    public</span><span style="color:#A626A4;--shiki-dark:#C678DD"> function</span><span style="color:#4078F2;--shiki-dark:#61AFEF"> compare</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#A626A4;--shiki-dark:#C678DD">mixed</span><span style="color:#E45649;--shiki-dark:#E06C75"> $a</span><span style="color:#383A42;--shiki-dark:#ABB2BF">, </span><span style="color:#A626A4;--shiki-dark:#C678DD">mixed</span><span style="color:#E45649;--shiki-dark:#E06C75"> $b</span><span style="color:#383A42;--shiki-dark:#ABB2BF">)</span><span style="color:#383A42;--shiki-dark:#C678DD">:</span><span style="color:#A626A4;--shiki-dark:#C678DD"> int</span><span style="color:#383A42;--shiki-dark:#ABB2BF">;</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">}</span></span></code></pre>
<p>Now PHPStan will be absolutely fine with sorting a <code>Collection&#x3C;Dog></code> using the aforementioned <code>AnimalByWeightComparator</code>.</p>
<h2 id="the-cost-of-variance">The cost of variance</h2>
<p>As many nice things, covariant and contravariant template types come with a trade-off. To ensure type safety, PHPStan locates all places where template types are referenced and checks whether they are used in accordance with their declared variance.</p>
<p>In the previous example, We could make the <code>Comparator</code> contravariant in its template type <code>T</code> because it only occurs in it in the position of a parameter (which is inherently contravariant).</p>
<p>This is often more of a limitation for covariant template types:</p>
<pre class="astro-code astro-code-themes OneLight OneDark" style="background-color:#FAFAFA;--shiki-dark-bg:#282C34;color:#383A42;--shiki-dark:#ABB2BF; overflow-x: auto;" tabindex="0" data-language="php"><code><span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic">/**</span></span>
<span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic"> * @template-covariant T of object</span></span>
<span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic"> */</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">interface</span><span style="color:#C18401;--shiki-dark:#E5C07B"> Collection</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">{</span></span>
<span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic">    /** </span><span style="color:#A626A4;font-style:italic;--shiki-dark:#C678DD;--shiki-dark-font-style:italic">@param</span><span style="color:#C18401;font-style:italic;--shiki-dark:#E5C07B;--shiki-dark-font-style:italic"> T</span><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic"> $item */</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">    public</span><span style="color:#A626A4;--shiki-dark:#C678DD"> function</span><span style="color:#4078F2;--shiki-dark:#61AFEF"> add</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#A626A4;--shiki-dark:#C678DD">object</span><span style="color:#E45649;--shiki-dark:#E06C75"> $item</span><span style="color:#383A42;--shiki-dark:#ABB2BF">)</span><span style="color:#383A42;--shiki-dark:#C678DD">:</span><span style="color:#A626A4;--shiki-dark:#C678DD"> void</span><span style="color:#383A42;--shiki-dark:#ABB2BF">;</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">}</span></span></code></pre>
<p>The template type <code>T</code> is declared as covariant, which allows us to treat <code>Collection&#x3C;Dog></code> as a subtype of <code>Collection&#x3C;Animal></code>. However, we know that for the subtype to be type-safe, all method parameters must be contravariant – you can only widen their type in the subtype, not narrow it. This requirement is violated in the code above, and PHPStan reports it.</p>
<p>It gets more complicated with complex types, such as arrays, callables, or generic classes. Consider the <code>Collection</code> interface from above – we could easily make it covariant in its template type:</p>
<pre class="astro-code astro-code-themes OneLight OneDark" style="background-color:#FAFAFA;--shiki-dark-bg:#282C34;color:#383A42;--shiki-dark:#ABB2BF; overflow-x: auto;" tabindex="0" data-language="php"><code><span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic">/**</span></span>
<span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic"> * @template-covariant T</span></span>
<span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic"> */</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">interface</span><span style="color:#C18401;--shiki-dark:#E5C07B"> Collection</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">{</span></span>
<span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic">    /**</span></span>
<span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic">     * </span><span style="color:#A626A4;font-style:italic;--shiki-dark:#C678DD;--shiki-dark-font-style:italic">@param</span><span style="color:#C18401;font-style:italic;--shiki-dark:#E5C07B;--shiki-dark-font-style:italic"> Comparator</span><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic">&#x3C;</span><span style="color:#C18401;font-style:italic;--shiki-dark:#E5C07B;--shiki-dark-font-style:italic">T</span><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic">> $comparator</span></span>
<span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic">     */</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">    public</span><span style="color:#A626A4;--shiki-dark:#C678DD"> function</span><span style="color:#4078F2;--shiki-dark:#61AFEF"> sort</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#C18401;--shiki-dark:#E5C07B">Comparator</span><span style="color:#E45649;--shiki-dark:#E06C75"> $comparator</span><span style="color:#383A42;--shiki-dark:#ABB2BF">)</span><span style="color:#383A42;--shiki-dark:#C678DD">:</span><span style="color:#A626A4;--shiki-dark:#C678DD"> void</span><span style="color:#383A42;--shiki-dark:#ABB2BF">;</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">}</span></span></code></pre>
<p>After what’s been said before, you might be surprised to find out that this code is correct. Even though parameters are contravariant, the template type occurs within a complex type, and thus its positional variance must be composed. In this case, it’s in the parameter of the <code>sort()</code> method, but going further, it’s also in the <em>contravariant</em> type argument of the <code>Comparator</code> interface. That makes it <em>two</em> contravariant positions in a sequence, and contravariance composed with contravariance actually produces covariance.</p>
<p>The rules for variance composition are in fact pretty simple, and <a href="https://yanniss.github.io/variance-pldi11.pdf">grounded in type theory</a> (see section 3.1): ‘invariance transforms everything into invariance, (…), covariance transforming a variance leaves it the same, and contravariance reverses it.‘</p>
<h2 id="fixes-in-variance-composition">Fixes in variance composition</h2>
<p>It turns out that PHPStan hasn’t really observed <em>all</em> these rules, and the latest release amends that:</p>
<pre class="astro-code astro-code-themes OneLight OneDark" style="background-color:#FAFAFA;--shiki-dark-bg:#282C34;color:#383A42;--shiki-dark:#ABB2BF; overflow-x: auto;" tabindex="0" data-language="php"><code><span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic">/**</span></span>
<span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic"> * @template-covariant T</span></span>
<span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic"> */</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">interface</span><span style="color:#C18401;--shiki-dark:#E5C07B"> Collection</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">{</span></span>
<span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic">    /**</span></span>
<span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic">     * </span><span style="color:#A626A4;font-style:italic;--shiki-dark:#C678DD;--shiki-dark-font-style:italic">@return</span><span style="color:#C18401;font-style:italic;--shiki-dark:#E5C07B;--shiki-dark-font-style:italic"> Comparator</span><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic">&#x3C;</span><span style="color:#C18401;font-style:italic;--shiki-dark:#E5C07B;--shiki-dark-font-style:italic">T</span><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic">> </span></span>
<span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic">     */</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">    public</span><span style="color:#A626A4;--shiki-dark:#C678DD"> function</span><span style="color:#4078F2;--shiki-dark:#61AFEF"> getComparator</span><span style="color:#383A42;--shiki-dark:#ABB2BF">()</span><span style="color:#383A42;--shiki-dark:#C678DD">:</span><span style="color:#C18401;--shiki-dark:#E5C07B"> Comparator</span><span style="color:#383A42;--shiki-dark:#ABB2BF">;</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">}</span></span></code></pre>
<p>Like above, the template type is used in the contravariant position of the <code>Comparator</code> interface. But this time the comparator is <em>returned</em> from the method, i.e. it appears in a covariant position. Given the rules above, covariance composed with contravariance should turn into contravariance. It did not, and it was a bug, which is now fixed and the code above reports an error. Ondřej Mirtes, PHPStan’s maintainer, decided that this was safe to release as is in a patch version, because we don’t expect you to run into many new issues due to this.</p>
<p>Unfortunately, the same cannot be said about the <a href="https://github.com/phpstan/phpstan-src/pull/2054">other fix I contributed</a>: invariance did <em>not</em> transform anything into invariance as it was supposed to. In composition, invariance simply returned the other composed variance. PHPStan’s wide range of integration tests quickly discovered use cases where this fix would report new errors, like this (simplified but genuine) example from doctrine/collections:</p>
<pre class="astro-code astro-code-themes OneLight OneDark" style="background-color:#FAFAFA;--shiki-dark-bg:#282C34;color:#383A42;--shiki-dark:#ABB2BF; overflow-x: auto;" tabindex="0" data-language="php"><code><span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic">/**</span></span>
<span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic"> * @template-covariant T</span></span>
<span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic"> */</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">interface</span><span style="color:#C18401;--shiki-dark:#E5C07B"> Collection</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">{</span></span>
<span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic">    /**</span></span>
<span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic">     * </span><span style="color:#A626A4;font-style:italic;--shiki-dark:#C678DD;--shiki-dark-font-style:italic">@param</span><span style="color:#C18401;font-style:italic;--shiki-dark:#E5C07B;--shiki-dark-font-style:italic"> callable</span><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic">(</span><span style="color:#C18401;font-style:italic;--shiki-dark:#E5C07B;--shiki-dark-font-style:italic">T</span><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic">): bool $predicate</span></span>
<span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic">     * </span><span style="color:#A626A4;font-style:italic;--shiki-dark:#C678DD;--shiki-dark-font-style:italic">@return</span><span style="color:#A626A4;font-style:italic;--shiki-dark:#C678DD;--shiki-dark-font-style:italic"> array</span><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic">{0: Collection&#x3C;T>, 1: Collection&#x3C;T>}</span></span>
<span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic">     */</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">    public</span><span style="color:#A626A4;--shiki-dark:#C678DD"> function</span><span style="color:#4078F2;--shiki-dark:#61AFEF"> partition</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#A626A4;--shiki-dark:#C678DD">callable</span><span style="color:#E45649;--shiki-dark:#E06C75"> $predicate</span><span style="color:#383A42;--shiki-dark:#ABB2BF">)</span><span style="color:#383A42;--shiki-dark:#C678DD">:</span><span style="color:#A626A4;--shiki-dark:#C678DD"> array</span><span style="color:#383A42;--shiki-dark:#ABB2BF">;</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">}</span></span></code></pre>
<p>The <code>partition</code> method returns a tuple of collections, with all items split based on the value returned from the <code>$predicate</code>. The problem is that the tuple (array-shape type) is naturally invariant, because while it allows you to fetch data from it (which is a covariant position), it also doesn’t prevent you from writing into it (which is a contravariant position).</p>
<p>Previously, PHPStan was fine with this, because the invariance of the array type was composed with – and overridden by – the covariance of the <code>Collection</code>’s type parameter. This has been remedied and PHPStan is now able to correctly resolve the usage of the template type as invariant, and report it:</p>
<pre class="astro-code astro-code-themes OneLight OneDark" style="background-color:#FAFAFA;--shiki-dark-bg:#282C34;color:#383A42;--shiki-dark:#ABB2BF; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>Template type T is declared as covariant, but occurs in invariant position in return type of method Collection::partition().</span></span></code></pre>
<p>This is indeed a fix for a long-standing bug, and allows PHPStan to pinpoint many scenarios where generic types are currently used in a way that is not perfectly type-safe. However, the remedy requires some careful thought on a case-to-case basis. In this particular example, it would help to introduce an immutable tuple type.</p>
<p>Understandably, PHPStan cannot afford to start reporting such new errors in a patch release because it would probably break builds for a lot of projects. Therefore, this <del>new</del> fixed behaviour is only enabled in the <a href="https://phpstan.org/blog/what-is-bleeding-edge">bleeding edge</a> configuration. You can also enable it individually by turning the respective feature toggle in your PHPStan configuration file:</p>
<pre class="astro-code astro-code-themes OneLight OneDark" style="background-color:#FAFAFA;--shiki-dark-bg:#282C34;color:#383A42;--shiki-dark:#ABB2BF; overflow-x: auto;" tabindex="0" data-language="yaml"><code><span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">parameters</span><span style="color:#383A42;--shiki-dark:#ABB2BF">:</span></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">	featureToggles</span><span style="color:#383A42;--shiki-dark:#ABB2BF">:</span></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">		invarianceComposition</span><span style="color:#383A42;--shiki-dark:#ABB2BF">: </span><span style="color:#986801;--shiki-dark:#D19A66">true</span></span></code></pre>
<h2 id="whats-mine-is-none-of-phpstans-business">What’s mine is none of PHPStan’s business</h2>
<p>There is one more <a href="https://github.com/phpstan/phpstan-src/pull/2064">tiny enhancement</a> in the latest release: I found out PHPStan was sometimes too pedantic in enforcing all the aforementioned rules about template type usages. I came to the realization that it doesn’t really make sense to check generic variance in <em>private</em> methods. Variance is all about subtyping, and private class members do not really come into play in that context.</p>
<p>PHP doesn’t force its variance rules onto private members in standard subtyping, and from now on, neither does PHPStan in generic subtyping. Generic variance rules are only enforced in public and protected methods.</p>
<h2 id="this-doesnt-end-here">This doesn’t end here</h2>
<p>I believe generics are tremendously useful. At the same time, having worked with them in Kotlin, I find generics in PHPStan lacking in some ways, and I’m now slowly working on patching these imperfections. The aforementioned changes introduced in the latest patch release are only the first batch, but more are brewing 🤞 until then, I wish you all the best!</p> </div> <div class="comments" data-astro-cid-relfimn4> <div id="giscus-container"></div> <script type="module">const t=document.createElement("script");t.src="https://giscus.app/client.js";t.crossOrigin="anonymous";t.async=!0;t.setAttribute("data-repo","jiripudil/jiripudil.cz");t.setAttribute("data-repo-id","MDEwOlJlcG9zaXRvcnkyNTI5NzY3Nw==");t.setAttribute("data-category","Blog discussions");t.setAttribute("data-category-id","DIC_kwDOAYIDDc4CAfUM");t.setAttribute("data-mapping","og:title");t.setAttribute("data-reactions-enabled","1");t.setAttribute("data-emit-metadata","0");t.setAttribute("data-theme","preferred_color_scheme");t.setAttribute("data-lang","en");t.setAttribute("data-loading","lazy");const e=document.getElementById("giscus-container");e.appendChild(t);</script> </div> </div>  </div>   <div class="footer" data-astro-cid-sz7xmlte> <div class="container" data-astro-cid-d6puh33w> 
Content licensed under
<a href="https://creativecommons.org/licenses/by/4.0/" title="Creative Commons Attribution 4.0 International" aria-label="Creative Commons Attribution 4.0 International" data-astro-cid-sz7xmlte> <svg width="0.97em" height="1em" data-astro-cid-sz7xmlte="true" data-icon="fa6-brands:creative-commons">   <symbol id="ai:fa6-brands:creative-commons" viewBox="0 0 496 512"><path fill="currentColor" d="m245.83 214.87l-33.22 17.28c-9.43-19.58-25.24-19.93-27.46-19.93c-22.13 0-33.22 14.61-33.22 43.84c0 23.57 9.21 43.84 33.22 43.84c14.47 0 24.65-7.09 30.57-21.26l30.55 15.5c-6.17 11.51-25.69 38.98-65.1 38.98c-22.6 0-73.96-10.32-73.96-77.05c0-58.69 43-77.06 72.63-77.06c30.72-.01 52.7 11.95 65.99 35.86m143.05 0l-32.78 17.28c-9.5-19.77-25.72-19.93-27.9-19.93c-22.14 0-33.22 14.61-33.22 43.84c0 23.55 9.23 43.84 33.22 43.84c14.45 0 24.65-7.09 30.54-21.26l31 15.5c-2.1 3.75-21.39 38.98-65.09 38.98c-22.69 0-73.96-9.87-73.96-77.05c0-58.67 42.97-77.06 72.63-77.06c30.71-.01 52.58 11.95 65.56 35.86M247.56 8.05C104.74 8.05 0 123.11 0 256.05c0 138.49 113.6 248 247.56 248c129.93 0 248.44-100.87 248.44-248c0-137.87-106.62-248-248.44-248m.87 450.81c-112.54 0-203.7-93.04-203.7-202.81c0-105.42 85.43-203.27 203.72-203.27c112.53 0 202.82 89.46 202.82 203.26c-.01 121.69-99.68 202.82-202.84 202.82"/></symbol><use href="#ai:fa6-brands:creative-commons"></use>  </svg> <svg width="0.97em" height="1em" data-astro-cid-sz7xmlte="true" data-icon="fa6-brands:creative-commons-by">   <symbol id="ai:fa6-brands:creative-commons-by" viewBox="0 0 496 512"><path fill="currentColor" d="M314.9 194.4v101.4h-28.3v120.5h-77.1V295.9h-28.3V194.4c0-4.4 1.6-8.2 4.6-11.3c3.1-3.1 6.9-4.7 11.3-4.7H299c4.1 0 7.8 1.6 11.1 4.7c3.1 3.2 4.8 6.9 4.8 11.3m-101.5-63.7c0-23.3 11.5-35 34.5-35s34.5 11.7 34.5 35q0 34.5-34.5 34.5c-34.5 0-34.5-11.5-34.5-34.5M247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8m.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3"/></symbol><use href="#ai:fa6-brands:creative-commons-by"></use>  </svg> </a>  </div>  </div>  </body></html> 