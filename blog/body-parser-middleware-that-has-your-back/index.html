<!DOCTYPE html><html lang="en"> <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><title>Body parser middleware that has your back – Blog – Jiří Pudil</title><style>.body[data-astro-cid-relfimn4]{padding:1.5rem 0}h1[data-astro-cid-relfimn4]{text-wrap:balance}.metadata[data-astro-cid-relfimn4]{display:flex;align-items:start;justify-content:space-between;gap:1rem;margin-bottom:3rem;ul{margin:0;padding:0;list-style:none;display:flex;flex-wrap:wrap;gap:0 .5rem;font-size:.9rem;a{color:var(--body-diminished-color);&:hover{color:var(--body-text-color)}}}time{flex-shrink:0;color:var(--body-diminished-color)}}.perex[data-astro-cid-relfimn4]{font-size:1.15rem}.content[data-astro-cid-relfimn4]{h2{margin-top:3rem}h3{margin-top:2.25rem}p{text-wrap:pretty;hyphens:auto}:is(ul,ol) li{line-height:1.6;margin-bottom:.5rem}blockquote{position:relative;&:before{content:"“";position:absolute;left:-2.25rem;top:0;color:var(--body-accent-color);font-size:4rem}}img{max-width:100%;height:auto}iframe{max-width:100%;aspect-ratio:16 / 9}code{hyphens:none}.astro-code{margin:.5rem 0;padding:.5rem;font-size:.9rem;tab-size:4}}.comments[data-astro-cid-relfimn4]{margin-top:3rem}@media (max-width: 40rem){.metadata[data-astro-cid-relfimn4]{flex-direction:column;align-items:start;justify-content:start}}
</style><link rel="stylesheet" href="/_astro/about.BrkH-_VM.css"><meta name="generator" content="Astro v5.7.8"><meta name="theme-color" content="#fff" media="(prefers-color-scheme: light)"><meta name="theme-color" content="#242428" media="(prefers-color-scheme: dark)"><link rel="sitemap" href="/sitemap-index.xml"><link rel="alternate" type="application/rss+xml" title="Blog – Jiří Pudil" href="/blog/rss.xml"><link rel="alternate" type="application/rss+xml" title="Notes – Jiří Pudil" href="/notes/rss.xml"><link rel="webmention" href="https://webmention.io/jiripudil.cz/webmention"><meta name="google-site-verification" content="7fHBkeNq7LXO24W8IjCc37NT9MX-6RJxD3Co5F-bRQw"><meta property="og:site_name" content="Jiří Pudil"><meta property="og:title" content="Body parser middleware that has your back – Blog"><meta property="og:type" content="article"><meta property="article:published_time" content="2020-01-28T14:00:00.000Z"><meta property="article:tag" content="api"><meta property="article:tag" content="frameworkless"><meta property="article:tag" content="http"><meta property="article:tag" content="middlewares"><meta property="article:tag" content="php"><meta property="article:tag" content="rest"><meta property="article:tag" content="software-architecture"><link rel="manifest" href="/manifest.webmanifest"><meta name="mobile-web-app-capable" content="yes"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#fff"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#000"><meta name="application-name" content="Jiří Pudil"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-precomposed.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#fff"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="apple-mobile-web-app-title" content="Jiří Pudil"><link rel="icon" type="image/x-icon" href="/favicon.ico"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="48x48" href="/favicon-48x48.png"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><meta name="msapplication-TileColor" content="#fff"><meta name="msapplication-TileImage" content="/mstile-144x144.png"><meta name="msapplication-config" content="/browserconfig.xml"><link rel="yandex-tableau-widget" href="/yandex-browser-manifest.json"></head> <body> <div class="header" data-astro-cid-3ef6ksr2> <div class="container" data-astro-cid-d6puh33w>  <nav class="menu" data-astro-cid-3ef6ksr2> <ul data-astro-cid-3ef6ksr2> <li class="name" data-astro-cid-3ef6ksr2> <a href="/" title="Home" data-astro-cid-3ef6ksr2>
Jiří Pudil
</a> </li> <li data-astro-cid-3ef6ksr2> <a href="/about" data-astro-cid-3ef6ksr2>
About
</a> </li> <li data-astro-cid-3ef6ksr2> <a href="/projects" data-astro-cid-3ef6ksr2>
Projects
</a> </li> <li data-astro-cid-3ef6ksr2> <a href="/blog" class="active" data-astro-cid-3ef6ksr2>
Blog
</a> </li> <li data-astro-cid-3ef6ksr2> <a href="/notes" data-astro-cid-3ef6ksr2>
Notes
</a> </li> <li data-astro-cid-3ef6ksr2> <a href="/talks" data-astro-cid-3ef6ksr2>
Talks
</a> </li> </ul> </nav>  </div>  </div>    <div class="container" data-astro-cid-d6puh33w>  <div class="body" data-astro-cid-relfimn4> <h1 data-astro-cid-relfimn4>Body parser middleware that has your back</h1> <div class="metadata" data-astro-cid-relfimn4> <ul data-astro-cid-relfimn4> <li data-astro-cid-relfimn4><a href="/blog/tag/api" data-astro-cid-relfimn4>#api</a></li><li data-astro-cid-relfimn4><a href="/blog/tag/frameworkless" data-astro-cid-relfimn4>#frameworkless</a></li><li data-astro-cid-relfimn4><a href="/blog/tag/http" data-astro-cid-relfimn4>#http</a></li><li data-astro-cid-relfimn4><a href="/blog/tag/middlewares" data-astro-cid-relfimn4>#middlewares</a></li><li data-astro-cid-relfimn4><a href="/blog/tag/php" data-astro-cid-relfimn4>#php</a></li><li data-astro-cid-relfimn4><a href="/blog/tag/rest" data-astro-cid-relfimn4>#rest</a></li><li data-astro-cid-relfimn4><a href="/blog/tag/software-architecture" data-astro-cid-relfimn4>#software-architecture</a></li> </ul> <time datetime="2020-01-28T14:00:00.000Z" data-astro-cid-relfimn4> Jan 28, 2020 </time> </div> <p class="perex" data-astro-cid-relfimn4>If you've ever implemented an HTTP API in PHP, you probably know that there's one thing you have to do over and over and over: parse the request body and validate the resulting structure. Now that we have PSR-15, let's use a middleware for that!</p> <div class="content" data-astro-cid-relfimn4> <p>The easiest solution – and one we surely tried – is to pull the <a href="https://github.com/middlewares/payload#jsonpayload"><code>JsonPayload</code> middleware</a>
via Composer. It’s basically a middleware over <code>json_decode</code>. You just put it in your middleware stack and suddenly,
<code>$request->getParsedBody()</code> gives you an associative array.</p>
<p>Well, that’s nice, but it’s still not enough. There’s one big problem not yet solved here: we have just an array. Yes,
<em>an</em> array. The request handler can, at this point, make no assumptions about its shape; we still have to validate that
nothing is missing, nothing is extra, and everything is of the right type.</p>
<p>But that implies that the request handler has to know the schema of the request body. So if it knows it, why not use
the information in the middleware in the first place? What if we could parse the request body into a known, well-defined,
and type-safe structure, and validate it against a set of constraints while we’re at it? And that’s what we did.</p>
<h2 id="let-there-be-a-class">Let there be a class</h2>
<p>When I’m talking about a known, well-defined, and type-safe structure, I really mean a class. It’s nothing fancy,
just a plain old data transfer object, with public properties and not much more. Let’s take a look at a sample
parsed body class for an authentication request:</p>
<pre class="astro-code astro-code-themes OneLight OneDark" style="background-color:#FAFAFA;--shiki-dark-bg:#282C34;color:#383A42;--shiki-dark:#ABB2BF; overflow-x: auto;" tabindex="0" data-language="php"><code><span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">final</span><span style="color:#A626A4;--shiki-dark:#C678DD"> class</span><span style="color:#C18401;--shiki-dark:#E5C07B"> AuthenticateParsedBody</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">{</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">	public</span><span style="color:#A626A4;--shiki-dark:#C678DD"> string</span><span style="color:#E45649;--shiki-dark:#E06C75"> $email</span><span style="color:#383A42;--shiki-dark:#ABB2BF">;</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">	public</span><span style="color:#A626A4;--shiki-dark:#C678DD"> string</span><span style="color:#E45649;--shiki-dark:#E06C75"> $password</span><span style="color:#383A42;--shiki-dark:#ABB2BF">;</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">}</span></span></code></pre>
<p>That’s all. Really. We have a class representing the parsed body; we now have to deserialize the incoming JSON
and populate an instance of the class. And there already is a nice little tool that does this: Symfony’s
<a href="https://symfony.com/components/Serializer">Serializer</a> component. We configure it this way:</p>
<pre class="astro-code astro-code-themes OneLight OneDark" style="background-color:#FAFAFA;--shiki-dark-bg:#282C34;color:#383A42;--shiki-dark:#ABB2BF; overflow-x: auto;" tabindex="0" data-language="php"><code><span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">use</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> Symfony\Component\Serializer\Encoder\</span><span style="color:#C18401;--shiki-dark:#E5C07B">JsonEncoder</span><span style="color:#383A42;--shiki-dark:#ABB2BF">;</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">use</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> Symfony\Component\Serializer\Normalizer\</span><span style="color:#C18401;--shiki-dark:#E5C07B">PropertyNormalizer</span><span style="color:#383A42;--shiki-dark:#ABB2BF">;</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">use</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> Symfony\Component\Serializer\</span><span style="color:#C18401;--shiki-dark:#E5C07B">Serializer</span><span style="color:#383A42;--shiki-dark:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">$serializer</span><span style="color:#383A42;--shiki-dark:#C678DD"> =</span><span style="color:#A626A4;--shiki-dark:#C678DD"> new</span><span style="color:#C18401;--shiki-dark:#E5C07B"> Serializer</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">	[</span><span style="color:#A626A4;--shiki-dark:#C678DD">new</span><span style="color:#C18401;--shiki-dark:#E5C07B"> PropertyNormalizer</span><span style="color:#383A42;--shiki-dark:#ABB2BF">()],</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">	[</span><span style="color:#A626A4;--shiki-dark:#C678DD">new</span><span style="color:#C18401;--shiki-dark:#E5C07B"> JsonEncoder</span><span style="color:#383A42;--shiki-dark:#ABB2BF">()]</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">);</span></span></code></pre>
<p>The encoder part says which formats we want to work with – in our case it’s JSON – while the normalizer part defines
how objects are populated from the decoded data and vice versa. <code>PropertyNormalizer</code> works with object properties,
which is all we need at the moment. For more complex structures, you’ll want to configure <code>ObjectNormalizer</code>, very
likely along with <code>ArrayDenormalizer</code>.</p>
<p>The middleware then uses this configured Serializer instance to deserialize incoming request body into an object
of the desired type, and responds to whatever goes wrong in either decoding or normalization:</p>
<pre class="astro-code astro-code-themes OneLight OneDark" style="background-color:#FAFAFA;--shiki-dark-bg:#282C34;color:#383A42;--shiki-dark:#ABB2BF; overflow-x: auto;" tabindex="0" data-language="php"><code><span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">use</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> Symfony\Component\Serializer\Exception\</span><span style="color:#C18401;--shiki-dark:#E5C07B">NotEncodableValueException</span><span style="color:#383A42;--shiki-dark:#ABB2BF">;</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">use</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> Symfony\Component\Serializer\Exception\</span><span style="color:#C18401;--shiki-dark:#E5C07B">NotNormalizableValueException</span><span style="color:#383A42;--shiki-dark:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">try</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">	$parsedBody</span><span style="color:#383A42;--shiki-dark:#C678DD"> =</span><span style="color:#E45649;--shiki-dark:#E06C75"> $serializer</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">deserialize</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">		(</span><span style="color:#A626A4;--shiki-dark:#C678DD">string</span><span style="color:#383A42;--shiki-dark:#ABB2BF">) </span><span style="color:#E45649;--shiki-dark:#E06C75">$request</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">getBody</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(),</span></span>
<span class="line"><span style="color:#C18401;--shiki-dark:#E5C07B">		AuthenticateParsedBody</span><span style="color:#383A42;--shiki-dark:#C678DD">::</span><span style="color:#A626A4;--shiki-dark:#C678DD">class</span><span style="color:#383A42;--shiki-dark:#ABB2BF">,</span></span>
<span class="line"><span style="color:#C18401;--shiki-dark:#E5C07B">		JsonEncoder</span><span style="color:#383A42;--shiki-dark:#C678DD">::</span><span style="color:#986801;--shiki-dark:#D19A66">FORMAT</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">	);</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">} </span><span style="color:#A626A4;--shiki-dark:#C678DD">catch</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> (</span><span style="color:#C18401;--shiki-dark:#E5C07B">NotEncodableValueException</span><span style="color:#E45649;--shiki-dark:#E06C75"> $e</span><span style="color:#383A42;--shiki-dark:#ABB2BF">) {</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">	return</span><span style="color:#E45649;--shiki-dark:#E06C75"> $responseFactory</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">createResponse</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#986801;--shiki-dark:#D19A66">400</span><span style="color:#383A42;--shiki-dark:#ABB2BF">);</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">} </span><span style="color:#A626A4;--shiki-dark:#C678DD">catch</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> (</span><span style="color:#C18401;--shiki-dark:#E5C07B">NotNormalizableValueException</span><span style="color:#E45649;--shiki-dark:#E06C75"> $e</span><span style="color:#383A42;--shiki-dark:#ABB2BF">) {</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">	return</span><span style="color:#E45649;--shiki-dark:#E06C75"> $responseFactory</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">createResponse</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#986801;--shiki-dark:#D19A66">422</span><span style="color:#383A42;--shiki-dark:#ABB2BF">);</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">}</span></span></code></pre>
<p>If everything works, the <code>$parsedBody</code> variable now holds an instance of <code>AuthenticateParsedBody</code>, populated with data
from the request body. If the body contains malformed JSON, we use a PSR-18 response factory to generate and return
a <code>400 Bad Request</code> response, and if it is syntactically valid but cannot be mapped onto the given class, we return
a <code>422 Unprocessable Entity</code> response. (Note that this is not a complete implementation; you might, for example, want
to include a more detailed explanation of what’s wrong, or perhaps log the exception.)</p>
<h2 id="the-data-might-still-not-be-correct">The data might still not be correct</h2>
<p>We have an instance of <code>AuthenticateParsedBody</code>, but that’s still not the final station. All it guarantees is that
both <code>$email</code> and <code>$password</code> are strings. Nowhere does it ensure that <code>$email</code> is a valid email address, nor that
either of the values is not empty.</p>
<p>Luckily, Symfony has another component for this: <a href="https://symfony.com/components/Validator">Validator</a>. Let’s start
by adding some constraints to the parsed body class:</p>
<pre class="astro-code astro-code-themes OneLight OneDark" style="background-color:#FAFAFA;--shiki-dark-bg:#282C34;color:#383A42;--shiki-dark:#ABB2BF; overflow-x: auto;" tabindex="0" data-language="php"><code><span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">use</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> Symfony\Component\Validator\</span><span style="color:#C18401;--shiki-dark:#E5C07B">Constraints</span><span style="color:#A626A4;--shiki-dark:#C678DD"> as</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> Assert;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">final</span><span style="color:#A626A4;--shiki-dark:#C678DD"> class</span><span style="color:#C18401;--shiki-dark:#E5C07B"> AuthenticateParsedBody</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">{</span></span>
<span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic">	/**</span></span>
<span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic">	 * @Assert\NotBlank()</span></span>
<span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic">	 * @Assert\Email()</span></span>
<span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic">	 */</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">	public</span><span style="color:#A626A4;--shiki-dark:#C678DD"> string</span><span style="color:#E45649;--shiki-dark:#E06C75"> $email</span><span style="color:#383A42;--shiki-dark:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic">	/**</span></span>
<span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic">	 * @Assert\NotBlank()</span></span>
<span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic">	 */</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">	public</span><span style="color:#A626A4;--shiki-dark:#C678DD"> string</span><span style="color:#E45649;--shiki-dark:#E06C75"> $password</span><span style="color:#383A42;--shiki-dark:#ABB2BF">;</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">}</span></span></code></pre>
<p>With these annotations we’ve declared that both properties must contain non-empty values, and that <code>$email</code> has to
be a valid email address. Now we can set up the validator and validate our <code>$parsedBody</code>:</p>
<pre class="astro-code astro-code-themes OneLight OneDark" style="background-color:#FAFAFA;--shiki-dark-bg:#282C34;color:#383A42;--shiki-dark:#ABB2BF; overflow-x: auto;" tabindex="0" data-language="php"><code><span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">use</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> Symfony\Component\Validator\</span><span style="color:#C18401;--shiki-dark:#E5C07B">ValidatorBuilder</span><span style="color:#383A42;--shiki-dark:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">$validator</span><span style="color:#383A42;--shiki-dark:#C678DD"> =</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> (</span><span style="color:#A626A4;--shiki-dark:#C678DD">new</span><span style="color:#C18401;--shiki-dark:#E5C07B"> ValidatorBuilder</span><span style="color:#383A42;--shiki-dark:#ABB2BF">())</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#C678DD">	-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">enableAnnotationMapping</span><span style="color:#383A42;--shiki-dark:#ABB2BF">()</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#C678DD">	-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">getValidator</span><span style="color:#383A42;--shiki-dark:#ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">$violations</span><span style="color:#383A42;--shiki-dark:#C678DD"> =</span><span style="color:#E45649;--shiki-dark:#E06C75"> $validator</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">validate</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#E45649;--shiki-dark:#E06C75">$parsedBody</span><span style="color:#383A42;--shiki-dark:#ABB2BF">);</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">if</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> (</span><span style="color:#E45649;--shiki-dark:#E06C75">$violations</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">count</span><span style="color:#383A42;--shiki-dark:#ABB2BF">() </span><span style="color:#383A42;--shiki-dark:#C678DD">></span><span style="color:#986801;--shiki-dark:#D19A66"> 0</span><span style="color:#383A42;--shiki-dark:#ABB2BF">) {</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">	return</span><span style="color:#E45649;--shiki-dark:#E06C75"> $responseFactory</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">createResponse</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#986801;--shiki-dark:#D19A66">422</span><span style="color:#383A42;--shiki-dark:#ABB2BF">);</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">}</span></span></code></pre>
<p>This is the simplest setup. The <code>$violations</code> variable contains a list of constraint violations, and – again, I’ve
skipped it for the sake of simplicity – we can include it in the response body to give the client a hint about what’s
wrong.</p>
<p>After this last step, we know that the request body is syntactically fine (well-formed JSON), semantically correct
(all required fields are present and have the right types), and valid from the domain perspective (email is an email
address), and we represent it as a type-safe object. Let’s just pass it along with the request:</p>
<pre class="astro-code astro-code-themes OneLight OneDark" style="background-color:#FAFAFA;--shiki-dark-bg:#282C34;color:#383A42;--shiki-dark:#ABB2BF; overflow-x: auto;" tabindex="0" data-language="php"><code><span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">return</span><span style="color:#E45649;--shiki-dark:#E06C75"> $handler</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">handle</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">	$request</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">withParsedBody</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#E45649;--shiki-dark:#E06C75">$parsedBody</span><span style="color:#383A42;--shiki-dark:#ABB2BF">)</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">);</span></span></code></pre>
<p>And in the authentication request handler, we can fetch it from the request and assume it is valid through and through.
And since it is a properly typed object, with a little hint even our IDE and static analysis tools like PHPStan know
everything about its properties and their types:</p>
<pre class="astro-code astro-code-themes OneLight OneDark" style="background-color:#FAFAFA;--shiki-dark-bg:#282C34;color:#383A42;--shiki-dark:#ABB2BF; overflow-x: auto;" tabindex="0" data-language="php"><code><span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">$parsedBody</span><span style="color:#383A42;--shiki-dark:#C678DD"> =</span><span style="color:#E45649;--shiki-dark:#E06C75"> $request</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">getParsedBody</span><span style="color:#383A42;--shiki-dark:#ABB2BF">();</span></span>
<span class="line"><span style="color:#0184BC;--shiki-dark:#56B6C2">assert</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#E45649;--shiki-dark:#E06C75">$parsedBody</span><span style="color:#383A42;--shiki-dark:#C678DD"> instanceof</span><span style="color:#C18401;--shiki-dark:#E5C07B"> AuthenticateParsedBody</span><span style="color:#383A42;--shiki-dark:#ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">$identity</span><span style="color:#383A42;--shiki-dark:#C678DD"> =</span><span style="color:#E45649;--shiki-dark:#E06C75"> $authenticator</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">authenticate</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">	$parsedBody</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#E45649;--shiki-dark:#E06C75">email</span><span style="color:#383A42;--shiki-dark:#ABB2BF">,</span></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">	$parsedBody</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#E45649;--shiki-dark:#E06C75">password</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">);</span></span>
<span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic">// ...</span></span></code></pre>
<h2 id="tying-it-all-together">Tying it all together</h2>
<p>If you’ve read carefully, you’ve noticed that I’ve been omitting one very important detail the whole time: I’ve
hardcoded <code>AuthenticateParsedBody</code> in the middleware. But we don’t only have one endpoint, and we want the middleware
to be reusable! Let’s fix it.</p>
<p>In our solution, we rely upon the routing middleware: we know that it populates the request’s <code>request-handler</code> attribute
with the resolved request handler – its class name, in our case, to be precise. That’s something to work with, we just
need a way to tell if a given request handler requires body parsing, and what class of the parsed body it expects.
We’re using a simple interface:</p>
<pre class="astro-code astro-code-themes OneLight OneDark" style="background-color:#FAFAFA;--shiki-dark-bg:#282C34;color:#383A42;--shiki-dark:#ABB2BF; overflow-x: auto;" tabindex="0" data-language="php"><code><span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">use</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> Psr\Http\Server\</span><span style="color:#C18401;--shiki-dark:#E5C07B">RequestHandlerInterface</span><span style="color:#383A42;--shiki-dark:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">interface</span><span style="color:#C18401;--shiki-dark:#E5C07B"> ParsedBodyRequestHandler</span><span style="color:#A626A4;--shiki-dark:#C678DD"> extends</span><span style="color:#C18401;--shiki-dark:#E5C07B"> RequestHandlerInterface</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">{</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">	public</span><span style="color:#A626A4;--shiki-dark:#C678DD"> static</span><span style="color:#A626A4;--shiki-dark:#C678DD"> function</span><span style="color:#4078F2;--shiki-dark:#61AFEF"> getParsedBodyClassName</span><span style="color:#383A42;--shiki-dark:#ABB2BF">()</span><span style="color:#383A42;--shiki-dark:#C678DD">:</span><span style="color:#A626A4;--shiki-dark:#C678DD"> string</span><span style="color:#383A42;--shiki-dark:#ABB2BF">;</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">}</span></span></code></pre>
<p>So, as the first thing in the middleware, we fetch the <code>request-handler</code> attribute’s value, check if it implements
our little interface, and ask it for the parsed body class name. If it doesn’t implement this interface, we delegate
to the next handler right away:</p>
<pre class="astro-code astro-code-themes OneLight OneDark" style="background-color:#FAFAFA;--shiki-dark-bg:#282C34;color:#383A42;--shiki-dark:#ABB2BF; overflow-x: auto;" tabindex="0" data-language="php"><code><span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">$requestHandlerClassName</span><span style="color:#383A42;--shiki-dark:#C678DD"> =</span><span style="color:#E45649;--shiki-dark:#E06C75"> $request</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">getAttribute</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#50A14F;--shiki-dark:#98C379">'request-handler'</span><span style="color:#383A42;--shiki-dark:#ABB2BF">);</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">if</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> ( </span><span style="color:#383A42;--shiki-dark:#C678DD">!</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> \</span><span style="color:#0184BC;--shiki-dark:#56B6C2">in_array</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#C18401;--shiki-dark:#E5C07B">ParsedBodyRequestHandler</span><span style="color:#383A42;--shiki-dark:#C678DD">::</span><span style="color:#A626A4;--shiki-dark:#C678DD">class</span><span style="color:#383A42;--shiki-dark:#ABB2BF">, \</span><span style="color:#0184BC;--shiki-dark:#56B6C2">class_implements</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#E45649;--shiki-dark:#E06C75">$requestHandlerClassName</span><span style="color:#383A42;--shiki-dark:#ABB2BF">), </span><span style="color:#986801;--shiki-dark:#D19A66">true</span><span style="color:#383A42;--shiki-dark:#ABB2BF">)) {</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">	return</span><span style="color:#E45649;--shiki-dark:#E06C75"> $handler</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">handle</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#E45649;--shiki-dark:#E06C75">$request</span><span style="color:#383A42;--shiki-dark:#ABB2BF">);</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">$parsedBodyClassName</span><span style="color:#383A42;--shiki-dark:#C678DD"> =</span><span style="color:#E45649;--shiki-dark:#E06C75"> $requestHandlerClassName</span><span style="color:#383A42;--shiki-dark:#C678DD">::</span><span style="color:#4078F2;--shiki-dark:#61AFEF">getParsedBodyClassName</span><span style="color:#383A42;--shiki-dark:#ABB2BF">();</span></span></code></pre>
<p>The approach we’ve taken implies that the middlewares are not perfectly isolated; they have to be somewhat aware about
some of the other middlewares in the stack, and about the order in which they are executed. But that’s how it is.
Routing wouldn’t work without it, for example: the routing middleware only marks the resolved request handler in a request
attribute (a mechanism we make use of), and <a href="https://github.com/middlewares/request-handler">another middleware</a> actually
looks it up in the DI container and executes it. So I guess some level of coupling between the middlewares is acceptable
and, most importantly, unavoidable.</p>
<h2 id="the-whole-thing">The whole thing</h2>
<p>For the sake of completeness, here goes the whole code (sans infrastructure setup – serializer and validator are configured
in and provided by the DI container):</p>
<pre class="astro-code astro-code-themes OneLight OneDark" style="background-color:#FAFAFA;--shiki-dark-bg:#282C34;color:#383A42;--shiki-dark:#ABB2BF; overflow-x: auto;" tabindex="0" data-language="php"><code><span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">use</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> Psr\Http\Message\</span><span style="color:#C18401;--shiki-dark:#E5C07B">ResponseFactoryInterface</span><span style="color:#383A42;--shiki-dark:#ABB2BF">;</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">use</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> Psr\Http\Message\</span><span style="color:#C18401;--shiki-dark:#E5C07B">ResponseInterface</span><span style="color:#383A42;--shiki-dark:#ABB2BF">;</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">use</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> Psr\Http\Message\</span><span style="color:#C18401;--shiki-dark:#E5C07B">ServerRequestInterface</span><span style="color:#383A42;--shiki-dark:#ABB2BF">;</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">use</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> Psr\Http\Server\</span><span style="color:#C18401;--shiki-dark:#E5C07B">MiddlewareInterface</span><span style="color:#383A42;--shiki-dark:#ABB2BF">;</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">use</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> Psr\Http\Server\</span><span style="color:#C18401;--shiki-dark:#E5C07B">RequestHandlerInterface</span><span style="color:#383A42;--shiki-dark:#ABB2BF">;</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">use</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> Symfony\Component\Serializer\Encoder\</span><span style="color:#C18401;--shiki-dark:#E5C07B">JsonEncoder</span><span style="color:#383A42;--shiki-dark:#ABB2BF">;</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">use</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> Symfony\Component\Serializer\Exception\</span><span style="color:#C18401;--shiki-dark:#E5C07B">NotEncodableValueException</span><span style="color:#383A42;--shiki-dark:#ABB2BF">;</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">use</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> Symfony\Component\Serializer\Exception\</span><span style="color:#C18401;--shiki-dark:#E5C07B">NotNormalizableValueException</span><span style="color:#383A42;--shiki-dark:#ABB2BF">;</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">use</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> Symfony\Component\Serializer\</span><span style="color:#C18401;--shiki-dark:#E5C07B">SerializerInterface</span><span style="color:#383A42;--shiki-dark:#ABB2BF">;</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">use</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> Symfony\Component\Validator\Validator\</span><span style="color:#C18401;--shiki-dark:#E5C07B">ValidatorInterface</span><span style="color:#383A42;--shiki-dark:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">final</span><span style="color:#A626A4;--shiki-dark:#C678DD"> class</span><span style="color:#C18401;--shiki-dark:#E5C07B"> BodyParserMiddleware</span><span style="color:#A626A4;--shiki-dark:#C678DD"> implements</span><span style="color:#C18401;--shiki-dark:#E5C07B"> MiddlewareInterface</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">{</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">	private</span><span style="color:#C18401;--shiki-dark:#E5C07B"> SerializerInterface</span><span style="color:#E45649;--shiki-dark:#E06C75"> $serializer</span><span style="color:#383A42;--shiki-dark:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">	private</span><span style="color:#C18401;--shiki-dark:#E5C07B"> ValidatorInterface</span><span style="color:#E45649;--shiki-dark:#E06C75"> $validator</span><span style="color:#383A42;--shiki-dark:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">	private</span><span style="color:#C18401;--shiki-dark:#E5C07B"> ResponseFactoryInterface</span><span style="color:#E45649;--shiki-dark:#E06C75"> $responseFactory</span><span style="color:#383A42;--shiki-dark:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">	public</span><span style="color:#A626A4;--shiki-dark:#C678DD"> function</span><span style="color:#0184BC;--shiki-dark:#56B6C2"> __construct</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span></span>
<span class="line"><span style="color:#C18401;--shiki-dark:#E5C07B">		SerializerInterface</span><span style="color:#E45649;--shiki-dark:#E06C75"> $serializer</span><span style="color:#383A42;--shiki-dark:#ABB2BF">,</span></span>
<span class="line"><span style="color:#C18401;--shiki-dark:#E5C07B">		ValidatorInterface</span><span style="color:#E45649;--shiki-dark:#E06C75"> $validator</span><span style="color:#383A42;--shiki-dark:#ABB2BF">,</span></span>
<span class="line"><span style="color:#C18401;--shiki-dark:#E5C07B">		ResponseFactoryInterface</span><span style="color:#E45649;--shiki-dark:#E06C75"> $responseFactory</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">	) {</span></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">		$this</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#E45649;--shiki-dark:#E06C75">serializer</span><span style="color:#383A42;--shiki-dark:#C678DD"> =</span><span style="color:#E45649;--shiki-dark:#E06C75"> $serializer</span><span style="color:#383A42;--shiki-dark:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">		$this</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#E45649;--shiki-dark:#E06C75">validator</span><span style="color:#383A42;--shiki-dark:#C678DD"> =</span><span style="color:#E45649;--shiki-dark:#E06C75"> $validator</span><span style="color:#383A42;--shiki-dark:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">		$this</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#E45649;--shiki-dark:#E06C75">responseFactory</span><span style="color:#383A42;--shiki-dark:#C678DD"> =</span><span style="color:#E45649;--shiki-dark:#E06C75"> $responseFactory</span><span style="color:#383A42;--shiki-dark:#ABB2BF">;</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">	public</span><span style="color:#A626A4;--shiki-dark:#C678DD"> function</span><span style="color:#4078F2;--shiki-dark:#61AFEF"> process</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#C18401;--shiki-dark:#E5C07B">ServerRequestInterface</span><span style="color:#E45649;--shiki-dark:#E06C75"> $request</span><span style="color:#383A42;--shiki-dark:#ABB2BF">, </span><span style="color:#C18401;--shiki-dark:#E5C07B">RequestHandlerInterface</span><span style="color:#E45649;--shiki-dark:#E06C75"> $handler</span><span style="color:#383A42;--shiki-dark:#ABB2BF">)</span><span style="color:#383A42;--shiki-dark:#C678DD">:</span><span style="color:#C18401;--shiki-dark:#E5C07B"> ResponseInterface</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">	{</span></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">		$requestHandlerClassName</span><span style="color:#383A42;--shiki-dark:#C678DD"> =</span><span style="color:#E45649;--shiki-dark:#E06C75"> $request</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">getAttribute</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#50A14F;--shiki-dark:#98C379">'request-handler'</span><span style="color:#383A42;--shiki-dark:#ABB2BF">);</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">		if</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> ( </span><span style="color:#383A42;--shiki-dark:#C678DD">!</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> \</span><span style="color:#0184BC;--shiki-dark:#56B6C2">in_array</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#C18401;--shiki-dark:#E5C07B">ParsedBodyRequestHandler</span><span style="color:#383A42;--shiki-dark:#C678DD">::</span><span style="color:#A626A4;--shiki-dark:#C678DD">class</span><span style="color:#383A42;--shiki-dark:#ABB2BF">, \</span><span style="color:#0184BC;--shiki-dark:#56B6C2">class_implements</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#E45649;--shiki-dark:#E06C75">$requestHandlerClassName</span><span style="color:#383A42;--shiki-dark:#ABB2BF">), </span><span style="color:#986801;--shiki-dark:#D19A66">true</span><span style="color:#383A42;--shiki-dark:#ABB2BF">)) {</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">			return</span><span style="color:#E45649;--shiki-dark:#E06C75"> $handler</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">handle</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#E45649;--shiki-dark:#E06C75">$request</span><span style="color:#383A42;--shiki-dark:#ABB2BF">);</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">		}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">		$parsedBodyClassName</span><span style="color:#383A42;--shiki-dark:#C678DD"> =</span><span style="color:#E45649;--shiki-dark:#E06C75"> $requestHandlerClassName</span><span style="color:#383A42;--shiki-dark:#C678DD">::</span><span style="color:#4078F2;--shiki-dark:#61AFEF">getParsedBodyClassName</span><span style="color:#383A42;--shiki-dark:#ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">		try</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">			$parsedBody</span><span style="color:#383A42;--shiki-dark:#C678DD"> =</span><span style="color:#E45649;--shiki-dark:#E06C75"> $this</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#E45649;--shiki-dark:#E06C75">serializer</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">deserialize</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">				(</span><span style="color:#A626A4;--shiki-dark:#C678DD">string</span><span style="color:#383A42;--shiki-dark:#ABB2BF">) </span><span style="color:#E45649;--shiki-dark:#E06C75">$request</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">getBody</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(),</span></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">				$parsedBodyClassName</span><span style="color:#383A42;--shiki-dark:#ABB2BF">,</span></span>
<span class="line"><span style="color:#C18401;--shiki-dark:#E5C07B">				JsonEncoder</span><span style="color:#383A42;--shiki-dark:#C678DD">::</span><span style="color:#986801;--shiki-dark:#D19A66">FORMAT</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">			);</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">		} </span><span style="color:#A626A4;--shiki-dark:#C678DD">catch</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> (</span><span style="color:#C18401;--shiki-dark:#E5C07B">NotEncodableValueException</span><span style="color:#E45649;--shiki-dark:#E06C75"> $e</span><span style="color:#383A42;--shiki-dark:#ABB2BF">) {</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">			return</span><span style="color:#E45649;--shiki-dark:#E06C75"> $this</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#E45649;--shiki-dark:#E06C75">responseFactory</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">createResponse</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#986801;--shiki-dark:#D19A66">400</span><span style="color:#383A42;--shiki-dark:#ABB2BF">);</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">		} </span><span style="color:#A626A4;--shiki-dark:#C678DD">catch</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> (</span><span style="color:#C18401;--shiki-dark:#E5C07B">NotNormalizableValueException</span><span style="color:#E45649;--shiki-dark:#E06C75"> $e</span><span style="color:#383A42;--shiki-dark:#ABB2BF">) {</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">			return</span><span style="color:#E45649;--shiki-dark:#E06C75"> $this</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#E45649;--shiki-dark:#E06C75">responseFactory</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">createResponse</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#986801;--shiki-dark:#D19A66">422</span><span style="color:#383A42;--shiki-dark:#ABB2BF">);</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">		}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">		$violations</span><span style="color:#383A42;--shiki-dark:#C678DD"> =</span><span style="color:#E45649;--shiki-dark:#E06C75"> $this</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#E45649;--shiki-dark:#E06C75">validator</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">validate</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#E45649;--shiki-dark:#E06C75">$parsedBody</span><span style="color:#383A42;--shiki-dark:#ABB2BF">);</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">		if</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> (</span><span style="color:#E45649;--shiki-dark:#E06C75">$violations</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">count</span><span style="color:#383A42;--shiki-dark:#ABB2BF">() </span><span style="color:#383A42;--shiki-dark:#C678DD">></span><span style="color:#986801;--shiki-dark:#D19A66"> 0</span><span style="color:#383A42;--shiki-dark:#ABB2BF">) {</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">			return</span><span style="color:#E45649;--shiki-dark:#E06C75"> $this</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#E45649;--shiki-dark:#E06C75">responseFactory</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">createResponse</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#986801;--shiki-dark:#D19A66">422</span><span style="color:#383A42;--shiki-dark:#ABB2BF">);</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">		}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">		return</span><span style="color:#E45649;--shiki-dark:#E06C75"> $handler</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">handle</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">			$request</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">withParsedBody</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#E45649;--shiki-dark:#E06C75">$parsedBody</span><span style="color:#383A42;--shiki-dark:#ABB2BF">)</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">		);</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">	}</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">}</span></span></code></pre>
<h2 id="happily-ever-after">Happily ever after</h2>
<p>With all this set up, any request handler that needs to parse the request body is accompanied by a class that describes
its schema and validation constraints, and further represents the request body. The handler itself does not have to worry
about the parsing nor validation any more, and can focus on its actual job instead. If you ask me, that’s a very nice
separation of responsibilities.</p>
<p>What do you think about it? Can you see any weak points in this solution? Do you use anything like that? I’m looking
forward to your comments!</p> </div> <div class="comments" data-astro-cid-relfimn4> <div id="giscus-container"></div> <script type="module">const t=document.createElement("script");t.src="https://giscus.app/client.js";t.crossOrigin="anonymous";t.async=!0;t.setAttribute("data-repo","jiripudil/jiripudil.cz");t.setAttribute("data-repo-id","MDEwOlJlcG9zaXRvcnkyNTI5NzY3Nw==");t.setAttribute("data-category","Blog discussions");t.setAttribute("data-category-id","DIC_kwDOAYIDDc4CAfUM");t.setAttribute("data-mapping","og:title");t.setAttribute("data-reactions-enabled","1");t.setAttribute("data-emit-metadata","0");t.setAttribute("data-theme","preferred_color_scheme");t.setAttribute("data-lang","en");t.setAttribute("data-loading","lazy");const e=document.getElementById("giscus-container");e.appendChild(t);</script> </div> </div>  </div>   <div class="footer" data-astro-cid-sz7xmlte> <div class="container" data-astro-cid-d6puh33w> 
Content licensed under
<a href="https://creativecommons.org/licenses/by/4.0/" title="Creative Commons Attribution 4.0 International" aria-label="Creative Commons Attribution 4.0 International" data-astro-cid-sz7xmlte> <svg width="0.97em" height="1em" data-astro-cid-sz7xmlte="true" data-icon="fa6-brands:creative-commons">   <symbol id="ai:fa6-brands:creative-commons" viewBox="0 0 496 512"><path fill="currentColor" d="m245.83 214.87l-33.22 17.28c-9.43-19.58-25.24-19.93-27.46-19.93c-22.13 0-33.22 14.61-33.22 43.84c0 23.57 9.21 43.84 33.22 43.84c14.47 0 24.65-7.09 30.57-21.26l30.55 15.5c-6.17 11.51-25.69 38.98-65.1 38.98c-22.6 0-73.96-10.32-73.96-77.05c0-58.69 43-77.06 72.63-77.06c30.72-.01 52.7 11.95 65.99 35.86m143.05 0l-32.78 17.28c-9.5-19.77-25.72-19.93-27.9-19.93c-22.14 0-33.22 14.61-33.22 43.84c0 23.55 9.23 43.84 33.22 43.84c14.45 0 24.65-7.09 30.54-21.26l31 15.5c-2.1 3.75-21.39 38.98-65.09 38.98c-22.69 0-73.96-9.87-73.96-77.05c0-58.67 42.97-77.06 72.63-77.06c30.71-.01 52.58 11.95 65.56 35.86M247.56 8.05C104.74 8.05 0 123.11 0 256.05c0 138.49 113.6 248 247.56 248c129.93 0 248.44-100.87 248.44-248c0-137.87-106.62-248-248.44-248m.87 450.81c-112.54 0-203.7-93.04-203.7-202.81c0-105.42 85.43-203.27 203.72-203.27c112.53 0 202.82 89.46 202.82 203.26c-.01 121.69-99.68 202.82-202.84 202.82"/></symbol><use href="#ai:fa6-brands:creative-commons"></use>  </svg> <svg width="0.97em" height="1em" data-astro-cid-sz7xmlte="true" data-icon="fa6-brands:creative-commons-by">   <symbol id="ai:fa6-brands:creative-commons-by" viewBox="0 0 496 512"><path fill="currentColor" d="M314.9 194.4v101.4h-28.3v120.5h-77.1V295.9h-28.3V194.4c0-4.4 1.6-8.2 4.6-11.3c3.1-3.1 6.9-4.7 11.3-4.7H299c4.1 0 7.8 1.6 11.1 4.7c3.1 3.2 4.8 6.9 4.8 11.3m-101.5-63.7c0-23.3 11.5-35 34.5-35s34.5 11.7 34.5 35q0 34.5-34.5 34.5c-34.5 0-34.5-11.5-34.5-34.5M247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8m.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3"/></symbol><use href="#ai:fa6-brands:creative-commons-by"></use>  </svg> </a>  </div>  </div>  </body></html> 