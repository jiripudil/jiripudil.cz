<!DOCTYPE html><html lang="en"> <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><title>Bootstrap your integration testing database – Blog – Jiří Pudil</title><style>.body[data-astro-cid-relfimn4]{padding:1.5rem 0}h1[data-astro-cid-relfimn4]{text-wrap:balance}.metadata[data-astro-cid-relfimn4]{display:flex;align-items:start;justify-content:space-between;gap:1rem;margin-bottom:3rem;ul{margin:0;padding:0;list-style:none;display:flex;flex-wrap:wrap;gap:0 .5rem;font-size:.9rem;a{color:var(--body-diminished-color);&:hover{color:var(--body-text-color)}}}time{flex-shrink:0;color:var(--body-diminished-color)}}.perex[data-astro-cid-relfimn4]{font-size:1.15rem}.content[data-astro-cid-relfimn4]{h2{margin-top:3rem}h3{margin-top:2.25rem}p{text-wrap:pretty;hyphens:auto}:is(ul,ol) li{line-height:1.6;margin-bottom:.5rem}blockquote{position:relative;&:before{content:"“";position:absolute;left:-2.25rem;top:0;color:var(--body-accent-color);font-size:4rem}}img{max-width:100%;height:auto}iframe{max-width:100%;aspect-ratio:16 / 9}code{hyphens:none}.astro-code{margin:.5rem 0;padding:.5rem;font-size:.9rem;tab-size:4}}.comments[data-astro-cid-relfimn4]{margin-top:3rem}@media (max-width: 40rem){.metadata[data-astro-cid-relfimn4]{flex-direction:column;align-items:start;justify-content:start}}
</style><link rel="stylesheet" href="/_astro/about.BrkH-_VM.css"><meta name="generator" content="Astro v5.7.8"><meta name="theme-color" content="#fff" media="(prefers-color-scheme: light)"><meta name="theme-color" content="#242428" media="(prefers-color-scheme: dark)"><link rel="sitemap" href="/sitemap-index.xml"><link rel="alternate" type="application/rss+xml" title="Blog – Jiří Pudil" href="/blog/rss.xml"><link rel="alternate" type="application/rss+xml" title="Notes – Jiří Pudil" href="/notes/rss.xml"><link rel="webmention" href="https://webmention.io/jiripudil.cz/webmention"><meta name="google-site-verification" content="7fHBkeNq7LXO24W8IjCc37NT9MX-6RJxD3Co5F-bRQw"><meta property="og:site_name" content="Jiří Pudil"><meta property="og:title" content="Bootstrap your integration testing database – Blog"><meta property="og:type" content="article"><meta property="article:published_time" content="2015-11-21T11:30:00.000Z"><meta property="article:tag" content="database"><meta property="article:tag" content="doctrine"><meta property="article:tag" content="migrations"><meta property="article:tag" content="nettefw"><meta property="article:tag" content="testing"><link rel="manifest" href="/manifest.webmanifest"><meta name="mobile-web-app-capable" content="yes"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#fff"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#000"><meta name="application-name" content="Jiří Pudil"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-precomposed.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#fff"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="apple-mobile-web-app-title" content="Jiří Pudil"><link rel="icon" type="image/x-icon" href="/favicon.ico"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="48x48" href="/favicon-48x48.png"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><meta name="msapplication-TileColor" content="#fff"><meta name="msapplication-TileImage" content="/mstile-144x144.png"><meta name="msapplication-config" content="/browserconfig.xml"><link rel="yandex-tableau-widget" href="/yandex-browser-manifest.json"></head> <body> <div class="header" data-astro-cid-3ef6ksr2> <div class="container" data-astro-cid-d6puh33w>  <nav class="menu" data-astro-cid-3ef6ksr2> <ul data-astro-cid-3ef6ksr2> <li class="name" data-astro-cid-3ef6ksr2> <a href="/" title="Home" data-astro-cid-3ef6ksr2>
Jiří Pudil
</a> </li> <li data-astro-cid-3ef6ksr2> <a href="/about" data-astro-cid-3ef6ksr2>
About
</a> </li> <li data-astro-cid-3ef6ksr2> <a href="/projects" data-astro-cid-3ef6ksr2>
Projects
</a> </li> <li data-astro-cid-3ef6ksr2> <a href="/blog" class="active" data-astro-cid-3ef6ksr2>
Blog
</a> </li> <li data-astro-cid-3ef6ksr2> <a href="/notes" data-astro-cid-3ef6ksr2>
Notes
</a> </li> <li data-astro-cid-3ef6ksr2> <a href="/talks" data-astro-cid-3ef6ksr2>
Talks
</a> </li> </ul> </nav>  </div>  </div>    <div class="container" data-astro-cid-d6puh33w>  <div class="body" data-astro-cid-relfimn4> <h1 data-astro-cid-relfimn4>Bootstrap your integration testing database</h1> <div class="metadata" data-astro-cid-relfimn4> <ul data-astro-cid-relfimn4> <li data-astro-cid-relfimn4><a href="/blog/tag/database" data-astro-cid-relfimn4>#database</a></li><li data-astro-cid-relfimn4><a href="/blog/tag/doctrine" data-astro-cid-relfimn4>#doctrine</a></li><li data-astro-cid-relfimn4><a href="/blog/tag/migrations" data-astro-cid-relfimn4>#migrations</a></li><li data-astro-cid-relfimn4><a href="/blog/tag/nettefw" data-astro-cid-relfimn4>#nettefw</a></li><li data-astro-cid-relfimn4><a href="/blog/tag/testing" data-astro-cid-relfimn4>#testing</a></li> </ul> <time datetime="2015-11-21T11:30:00.000Z" data-astro-cid-relfimn4> Nov 21, 2015 </time> </div> <p class="perex" data-astro-cid-relfimn4>Testing your application against a real database and pseudo-real data is quite a challenge. I'm going to show you how to automate the process of creating a test database with its schema and filling it with data, all with tools you might already be familiar with, including Nette Tester and Doctrine 2 along with Doctrine Migrations and Data Fixtures.</p> <div class="content" data-astro-cid-relfimn4> <p><em>I’ve recently had a discussion about this <a href="https://forum.nette.org/cs/24829-testovani-databaze-kdyby-doctrine-connection-mock">on Nette forum</a> (in Czech)
and decided to take it one step further and turn the outcome into a blog post.</em></p>
<p>Unit testing is not a silver bullet. Sometimes you need to write integration tests to make sure your code reads and
updates the state in the database exactly the way you want it to. You need to create a test database and fill it
with predictable data. But you want your tests to run effectively, in parallel, without them waiting for each other.
The best solution seems to be to create a new database for each test on the fly, prepare it, and destroy it afterwards.</p>
<p>Kind words of attribution: this code takes inspiration from <a href="https://github.com/Kdyby/TesterExtras">Kdyby\TesterExtras</a>
package.</p>
<h2 id="lazy-setup">Lazy setup</h2>
<p>First of all, we need to add some laziness. As our project grows, so does the database and in an ideal case also the
number of tests. So we don’t really want to setup the database in test cases in which it’s not needed. We can utilize
Nette’s events system and create a simple stub around the DBAL’s connection class that triggers an event whenever it
actually connects to the database.</p>
<pre class="astro-code astro-code-themes OneLight OneDark" style="background-color:#FAFAFA;--shiki-dark-bg:#282C34;color:#383A42;--shiki-dark:#ABB2BF; overflow-x: auto;" tabindex="0" data-language="php"><code><span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic">/**</span></span>
<span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic"> * </span><span style="color:#A626A4;font-style:italic;--shiki-dark:#C678DD;--shiki-dark-font-style:italic">@method</span><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic"> onConnect(ConnectionMock $self)</span></span>
<span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic"> */</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">class</span><span style="color:#C18401;--shiki-dark:#E5C07B"> ConnectionMock</span><span style="color:#A626A4;--shiki-dark:#C678DD"> extends</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> Kdyby\Doctrine\</span><span style="color:#C18401;--shiki-dark:#E5C07B">Connection</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">{</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">	public</span><span style="color:#E45649;--shiki-dark:#E06C75"> $onConnect</span><span style="color:#383A42;--shiki-dark:#C678DD"> =</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> [];</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">	public</span><span style="color:#A626A4;--shiki-dark:#C678DD"> function</span><span style="color:#4078F2;--shiki-dark:#61AFEF"> connect</span><span style="color:#383A42;--shiki-dark:#ABB2BF">()</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">	{</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">		if</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> (</span><span style="color:#A626A4;--shiki-dark:#C678DD">parent</span><span style="color:#383A42;--shiki-dark:#C678DD">::</span><span style="color:#4078F2;--shiki-dark:#61AFEF">connect</span><span style="color:#383A42;--shiki-dark:#ABB2BF">()) {</span></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">			$this</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">onConnect</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#E45649;--shiki-dark:#E06C75">$this</span><span style="color:#383A42;--shiki-dark:#ABB2BF">);</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">		}</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">}</span></span></code></pre>
<p>and register it in the config (e.g. <code>tests/tests.neon</code>):</p>
<pre class="astro-code astro-code-themes OneLight OneDark" style="background-color:#FAFAFA;--shiki-dark-bg:#282C34;color:#383A42;--shiki-dark:#ABB2BF; overflow-x: auto;" tabindex="0" data-language="yaml"><code><span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">doctrine</span><span style="color:#383A42;--shiki-dark:#ABB2BF">:</span></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">    wrapperClass</span><span style="color:#383A42;--shiki-dark:#ABB2BF">: </span><span style="color:#50A14F;--shiki-dark:#98C379">ConnectionMock</span></span></code></pre>
<h2 id="creating-the-database">Creating the database</h2>
<p>A little sidenote first: it’s practical to have the whole DI container at hand and just pull services out of it,
so let’s put that in a trait into the <code>tests</code> directory:</p>
<pre class="astro-code astro-code-themes OneLight OneDark" style="background-color:#FAFAFA;--shiki-dark-bg:#282C34;color:#383A42;--shiki-dark:#ABB2BF; overflow-x: auto;" tabindex="0" data-language="php"><code><span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">trait</span><span style="color:#C18401;--shiki-dark:#E5C07B"> CompiledContainer</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">{</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic">	/** </span><span style="color:#A626A4;font-style:italic;--shiki-dark:#C678DD;--shiki-dark-font-style:italic">@var</span><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic"> Nette\DI\</span><span style="color:#C18401;font-style:italic;--shiki-dark:#E5C07B;--shiki-dark-font-style:italic">Container</span><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic"> */</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">	private</span><span style="color:#E45649;--shiki-dark:#E06C75"> $container</span><span style="color:#383A42;--shiki-dark:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">	protected</span><span style="color:#A626A4;--shiki-dark:#C678DD"> function</span><span style="color:#4078F2;--shiki-dark:#61AFEF"> getContainer</span><span style="color:#383A42;--shiki-dark:#ABB2BF">()</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">	{</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">		if</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> (</span><span style="color:#E45649;--shiki-dark:#E06C75">$this</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#E45649;--shiki-dark:#E06C75">container</span><span style="color:#383A42;--shiki-dark:#C678DD"> ===</span><span style="color:#986801;--shiki-dark:#D19A66"> NULL</span><span style="color:#383A42;--shiki-dark:#ABB2BF">) {</span></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">			$this</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#E45649;--shiki-dark:#E06C75">container</span><span style="color:#383A42;--shiki-dark:#C678DD"> =</span><span style="color:#E45649;--shiki-dark:#E06C75"> $this</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">createContainer</span><span style="color:#383A42;--shiki-dark:#ABB2BF">();</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">		}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">		return</span><span style="color:#E45649;--shiki-dark:#E06C75"> $this</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#E45649;--shiki-dark:#E06C75">container</span><span style="color:#383A42;--shiki-dark:#ABB2BF">;</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">	}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">	protected</span><span style="color:#A626A4;--shiki-dark:#C678DD"> function</span><span style="color:#4078F2;--shiki-dark:#61AFEF"> createContainer</span><span style="color:#383A42;--shiki-dark:#ABB2BF">()</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">	{</span></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">		$configurator</span><span style="color:#383A42;--shiki-dark:#C678DD"> =</span><span style="color:#A626A4;--shiki-dark:#C678DD"> new</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> Nette\</span><span style="color:#C18401;--shiki-dark:#E5C07B">Configurator</span><span style="color:#383A42;--shiki-dark:#ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">		$configurator</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">setTempDirectory</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#0184BC;--shiki-dark:#56B6C2">dirname</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#986801;--shiki-dark:#D19A66">TEMP_DIR</span><span style="color:#383A42;--shiki-dark:#ABB2BF">)); </span><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic">// shared container for performance purposes</span></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">		$configurator</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">setDebugMode</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#986801;--shiki-dark:#D19A66">FALSE</span><span style="color:#383A42;--shiki-dark:#ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">		$configurator</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">addParameters</span><span style="color:#383A42;--shiki-dark:#ABB2BF">([</span></span>
<span class="line"><span style="color:#50A14F;--shiki-dark:#98C379">			'appDir'</span><span style="color:#383A42;--shiki-dark:#C678DD"> =></span><span style="color:#986801;--shiki-dark:#D19A66"> __DIR__</span><span style="color:#383A42;--shiki-dark:#C678DD"> .</span><span style="color:#50A14F;--shiki-dark:#98C379"> '/../../app'</span><span style="color:#383A42;--shiki-dark:#ABB2BF">,</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">		]);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">		$configurator</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">addConfig</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#986801;--shiki-dark:#D19A66">__DIR__</span><span style="color:#383A42;--shiki-dark:#C678DD"> .</span><span style="color:#50A14F;--shiki-dark:#98C379"> '/../app/config/config.neon'</span><span style="color:#383A42;--shiki-dark:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">		$configurator</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">addConfig</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#986801;--shiki-dark:#D19A66">__DIR__</span><span style="color:#383A42;--shiki-dark:#C678DD"> .</span><span style="color:#50A14F;--shiki-dark:#98C379"> '/tests.neon'</span><span style="color:#383A42;--shiki-dark:#ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">		return</span><span style="color:#E45649;--shiki-dark:#E06C75"> $configurator</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">createContainer</span><span style="color:#383A42;--shiki-dark:#ABB2BF">();</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">}</span></span></code></pre>
<p>Now let’s write another trait with the actual database setup. It will use the <code>CompiledContainer</code> trait and override
its <code>createContainer</code> method with its own that adds a handler to the connect event we implemented in our <code>ConnectionMock</code>
above:</p>
<pre class="astro-code astro-code-themes OneLight OneDark" style="background-color:#FAFAFA;--shiki-dark-bg:#282C34;color:#383A42;--shiki-dark:#ABB2BF; overflow-x: auto;" tabindex="0" data-language="php"><code><span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">trait</span><span style="color:#C18401;--shiki-dark:#E5C07B"> DatabaseSetup</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">{</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">	use</span><span style="color:#C18401;--shiki-dark:#E5C07B"> CompiledContainer</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C18401;--shiki-dark:#E5C07B">		createContainer</span><span style="color:#A626A4;--shiki-dark:#C678DD"> as</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> parentCreateContainer;</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">	}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic">	/**</span></span>
<span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic">	 * </span><span style="color:#A626A4;font-style:italic;--shiki-dark:#C678DD;--shiki-dark-font-style:italic">@var</span><span style="color:#A626A4;font-style:italic;--shiki-dark:#C678DD;--shiki-dark-font-style:italic"> string</span><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic">|</span><span style="color:#C18401;font-style:italic;--shiki-dark:#E5C07B;--shiki-dark-font-style:italic">NULL</span></span>
<span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic">	 */</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">	protected</span><span style="color:#E45649;--shiki-dark:#E06C75"> $databaseName</span><span style="color:#383A42;--shiki-dark:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">	protected</span><span style="color:#A626A4;--shiki-dark:#C678DD"> function</span><span style="color:#4078F2;--shiki-dark:#61AFEF"> createContainer</span><span style="color:#383A42;--shiki-dark:#ABB2BF">()</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">	{</span></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">		$container</span><span style="color:#383A42;--shiki-dark:#C678DD"> =</span><span style="color:#E45649;--shiki-dark:#E06C75"> $this</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">parentCreateContainer</span><span style="color:#383A42;--shiki-dark:#ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic">		/** </span><span style="color:#A626A4;font-style:italic;--shiki-dark:#C678DD;--shiki-dark-font-style:italic">@var</span><span style="color:#C18401;font-style:italic;--shiki-dark:#E5C07B;--shiki-dark-font-style:italic"> ConnectionMock</span><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic"> $db */</span></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">		$db</span><span style="color:#383A42;--shiki-dark:#C678DD"> =</span><span style="color:#E45649;--shiki-dark:#E06C75"> $container</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">getByType</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(Doctrine\DBAL\</span><span style="color:#C18401;--shiki-dark:#E5C07B">Connection</span><span style="color:#383A42;--shiki-dark:#C678DD">::</span><span style="color:#A626A4;--shiki-dark:#C678DD">class</span><span style="color:#383A42;--shiki-dark:#ABB2BF">);</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">		if</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> ( </span><span style="color:#383A42;--shiki-dark:#C678DD">!</span><span style="color:#E45649;--shiki-dark:#E06C75"> $db</span><span style="color:#383A42;--shiki-dark:#C678DD"> instanceof</span><span style="color:#C18401;--shiki-dark:#E5C07B"> ConnectionMock</span><span style="color:#383A42;--shiki-dark:#ABB2BF">) {</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">			throw</span><span style="color:#A626A4;--shiki-dark:#C678DD"> new</span><span style="color:#C18401;--shiki-dark:#E5C07B"> \LogicException</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#50A14F;--shiki-dark:#98C379">"Connection service should be instance of ConnectionMock"</span><span style="color:#383A42;--shiki-dark:#ABB2BF">);</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">		}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">		$db</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#E45649;--shiki-dark:#E06C75">onConnect</span><span style="color:#383A42;--shiki-dark:#ABB2BF">[] </span><span style="color:#383A42;--shiki-dark:#C678DD">=</span><span style="color:#A626A4;--shiki-dark:#C678DD"> function</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> (Doctrine\DBAL\</span><span style="color:#C18401;--shiki-dark:#E5C07B">Connection</span><span style="color:#E45649;--shiki-dark:#E06C75"> $db</span><span style="color:#383A42;--shiki-dark:#ABB2BF">) </span><span style="color:#A626A4;--shiki-dark:#C678DD">use</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> (</span><span style="color:#E45649;--shiki-dark:#E06C75">$container</span><span style="color:#383A42;--shiki-dark:#ABB2BF">) {</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">			if</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> (</span><span style="color:#E45649;--shiki-dark:#E06C75">$this</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#E45649;--shiki-dark:#E06C75">databaseName</span><span style="color:#383A42;--shiki-dark:#C678DD"> !==</span><span style="color:#986801;--shiki-dark:#D19A66"> NULL</span><span style="color:#383A42;--shiki-dark:#ABB2BF">) {</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">				return</span><span style="color:#383A42;--shiki-dark:#ABB2BF">;</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">			}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">			try</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">				$this</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">setupDatabase</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#E45649;--shiki-dark:#E06C75">$db</span><span style="color:#383A42;--shiki-dark:#ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">			} </span><span style="color:#A626A4;--shiki-dark:#C678DD">catch</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> (\</span><span style="color:#C18401;--shiki-dark:#E5C07B">Exception</span><span style="color:#E45649;--shiki-dark:#E06C75"> $e</span><span style="color:#383A42;--shiki-dark:#ABB2BF">) {</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">				Tester\</span><span style="color:#C18401;--shiki-dark:#E5C07B">Assert</span><span style="color:#383A42;--shiki-dark:#C678DD">::</span><span style="color:#4078F2;--shiki-dark:#61AFEF">fail</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#E45649;--shiki-dark:#E06C75">$e</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">getMessage</span><span style="color:#383A42;--shiki-dark:#ABB2BF">());</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">			}</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">		};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">		return</span><span style="color:#E45649;--shiki-dark:#E06C75"> $container</span><span style="color:#383A42;--shiki-dark:#ABB2BF">;</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">	}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">	private</span><span style="color:#A626A4;--shiki-dark:#C678DD"> function</span><span style="color:#4078F2;--shiki-dark:#61AFEF"> setupDatabase</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#C18401;--shiki-dark:#E5C07B">Connection</span><span style="color:#E45649;--shiki-dark:#E06C75"> $db</span><span style="color:#383A42;--shiki-dark:#ABB2BF">)</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">	{</span></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">		$this</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#E45649;--shiki-dark:#E06C75">databaseName</span><span style="color:#383A42;--shiki-dark:#C678DD"> =</span><span style="color:#50A14F;--shiki-dark:#98C379"> 'db_tests_'</span><span style="color:#383A42;--shiki-dark:#C678DD"> .</span><span style="color:#0184BC;--shiki-dark:#56B6C2"> getmypid</span><span style="color:#383A42;--shiki-dark:#ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">		$this</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">dropDatabase</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#E45649;--shiki-dark:#E06C75">$db</span><span style="color:#383A42;--shiki-dark:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">		$this</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">createDatabase</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#E45649;--shiki-dark:#E06C75">$db</span><span style="color:#383A42;--shiki-dark:#ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic">		// TODO init schema and load data (see below)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#0184BC;--shiki-dark:#56B6C2">		register_shutdown_function</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#A626A4;--shiki-dark:#C678DD">function</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> () </span><span style="color:#A626A4;--shiki-dark:#C678DD">use</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> (</span><span style="color:#E45649;--shiki-dark:#E06C75">$db</span><span style="color:#383A42;--shiki-dark:#ABB2BF">) {</span></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">			$this</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">dropDatabase</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#E45649;--shiki-dark:#E06C75">$db</span><span style="color:#383A42;--shiki-dark:#ABB2BF">);</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">		});</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">}</span></span></code></pre>
<p>The important part is the <code>setupDatabase</code> method. It generates a new database name using the ID of the current process,
drops it if it already exists, creates a new one, and registers a shutdown function that does the cleaning after
finishing the test. As to the <code>dropDatabase</code> and <code>createDatabase</code> methods, the implementation slightly varies across
different platforms.</p>
<p>The problem is there is no standardized way of switching databases. While in MySQL you can just issue a <code>USE</code> query,
in PostgreSQL, for instance, you cannot switch between different databases on the fly, because you only connect to one
database at the time directly. In addition, Postgres prevents you from dropping a database if there are still open
connections to it. So employing a few hacks is, unfortunately, inevitable. This is what it looks like for PostgreSQL
(MySQL should be a bit simpler):</p>
<pre class="astro-code astro-code-themes OneLight OneDark" style="background-color:#FAFAFA;--shiki-dark-bg:#282C34;color:#383A42;--shiki-dark:#ABB2BF; overflow-x: auto;" tabindex="0" data-language="php"><code><span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">private</span><span style="color:#A626A4;--shiki-dark:#C678DD"> function</span><span style="color:#4078F2;--shiki-dark:#61AFEF"> createDatabase</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#C18401;--shiki-dark:#E5C07B">Connection</span><span style="color:#E45649;--shiki-dark:#E06C75"> $db</span><span style="color:#383A42;--shiki-dark:#ABB2BF">)</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">{</span></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">	$db</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">exec</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#50A14F;--shiki-dark:#98C379">"</span><span style="color:#A626A4;--shiki-dark:#C678DD">CREATE</span><span style="color:#A626A4;--shiki-dark:#C678DD"> DATABASE</span><span style="color:#E45649;--shiki-dark:#E06C75"> {$this</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#E45649;--shiki-dark:#E06C75">databaseName}</span><span style="color:#50A14F;--shiki-dark:#98C379">"</span><span style="color:#383A42;--shiki-dark:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">	$this</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">connectToDatabase</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#E45649;--shiki-dark:#E06C75">$db</span><span style="color:#383A42;--shiki-dark:#ABB2BF">, </span><span style="color:#E45649;--shiki-dark:#E06C75">$this</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#E45649;--shiki-dark:#E06C75">databaseName</span><span style="color:#383A42;--shiki-dark:#ABB2BF">);</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">private</span><span style="color:#A626A4;--shiki-dark:#C678DD"> function</span><span style="color:#4078F2;--shiki-dark:#61AFEF"> dropDatabase</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#C18401;--shiki-dark:#E5C07B">Connection</span><span style="color:#E45649;--shiki-dark:#E06C75"> $db</span><span style="color:#383A42;--shiki-dark:#ABB2BF">)</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">{</span></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">	$this</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">connectToDatabase</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#E45649;--shiki-dark:#E06C75">$db</span><span style="color:#383A42;--shiki-dark:#ABB2BF">, </span><span style="color:#50A14F;--shiki-dark:#98C379">'postgres'</span><span style="color:#383A42;--shiki-dark:#ABB2BF">); </span><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic">// connect to an existing database other than $this->databaseName</span></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">	$db</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">exec</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#50A14F;--shiki-dark:#98C379">"DROP DATABASE IF EXISTS </span><span style="color:#E45649;--shiki-dark:#E06C75">{$this</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#E45649;--shiki-dark:#E06C75">databaseName}</span><span style="color:#50A14F;--shiki-dark:#98C379">"</span><span style="color:#383A42;--shiki-dark:#ABB2BF">);</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">private</span><span style="color:#A626A4;--shiki-dark:#C678DD"> function</span><span style="color:#4078F2;--shiki-dark:#61AFEF"> connectToDatabase</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#C18401;--shiki-dark:#E5C07B">Connection</span><span style="color:#E45649;--shiki-dark:#E06C75"> $db</span><span style="color:#383A42;--shiki-dark:#ABB2BF">, </span><span style="color:#E45649;--shiki-dark:#E06C75">$databaseName</span><span style="color:#383A42;--shiki-dark:#ABB2BF">)</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">{</span></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">	$db</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">close</span><span style="color:#383A42;--shiki-dark:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">	$db</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">__construct</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">		[</span><span style="color:#50A14F;--shiki-dark:#98C379">'dbname'</span><span style="color:#383A42;--shiki-dark:#C678DD"> =></span><span style="color:#E45649;--shiki-dark:#E06C75"> $databaseName</span><span style="color:#383A42;--shiki-dark:#ABB2BF">] </span><span style="color:#383A42;--shiki-dark:#C678DD">+</span><span style="color:#E45649;--shiki-dark:#E06C75"> $db</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">getParams</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(),</span></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">		$db</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">getDriver</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(),</span></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">		$db</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">getConfiguration</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(),</span></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">		$db</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">getEventManager</span><span style="color:#383A42;--shiki-dark:#ABB2BF">()</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">	);</span></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">	$db</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">connect</span><span style="color:#383A42;--shiki-dark:#ABB2BF">();</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">}</span></span></code></pre>
<h2 id="setting-up-the-schema">Setting up the schema</h2>
<p>I guess you’ve noticed the big TODO in the code above, saying <code>init schema and load data</code>. So let’s get to the first
point and then to the other one. The direct and most simple approach to both schema and data is to have them in raw
SQL queries and simply execute them:</p>
<pre class="astro-code astro-code-themes OneLight OneDark" style="background-color:#FAFAFA;--shiki-dark-bg:#282C34;color:#383A42;--shiki-dark:#ABB2BF; overflow-x: auto;" tabindex="0" data-language="php"><code><span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">foreach</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> (</span><span style="color:#E45649;--shiki-dark:#E06C75">$sqls</span><span style="color:#383A42;--shiki-dark:#C678DD"> as</span><span style="color:#E45649;--shiki-dark:#E06C75"> $file</span><span style="color:#383A42;--shiki-dark:#ABB2BF">) {</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">	Kdyby\Doctrine\</span><span style="color:#C18401;--shiki-dark:#E5C07B">Helpers</span><span style="color:#383A42;--shiki-dark:#C678DD">::</span><span style="color:#4078F2;--shiki-dark:#61AFEF">loadFromFile</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#E45649;--shiki-dark:#E06C75">$db</span><span style="color:#383A42;--shiki-dark:#ABB2BF">, </span><span style="color:#E45649;--shiki-dark:#E06C75">$file</span><span style="color:#383A42;--shiki-dark:#ABB2BF">);</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">}</span></span></code></pre>
<p>This might, however, add some overhead if you use <a href="http://www.doctrine-project.org/projects/migrations.html"><code>doctrine/migrations</code></a>
like me, because in addition to writing (or generating) migrations, you need to keep the whole schema in a separate
file and up-to-date. Or you could just run the migrations directly! (I use <code>Zenify/DoctrineMigrations</code> package.
If you don’t, you have to get or create the <code>Configuration</code> object on your own.)</p>
<pre class="astro-code astro-code-themes OneLight OneDark" style="background-color:#FAFAFA;--shiki-dark-bg:#282C34;color:#383A42;--shiki-dark:#ABB2BF; overflow-x: auto;" tabindex="0" data-language="php"><code><span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">$container</span><span style="color:#383A42;--shiki-dark:#C678DD"> =</span><span style="color:#E45649;--shiki-dark:#E06C75"> $this</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">getContainer</span><span style="color:#383A42;--shiki-dark:#ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic">/** </span><span style="color:#A626A4;font-style:italic;--shiki-dark:#C678DD;--shiki-dark-font-style:italic">@var</span><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic"> Zenify\DoctrineMigrations\Configuration\</span><span style="color:#C18401;font-style:italic;--shiki-dark:#E5C07B;--shiki-dark-font-style:italic">Configuration</span><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic"> $migrationsConfig */</span></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">$migrationsConfig</span><span style="color:#383A42;--shiki-dark:#C678DD"> =</span><span style="color:#E45649;--shiki-dark:#E06C75"> $container</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">getByType</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(Zenify\DoctrineMigrations\Configuration\</span><span style="color:#C18401;--shiki-dark:#E5C07B">Configuration</span><span style="color:#383A42;--shiki-dark:#C678DD">::</span><span style="color:#A626A4;--shiki-dark:#C678DD">class</span><span style="color:#383A42;--shiki-dark:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">$migrationsConfig</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">__construct</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#E45649;--shiki-dark:#E06C75">$container</span><span style="color:#383A42;--shiki-dark:#ABB2BF">, </span><span style="color:#E45649;--shiki-dark:#E06C75">$db</span><span style="color:#383A42;--shiki-dark:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">$migrationsConfig</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">registerMigrationsFromDirectory</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#E45649;--shiki-dark:#E06C75">$migrationsConfig</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">getMigrationsDirectory</span><span style="color:#383A42;--shiki-dark:#ABB2BF">());</span></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">$migration</span><span style="color:#383A42;--shiki-dark:#C678DD"> =</span><span style="color:#A626A4;--shiki-dark:#C678DD"> new</span><span style="color:#C18401;--shiki-dark:#E5C07B"> Migration</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#E45649;--shiki-dark:#E06C75">$migrationsConfig</span><span style="color:#383A42;--shiki-dark:#ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">$migration</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">migrate</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#E45649;--shiki-dark:#E06C75">$migrationsConfig</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">getLatestVersion</span><span style="color:#383A42;--shiki-dark:#ABB2BF">());</span></span></code></pre>
<p>The constructor magic is not absolutely necessary but it’s handy not to pass the third argument (<code>$outputWriter</code>)
to disable the output. Otherwise, you get the migrations progress thrown right into your tests console. For. Every.
Single. Test. You don’t want that.</p>
<h2 id="filling-it-with-data">Filling it with data</h2>
<p>If you have your test data in SQL files, you are already good to go (see above). But I’m still going to show you
a different approach using Doctrine’s Data Fixtures. Well, not just yet. Let’s define a simple entity to work with
in the first place:</p>
<pre class="astro-code astro-code-themes OneLight OneDark" style="background-color:#FAFAFA;--shiki-dark-bg:#282C34;color:#383A42;--shiki-dark:#ABB2BF; overflow-x: auto;" tabindex="0" data-language="php"><code><span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">use</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> Doctrine\ORM\</span><span style="color:#C18401;--shiki-dark:#E5C07B">Mapping</span><span style="color:#A626A4;--shiki-dark:#C678DD"> as</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> ORM;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic">/**</span></span>
<span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic"> * @ORM\Entity()</span></span>
<span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic"> * @ORM\Table(name="user_account", uniqueConstraints={</span></span>
<span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic"> *   @ORM\UniqueConstraint(columns={"email"})</span></span>
<span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic"> * })</span></span>
<span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic"> */</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">class</span><span style="color:#C18401;--shiki-dark:#E5C07B"> User</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">{</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">	</span></span>
<span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic">	/**</span></span>
<span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic">	 * @ORM\Id()</span></span>
<span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic">	 * @ORM\Column(type="integer")</span></span>
<span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic">	 * @ORM\GeneratedValue()</span></span>
<span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic">	 * </span><span style="color:#A626A4;font-style:italic;--shiki-dark:#C678DD;--shiki-dark-font-style:italic">@var</span><span style="color:#A626A4;font-style:italic;--shiki-dark:#C678DD;--shiki-dark-font-style:italic"> int</span></span>
<span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic">	 */</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">	private</span><span style="color:#E45649;--shiki-dark:#E06C75"> $id</span><span style="color:#383A42;--shiki-dark:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic">	/**</span></span>
<span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic">	 * @ORM\Column(type="string")</span></span>
<span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic">	 * </span><span style="color:#A626A4;font-style:italic;--shiki-dark:#C678DD;--shiki-dark-font-style:italic">@var</span><span style="color:#A626A4;font-style:italic;--shiki-dark:#C678DD;--shiki-dark-font-style:italic"> string</span></span>
<span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic">	 */</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">	private</span><span style="color:#E45649;--shiki-dark:#E06C75"> $email</span><span style="color:#383A42;--shiki-dark:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">	public</span><span style="color:#A626A4;--shiki-dark:#C678DD"> function</span><span style="color:#0184BC;--shiki-dark:#56B6C2"> __construct</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#E45649;--shiki-dark:#E06C75">$email</span><span style="color:#383A42;--shiki-dark:#ABB2BF">)</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">	{</span></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">		$this</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#E45649;--shiki-dark:#E06C75">email</span><span style="color:#383A42;--shiki-dark:#C678DD"> =</span><span style="color:#E45649;--shiki-dark:#E06C75"> $email</span><span style="color:#383A42;--shiki-dark:#ABB2BF">;</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">	}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">	public</span><span style="color:#A626A4;--shiki-dark:#C678DD"> function</span><span style="color:#4078F2;--shiki-dark:#61AFEF"> getEmail</span><span style="color:#383A42;--shiki-dark:#ABB2BF">()</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">	{</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">		return</span><span style="color:#E45649;--shiki-dark:#E06C75"> $this</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#E45649;--shiki-dark:#E06C75">email</span><span style="color:#383A42;--shiki-dark:#ABB2BF">;</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">}</span></span></code></pre>
<p>Now to the data fixtures. As you can read in its <a href="https://github.com/doctrine/data-fixtures">docs/readme</a>, the package
provides a way to load data into the database. The main advantage of fixtures is that they, as well as the whole
Doctrine ORM, abstract you from the database you use and let you work with data in terms of your domain model.
You don’t need to write SQL queries with things like foreign key constraints or platform-specific syntax in consideration,
you just create a new instance of your entity and persist it through the EntityManager. Like this:</p>
<pre class="astro-code astro-code-themes OneLight OneDark" style="background-color:#FAFAFA;--shiki-dark-bg:#282C34;color:#383A42;--shiki-dark:#ABB2BF; overflow-x: auto;" tabindex="0" data-language="php"><code><span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">use</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> Doctrine\Common\DataFixtures\</span><span style="color:#C18401;--shiki-dark:#E5C07B">AbstractFixture</span><span style="color:#383A42;--shiki-dark:#ABB2BF">;</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">use</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> Doctrine\Common\Persistence\</span><span style="color:#C18401;--shiki-dark:#E5C07B">ObjectManager</span><span style="color:#383A42;--shiki-dark:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">class</span><span style="color:#C18401;--shiki-dark:#E5C07B"> UserFixture</span><span style="color:#A626A4;--shiki-dark:#C678DD"> extends</span><span style="color:#C18401;--shiki-dark:#E5C07B"> AbstractFixture</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">{</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic">	/**</span></span>
<span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic">	 * </span><span style="color:#A626A4;font-style:italic;--shiki-dark:#C678DD;--shiki-dark-font-style:italic">@param</span><span style="color:#C18401;font-style:italic;--shiki-dark:#E5C07B;--shiki-dark-font-style:italic"> ObjectManager</span><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic"> $manager</span></span>
<span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic">	 */</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">	public</span><span style="color:#A626A4;--shiki-dark:#C678DD"> function</span><span style="color:#4078F2;--shiki-dark:#61AFEF"> load</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#C18401;--shiki-dark:#E5C07B">ObjectManager</span><span style="color:#E45649;--shiki-dark:#E06C75"> $manager</span><span style="color:#383A42;--shiki-dark:#ABB2BF">)</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">	{</span></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">		$user</span><span style="color:#383A42;--shiki-dark:#C678DD"> =</span><span style="color:#A626A4;--shiki-dark:#C678DD"> new</span><span style="color:#C18401;--shiki-dark:#E5C07B"> User</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#50A14F;--shiki-dark:#98C379">'me@jiripudil.cz'</span><span style="color:#383A42;--shiki-dark:#ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">		$manager</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">persist</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#E45649;--shiki-dark:#E06C75">$user</span><span style="color:#383A42;--shiki-dark:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">		$manager</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">flush</span><span style="color:#383A42;--shiki-dark:#ABB2BF">();</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">}</span></span></code></pre>
<p>In the <code>setupDatabase</code> method, you only have to load those fixtures and execute them:</p>
<pre class="astro-code astro-code-themes OneLight OneDark" style="background-color:#FAFAFA;--shiki-dark-bg:#282C34;color:#383A42;--shiki-dark:#ABB2BF; overflow-x: auto;" tabindex="0" data-language="php"><code><span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">use</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> Doctrine\Common\</span><span style="color:#C18401;--shiki-dark:#E5C07B">DataFixtures</span><span style="color:#A626A4;--shiki-dark:#C678DD"> as</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> Fixtures;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">$fixtures</span><span style="color:#383A42;--shiki-dark:#C678DD"> =</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> [];</span></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">$fixtures</span><span style="color:#383A42;--shiki-dark:#C678DD"> =</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> (</span><span style="color:#A626A4;--shiki-dark:#C678DD">new</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> Fixtures\</span><span style="color:#C18401;--shiki-dark:#E5C07B">Loader</span><span style="color:#383A42;--shiki-dark:#ABB2BF">())</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">loadFromDirectory</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#986801;--shiki-dark:#D19A66">__DIR__</span><span style="color:#383A42;--shiki-dark:#C678DD"> .</span><span style="color:#50A14F;--shiki-dark:#98C379"> '/../fixtures'</span><span style="color:#383A42;--shiki-dark:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">$executor</span><span style="color:#383A42;--shiki-dark:#C678DD"> =</span><span style="color:#A626A4;--shiki-dark:#C678DD"> new</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> Fixtures\Executor\</span><span style="color:#C18401;--shiki-dark:#E5C07B">ORMExecutor</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#E45649;--shiki-dark:#E06C75">$container</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">getByType</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#C18401;--shiki-dark:#E5C07B">EntityManager</span><span style="color:#383A42;--shiki-dark:#C678DD">::</span><span style="color:#A626A4;--shiki-dark:#C678DD">class</span><span style="color:#383A42;--shiki-dark:#ABB2BF">));</span></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">$executor</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">execute</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#E45649;--shiki-dark:#E06C75">$fixtures</span><span style="color:#383A42;--shiki-dark:#ABB2BF">, </span><span style="color:#986801;--shiki-dark:#D19A66">TRUE</span><span style="color:#383A42;--shiki-dark:#ABB2BF">);</span></span></code></pre>
<h2 id="testing-against-the-database">Testing against the database</h2>
<p>Now that we have everything set up, we can finally write a test case that uses the database and its test data!</p>
<pre class="astro-code astro-code-themes OneLight OneDark" style="background-color:#FAFAFA;--shiki-dark-bg:#282C34;color:#383A42;--shiki-dark:#ABB2BF; overflow-x: auto;" tabindex="0" data-language="php"><code><span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic">/**</span></span>
<span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic"> * @testCase</span></span>
<span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic"> */</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">use</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> Kdyby\Doctrine\</span><span style="color:#C18401;--shiki-dark:#E5C07B">EntityManager</span><span style="color:#383A42;--shiki-dark:#ABB2BF">;</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">use</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> Tester\</span><span style="color:#C18401;--shiki-dark:#E5C07B">Assert</span><span style="color:#383A42;--shiki-dark:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">require_once</span><span style="color:#986801;--shiki-dark:#D19A66"> __DIR__</span><span style="color:#383A42;--shiki-dark:#C678DD"> .</span><span style="color:#50A14F;--shiki-dark:#98C379"> '/../../bootstrap.php'</span><span style="color:#383A42;--shiki-dark:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">class</span><span style="color:#C18401;--shiki-dark:#E5C07B"> UserTest</span><span style="color:#A626A4;--shiki-dark:#C678DD"> extends</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> Tester\</span><span style="color:#C18401;--shiki-dark:#E5C07B">TestCase</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">{</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">	use</span><span style="color:#C18401;--shiki-dark:#E5C07B"> DatabaseSetup</span><span style="color:#383A42;--shiki-dark:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">	public</span><span style="color:#A626A4;--shiki-dark:#C678DD"> function</span><span style="color:#4078F2;--shiki-dark:#61AFEF"> testFetchUserByEmail</span><span style="color:#383A42;--shiki-dark:#ABB2BF">()</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">	{</span></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">		$em</span><span style="color:#383A42;--shiki-dark:#C678DD"> =</span><span style="color:#E45649;--shiki-dark:#E06C75"> $this</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">getContainer</span><span style="color:#383A42;--shiki-dark:#ABB2BF">()</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">getByType</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#C18401;--shiki-dark:#E5C07B">EntityManager</span><span style="color:#383A42;--shiki-dark:#C678DD">::</span><span style="color:#A626A4;--shiki-dark:#C678DD">class</span><span style="color:#383A42;--shiki-dark:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">		$user</span><span style="color:#383A42;--shiki-dark:#C678DD"> =</span><span style="color:#E45649;--shiki-dark:#E06C75"> $em</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">getRepository</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#C18401;--shiki-dark:#E5C07B">User</span><span style="color:#383A42;--shiki-dark:#C678DD">::</span><span style="color:#A626A4;--shiki-dark:#C678DD">class</span><span style="color:#383A42;--shiki-dark:#ABB2BF">)</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">findOneBy</span><span style="color:#383A42;--shiki-dark:#ABB2BF">([</span><span style="color:#50A14F;--shiki-dark:#98C379">'email'</span><span style="color:#383A42;--shiki-dark:#C678DD"> =></span><span style="color:#50A14F;--shiki-dark:#98C379"> 'me@jiripudil.cz'</span><span style="color:#383A42;--shiki-dark:#ABB2BF">]);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C18401;--shiki-dark:#E5C07B">		Assert</span><span style="color:#383A42;--shiki-dark:#C678DD">::</span><span style="color:#4078F2;--shiki-dark:#61AFEF">type</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#C18401;--shiki-dark:#E5C07B">User</span><span style="color:#383A42;--shiki-dark:#C678DD">::</span><span style="color:#A626A4;--shiki-dark:#C678DD">class</span><span style="color:#383A42;--shiki-dark:#ABB2BF">, </span><span style="color:#E45649;--shiki-dark:#E06C75">$user</span><span style="color:#383A42;--shiki-dark:#ABB2BF">);</span></span>
<span class="line"><span style="color:#C18401;--shiki-dark:#E5C07B">		Assert</span><span style="color:#383A42;--shiki-dark:#C678DD">::</span><span style="color:#4078F2;--shiki-dark:#61AFEF">same</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#50A14F;--shiki-dark:#98C379">'me@jiripudil.cz'</span><span style="color:#383A42;--shiki-dark:#ABB2BF">, </span><span style="color:#E45649;--shiki-dark:#E06C75">$user</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">getEmail</span><span style="color:#383A42;--shiki-dark:#ABB2BF">());</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#A626A4;--shiki-dark:#C678DD">new</span><span style="color:#C18401;--shiki-dark:#E5C07B"> UserTest</span><span style="color:#383A42;--shiki-dark:#ABB2BF">())</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">run</span><span style="color:#383A42;--shiki-dark:#ABB2BF">();</span></span></code></pre>
<h2 id="complete-example">Complete example <img src="https://img.shields.io/travis/jiripudil/blog-db-testing.svg" alt=""></h2>
<p>You can find all those bits of code put into a single whole showcase <a href="https://github.com/jiripudil/blog-db-testing">on my Github</a>
and see the build <a href="https://travis-ci.org/jiripudil/blog-db-testing">on Travis</a>. It runs both on MySQL and PostgreSQL
and you can see that there are two sets of migrations, but the fixtures are shared between both database platforms.
It’s also slightly extended as I’ve tried to keep the code examples in this post as short and concise as possible:</p>
<ul>
<li>the execution of migrations and fixtures is moved into separate methods,</li>
<li><a href="https://github.com/jiripudil/blog-db-testing/blob/098ae5b043a58acea5d36f637264ad490206ec35/tests/DbTests/DatabaseSetup.php#L92-L96">fixtures are loaded via the DI container</a> so that they can <a href="https://github.com/jiripudil/blog-db-testing/blob/098ae5b043a58acea5d36f637264ad490206ec35/tests/fixtures/UserFixture.php#L18">have dependencies</a>,</li>
<li>there are <a href="https://github.com/jiripudil/blog-db-testing/blob/098ae5b043a58acea5d36f637264ad490206ec35/tests/DbTests/Entities/UserTest.phpt#L57-L72">test methods</a> to prove that each test method runs in its own context, with its own database (if you use the <code>@testCase</code> annotation of course),</li>
<li>the test case <a href="https://github.com/jiripudil/blog-db-testing/blob/098ae5b043a58acea5d36f637264ad490206ec35/tests/DbTests/Entities/UserTest.phpt#L5">runs 50 times</a>, spawning 200 databases in total to provide a hint about the performace. I’m quite surprised that PostgreSQL is considerably slower than MySQL (see builds on <a href="https://travis-ci.org/jiripudil/blog-db-testing">Travis</a>).</li>
</ul>
<p>What about you? Do you test against a live database? Or are you going to now that you see it’s this easy? Share your
thoughts in the comments section below.</p> </div> <div class="comments" data-astro-cid-relfimn4> <div id="giscus-container"></div> <script type="module">const t=document.createElement("script");t.src="https://giscus.app/client.js";t.crossOrigin="anonymous";t.async=!0;t.setAttribute("data-repo","jiripudil/jiripudil.cz");t.setAttribute("data-repo-id","MDEwOlJlcG9zaXRvcnkyNTI5NzY3Nw==");t.setAttribute("data-category","Blog discussions");t.setAttribute("data-category-id","DIC_kwDOAYIDDc4CAfUM");t.setAttribute("data-mapping","og:title");t.setAttribute("data-reactions-enabled","1");t.setAttribute("data-emit-metadata","0");t.setAttribute("data-theme","preferred_color_scheme");t.setAttribute("data-lang","en");t.setAttribute("data-loading","lazy");const e=document.getElementById("giscus-container");e.appendChild(t);</script> </div> </div>  </div>   <div class="footer" data-astro-cid-sz7xmlte> <div class="container" data-astro-cid-d6puh33w> 
Content licensed under
<a href="https://creativecommons.org/licenses/by/4.0/" title="Creative Commons Attribution 4.0 International" aria-label="Creative Commons Attribution 4.0 International" data-astro-cid-sz7xmlte> <svg width="0.97em" height="1em" data-astro-cid-sz7xmlte="true" data-icon="fa6-brands:creative-commons">   <symbol id="ai:fa6-brands:creative-commons" viewBox="0 0 496 512"><path fill="currentColor" d="m245.83 214.87l-33.22 17.28c-9.43-19.58-25.24-19.93-27.46-19.93c-22.13 0-33.22 14.61-33.22 43.84c0 23.57 9.21 43.84 33.22 43.84c14.47 0 24.65-7.09 30.57-21.26l30.55 15.5c-6.17 11.51-25.69 38.98-65.1 38.98c-22.6 0-73.96-10.32-73.96-77.05c0-58.69 43-77.06 72.63-77.06c30.72-.01 52.7 11.95 65.99 35.86m143.05 0l-32.78 17.28c-9.5-19.77-25.72-19.93-27.9-19.93c-22.14 0-33.22 14.61-33.22 43.84c0 23.55 9.23 43.84 33.22 43.84c14.45 0 24.65-7.09 30.54-21.26l31 15.5c-2.1 3.75-21.39 38.98-65.09 38.98c-22.69 0-73.96-9.87-73.96-77.05c0-58.67 42.97-77.06 72.63-77.06c30.71-.01 52.58 11.95 65.56 35.86M247.56 8.05C104.74 8.05 0 123.11 0 256.05c0 138.49 113.6 248 247.56 248c129.93 0 248.44-100.87 248.44-248c0-137.87-106.62-248-248.44-248m.87 450.81c-112.54 0-203.7-93.04-203.7-202.81c0-105.42 85.43-203.27 203.72-203.27c112.53 0 202.82 89.46 202.82 203.26c-.01 121.69-99.68 202.82-202.84 202.82"/></symbol><use href="#ai:fa6-brands:creative-commons"></use>  </svg> <svg width="0.97em" height="1em" data-astro-cid-sz7xmlte="true" data-icon="fa6-brands:creative-commons-by">   <symbol id="ai:fa6-brands:creative-commons-by" viewBox="0 0 496 512"><path fill="currentColor" d="M314.9 194.4v101.4h-28.3v120.5h-77.1V295.9h-28.3V194.4c0-4.4 1.6-8.2 4.6-11.3c3.1-3.1 6.9-4.7 11.3-4.7H299c4.1 0 7.8 1.6 11.1 4.7c3.1 3.2 4.8 6.9 4.8 11.3m-101.5-63.7c0-23.3 11.5-35 34.5-35s34.5 11.7 34.5 35q0 34.5-34.5 34.5c-34.5 0-34.5-11.5-34.5-34.5M247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8m.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3"/></symbol><use href="#ai:fa6-brands:creative-commons-by"></use>  </svg> </a>  </div>  </div>  </body></html> 