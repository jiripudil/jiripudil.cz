<!DOCTYPE html><html lang="en"> <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><title>Your application needs a clock – Blog – Jiří Pudil</title><style>.body[data-astro-cid-relfimn4]{padding:1.5rem 0}h1[data-astro-cid-relfimn4]{text-wrap:balance}.metadata[data-astro-cid-relfimn4]{display:flex;align-items:start;justify-content:space-between;gap:1rem;margin-bottom:3rem;ul{margin:0;padding:0;list-style:none;display:flex;flex-wrap:wrap;gap:0 .5rem;font-size:.9rem;a{color:var(--body-diminished-color);&:hover{color:var(--body-text-color)}}}time{flex-shrink:0;color:var(--body-diminished-color)}}.perex[data-astro-cid-relfimn4]{font-size:1.15rem}.content[data-astro-cid-relfimn4]{h2{margin-top:3rem}h3{margin-top:2.25rem}p{text-wrap:pretty;hyphens:auto}:is(ul,ol) li{line-height:1.6;margin-bottom:.5rem}blockquote{position:relative;&:before{content:"“";position:absolute;left:-2.25rem;top:0;color:var(--body-accent-color);font-size:4rem}}img{max-width:100%;height:auto}iframe{max-width:100%;aspect-ratio:16 / 9}code{hyphens:none}.astro-code{margin:.5rem 0;padding:.5rem;font-size:.9rem;tab-size:4}}.comments[data-astro-cid-relfimn4]{margin-top:3rem}@media (max-width: 40rem){.metadata[data-astro-cid-relfimn4]{flex-direction:column;align-items:start;justify-content:start}}
</style><link rel="stylesheet" href="/_astro/about.BrkH-_VM.css"><meta name="generator" content="Astro v5.7.8"><meta name="theme-color" content="#fff" media="(prefers-color-scheme: light)"><meta name="theme-color" content="#242428" media="(prefers-color-scheme: dark)"><link rel="sitemap" href="/sitemap-index.xml"><link rel="alternate" type="application/rss+xml" title="Blog – Jiří Pudil" href="/blog/rss.xml"><link rel="alternate" type="application/rss+xml" title="Notes – Jiří Pudil" href="/notes/rss.xml"><link rel="webmention" href="https://webmention.io/jiripudil.cz/webmention"><meta name="google-site-verification" content="7fHBkeNq7LXO24W8IjCc37NT9MX-6RJxD3Co5F-bRQw"><meta property="og:site_name" content="Jiří Pudil"><meta property="og:title" content="Your application needs a clock – Blog"><meta property="og:type" content="article"><meta property="article:published_time" content="2022-03-10T09:00:00.000Z"><meta property="article:tag" content="clock"><meta property="article:tag" content="datetime"><meta property="article:tag" content="php"><meta property="article:tag" content="software-architecture"><meta property="article:tag" content="time"><link rel="manifest" href="/manifest.webmanifest"><meta name="mobile-web-app-capable" content="yes"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#fff"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#000"><meta name="application-name" content="Jiří Pudil"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-precomposed.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#fff"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="apple-mobile-web-app-title" content="Jiří Pudil"><link rel="icon" type="image/x-icon" href="/favicon.ico"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="48x48" href="/favicon-48x48.png"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><meta name="msapplication-TileColor" content="#fff"><meta name="msapplication-TileImage" content="/mstile-144x144.png"><meta name="msapplication-config" content="/browserconfig.xml"><link rel="yandex-tableau-widget" href="/yandex-browser-manifest.json"></head> <body> <div class="header" data-astro-cid-3ef6ksr2> <div class="container" data-astro-cid-d6puh33w>  <nav class="menu" data-astro-cid-3ef6ksr2> <ul data-astro-cid-3ef6ksr2> <li class="name" data-astro-cid-3ef6ksr2> <a href="/" title="Home" data-astro-cid-3ef6ksr2>
Jiří Pudil
</a> </li> <li data-astro-cid-3ef6ksr2> <a href="/about" data-astro-cid-3ef6ksr2>
About
</a> </li> <li data-astro-cid-3ef6ksr2> <a href="/projects" data-astro-cid-3ef6ksr2>
Projects
</a> </li> <li data-astro-cid-3ef6ksr2> <a href="/blog" class="active" data-astro-cid-3ef6ksr2>
Blog
</a> </li> <li data-astro-cid-3ef6ksr2> <a href="/notes" data-astro-cid-3ef6ksr2>
Notes
</a> </li> <li data-astro-cid-3ef6ksr2> <a href="/talks" data-astro-cid-3ef6ksr2>
Talks
</a> </li> </ul> </nav>  </div>  </div>    <div class="container" data-astro-cid-d6puh33w>  <div class="body" data-astro-cid-relfimn4> <h1 data-astro-cid-relfimn4>Your application needs a clock</h1> <div class="metadata" data-astro-cid-relfimn4> <ul data-astro-cid-relfimn4> <li data-astro-cid-relfimn4><a href="/blog/tag/clock" data-astro-cid-relfimn4>#clock</a></li><li data-astro-cid-relfimn4><a href="/blog/tag/datetime" data-astro-cid-relfimn4>#datetime</a></li><li data-astro-cid-relfimn4><a href="/blog/tag/php" data-astro-cid-relfimn4>#php</a></li><li data-astro-cid-relfimn4><a href="/blog/tag/software-architecture" data-astro-cid-relfimn4>#software-architecture</a></li><li data-astro-cid-relfimn4><a href="/blog/tag/time" data-astro-cid-relfimn4>#time</a></li> </ul> <time datetime="2022-03-10T09:00:00.000Z" data-astro-cid-relfimn4> Mar 10, 2022 </time> </div> <p class="perex" data-astro-cid-relfimn4>Previously, I've discussed working with date and time values both server- and client-side, and I've covered storing temporal data in databases. This time, we're going to talk about telling time.</p> <div class="content" data-astro-cid-relfimn4> <blockquote>
<p>This is the last installment in a series of posts about handling date and time in web applications:</p>
<ol>
<li><a href="/blog/beyond-datetime-domain-driven-approach">Beyond DateTime: a domain-driven approach to date and time</a></li>
<li><a href="/blog/beyond-date">Beyond Date: bulletproof date and time API in JavaScript</a></li>
<li><a href="/blog/storing-dates-times-in-databases-painlessly">Storing dates and times in databases: the painless way</a></li>
<li><strong>Your application needs a clock</strong></li>
</ol>
</blockquote>
<p>Being able to tell the current time is necessary on many places throughout your application, whether you’re just storing that an order has been submitted right now, or you need to check if an invitation hasn’t expired by now, or you’re evaluating if some conditions apply now (such as happy hours), you need to know the value of <em>now</em>.</p>
<p>If you’ve taken a look through the API of <code>brick/date-time</code> classes, you’ve probably discovered that most of them provide a method called <code>now()</code>. Let’s say every branch of our restaurant chain provides a happy-hours discount between 5 and 6:30 p.m. in its respective time zone:</p>
<pre class="astro-code astro-code-themes OneLight OneDark" style="background-color:#FAFAFA;--shiki-dark-bg:#282C34;color:#383A42;--shiki-dark:#ABB2BF; overflow-x: auto;" tabindex="0" data-language="php"><code><span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">class</span><span style="color:#C18401;--shiki-dark:#E5C07B"> Branch</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">{</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">    public</span><span style="color:#A626A4;--shiki-dark:#C678DD"> function</span><span style="color:#0184BC;--shiki-dark:#56B6C2"> __construct</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">        private</span><span style="color:#A626A4;--shiki-dark:#C678DD"> readonly</span><span style="color:#C18401;--shiki-dark:#E5C07B"> TimeZone</span><span style="color:#E45649;--shiki-dark:#E06C75"> $timeZone</span><span style="color:#383A42;--shiki-dark:#ABB2BF">,</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">    ) {}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">    public</span><span style="color:#A626A4;--shiki-dark:#C678DD"> function</span><span style="color:#4078F2;--shiki-dark:#61AFEF"> isHappyHours</span><span style="color:#383A42;--shiki-dark:#ABB2BF">()</span><span style="color:#383A42;--shiki-dark:#C678DD">:</span><span style="color:#A626A4;--shiki-dark:#C678DD"> bool</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">    {</span></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">        $time</span><span style="color:#383A42;--shiki-dark:#C678DD"> =</span><span style="color:#C18401;--shiki-dark:#E5C07B"> LocalTime</span><span style="color:#383A42;--shiki-dark:#C678DD">::</span><span style="color:#4078F2;--shiki-dark:#61AFEF">now</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#E45649;--shiki-dark:#E06C75">$this</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#E45649;--shiki-dark:#E06C75">timeZone</span><span style="color:#383A42;--shiki-dark:#ABB2BF">);</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">        return</span><span style="color:#E45649;--shiki-dark:#E06C75"> $time</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">isAfterOrEqualTo</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#C18401;--shiki-dark:#E5C07B">LocalTime</span><span style="color:#383A42;--shiki-dark:#C678DD">::</span><span style="color:#4078F2;--shiki-dark:#61AFEF">of</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#986801;--shiki-dark:#D19A66">17</span><span style="color:#383A42;--shiki-dark:#ABB2BF">, </span><span style="color:#986801;--shiki-dark:#D19A66">00</span><span style="color:#383A42;--shiki-dark:#ABB2BF">))</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#C678DD">            &#x26;&#x26;</span><span style="color:#E45649;--shiki-dark:#E06C75"> $time</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">isBefore</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#C18401;--shiki-dark:#E5C07B">LocalTime</span><span style="color:#383A42;--shiki-dark:#C678DD">::</span><span style="color:#4078F2;--shiki-dark:#61AFEF">of</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#986801;--shiki-dark:#D19A66">18</span><span style="color:#383A42;--shiki-dark:#ABB2BF">, </span><span style="color:#986801;--shiki-dark:#D19A66">30</span><span style="color:#383A42;--shiki-dark:#ABB2BF">));</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">}</span></span></code></pre>
<p>At first glance, there’s nothing bad in this code. Except there is.</p>
<p>If you delve deeper, you notice that the <code>now()</code> method has an optional parameter: <code>$clock</code>. If you don’t provide one, the library fetches the default one by calling <code>DefaultClock::get()</code>. <code>DefaultClock</code> is a non-instantiable class that gives back whatever you configure to be the default clock, even at runtime. It is a static global provider of a clock.</p>
<p>By relying on such static state in your code, you essentially give up control over the implementation and its outcome. Solely by looking at the code, you can never tell what kind of clock you get, and whether <code>now()</code> is actually <em>now</em>. The configuration of the clock is unpredictable: a single rogue <code>DefaultClock::set()</code> buried on the opposite end of the codebase can break your method if it gets called at an unfortunate time.</p>
<p>After all, relying on a static global provider of current time brings the exact same issue as relying on <em>anything</em> static and global: it hides the dependency. If your code depends on a clock, it should declare the dependency, proudly and explicitly. It’s the principle of dependency injection: be open about what you need, and let it be <a href="/blog/di-services-do-not-need-names">someone else’s problem to fetch it</a>.</p>
<p>The method should look like this instead:</p>
<pre class="astro-code astro-code-themes OneLight OneDark" style="background-color:#FAFAFA;--shiki-dark-bg:#282C34;color:#383A42;--shiki-dark:#ABB2BF; overflow-x: auto;" tabindex="0" data-language="php"><code><span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">class</span><span style="color:#C18401;--shiki-dark:#E5C07B"> Branch</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">{</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">    public</span><span style="color:#A626A4;--shiki-dark:#C678DD"> function</span><span style="color:#0184BC;--shiki-dark:#56B6C2"> __construct</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">        private</span><span style="color:#A626A4;--shiki-dark:#C678DD"> readonly</span><span style="color:#C18401;--shiki-dark:#E5C07B"> TimeZone</span><span style="color:#E45649;--shiki-dark:#E06C75"> $timeZone</span><span style="color:#383A42;--shiki-dark:#ABB2BF">,</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">    ) {}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">    public</span><span style="color:#A626A4;--shiki-dark:#C678DD"> function</span><span style="color:#4078F2;--shiki-dark:#61AFEF"> isHappyHours</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#C18401;--shiki-dark:#E5C07B">Clock</span><span style="color:#E45649;--shiki-dark:#E06C75"> $clock</span><span style="color:#383A42;--shiki-dark:#ABB2BF">)</span><span style="color:#383A42;--shiki-dark:#C678DD">:</span><span style="color:#A626A4;--shiki-dark:#C678DD"> bool</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">    {</span></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">        $time</span><span style="color:#383A42;--shiki-dark:#C678DD"> =</span><span style="color:#C18401;--shiki-dark:#E5C07B"> LocalTime</span><span style="color:#383A42;--shiki-dark:#C678DD">::</span><span style="color:#4078F2;--shiki-dark:#61AFEF">now</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#E45649;--shiki-dark:#E06C75">$this</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#E45649;--shiki-dark:#E06C75">timeZone</span><span style="color:#383A42;--shiki-dark:#ABB2BF">, </span><span style="color:#E45649;--shiki-dark:#E06C75">$clock</span><span style="color:#383A42;--shiki-dark:#ABB2BF">);</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">        return</span><span style="color:#E45649;--shiki-dark:#E06C75"> $time</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">isAfterOrEqualTo</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#C18401;--shiki-dark:#E5C07B">LocalTime</span><span style="color:#383A42;--shiki-dark:#C678DD">::</span><span style="color:#4078F2;--shiki-dark:#61AFEF">of</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#986801;--shiki-dark:#D19A66">17</span><span style="color:#383A42;--shiki-dark:#ABB2BF">, </span><span style="color:#986801;--shiki-dark:#D19A66">00</span><span style="color:#383A42;--shiki-dark:#ABB2BF">))</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#C678DD">            &#x26;&#x26;</span><span style="color:#E45649;--shiki-dark:#E06C75"> $time</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">isBefore</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#C18401;--shiki-dark:#E5C07B">LocalTime</span><span style="color:#383A42;--shiki-dark:#C678DD">::</span><span style="color:#4078F2;--shiki-dark:#61AFEF">of</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#986801;--shiki-dark:#D19A66">18</span><span style="color:#383A42;--shiki-dark:#ABB2BF">, </span><span style="color:#986801;--shiki-dark:#D19A66">30</span><span style="color:#383A42;--shiki-dark:#ABB2BF">));</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">}</span></span></code></pre>
<p>When you look at this code, you instantly see where the clock comes from. It is no longer hidden in a global static hellhole. You can search for the usages of the method and see that your application uses a <code>SystemClock</code>:</p>
<pre class="astro-code astro-code-themes OneLight OneDark" style="background-color:#FAFAFA;--shiki-dark-bg:#282C34;color:#383A42;--shiki-dark:#ABB2BF; overflow-x: auto;" tabindex="0" data-language="php"><code><span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">if</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> (</span><span style="color:#E45649;--shiki-dark:#E06C75">$branch</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">isHappyHours</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#A626A4;--shiki-dark:#C678DD">new</span><span style="color:#C18401;--shiki-dark:#E5C07B"> SystemClock</span><span style="color:#383A42;--shiki-dark:#ABB2BF">())) {</span></span>
<span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic">    // apply 10% discount</span></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">    $totalPrice</span><span style="color:#383A42;--shiki-dark:#C678DD"> =</span><span style="color:#E45649;--shiki-dark:#E06C75"> $totalPrice</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">multipliedBy</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#50A14F;--shiki-dark:#98C379">'0.9'</span><span style="color:#383A42;--shiki-dark:#ABB2BF">);</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">}</span></span></code></pre>
<p>This is not even the final form yet, but let’s stop there for a while. Even this tiny change gives you an immediate benefit: the code is now much easier to cover by tests. The method now depends on an abstraction of a clock, so you can easily – and transparently – set up and use a mock implementation in the test case:</p>
<pre class="astro-code astro-code-themes OneLight OneDark" style="background-color:#FAFAFA;--shiki-dark-bg:#282C34;color:#383A42;--shiki-dark:#ABB2BF; overflow-x: auto;" tabindex="0" data-language="php"><code><span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">final</span><span style="color:#A626A4;--shiki-dark:#C678DD"> class</span><span style="color:#C18401;--shiki-dark:#E5C07B"> BranchTest</span><span style="color:#A626A4;--shiki-dark:#C678DD"> extends</span><span style="color:#C18401;--shiki-dark:#E5C07B"> TestCase</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">{</span></span>
<span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic">    /** @dataProvider provideHappyHoursData */</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">    public</span><span style="color:#A626A4;--shiki-dark:#C678DD"> function</span><span style="color:#4078F2;--shiki-dark:#61AFEF"> testHappyHours</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#C18401;--shiki-dark:#E5C07B">ZonedDateTime</span><span style="color:#E45649;--shiki-dark:#E06C75"> $now</span><span style="color:#383A42;--shiki-dark:#ABB2BF">, </span><span style="color:#A626A4;--shiki-dark:#C678DD">bool</span><span style="color:#E45649;--shiki-dark:#E06C75"> $expectedResult</span><span style="color:#383A42;--shiki-dark:#ABB2BF">)</span><span style="color:#383A42;--shiki-dark:#C678DD">:</span><span style="color:#A626A4;--shiki-dark:#C678DD"> void</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">    {</span></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">        $branch</span><span style="color:#383A42;--shiki-dark:#C678DD"> =</span><span style="color:#A626A4;--shiki-dark:#C678DD"> new</span><span style="color:#C18401;--shiki-dark:#E5C07B"> Branch</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#E45649;--shiki-dark:#E06C75">$now</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">getTimeZone</span><span style="color:#383A42;--shiki-dark:#ABB2BF">());</span></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">        $clock</span><span style="color:#383A42;--shiki-dark:#C678DD"> =</span><span style="color:#C18401;--shiki-dark:#E5C07B"> FixedClock</span><span style="color:#383A42;--shiki-dark:#C678DD">::</span><span style="color:#4078F2;--shiki-dark:#61AFEF">of</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#E45649;--shiki-dark:#E06C75">$now</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">getInstant</span><span style="color:#383A42;--shiki-dark:#ABB2BF">());</span></span>
<span class="line"><span style="color:#C18401;--shiki-dark:#E5C07B">        Assert</span><span style="color:#383A42;--shiki-dark:#C678DD">::</span><span style="color:#4078F2;--shiki-dark:#61AFEF">same</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#E45649;--shiki-dark:#E06C75">$expectedResult</span><span style="color:#383A42;--shiki-dark:#ABB2BF">, </span><span style="color:#E45649;--shiki-dark:#E06C75">$branch</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">isHappyHours</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#E45649;--shiki-dark:#E06C75">$clock</span><span style="color:#383A42;--shiki-dark:#ABB2BF">));</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">    protected</span><span style="color:#A626A4;--shiki-dark:#C678DD"> function</span><span style="color:#4078F2;--shiki-dark:#61AFEF"> provideHappyHoursData</span><span style="color:#383A42;--shiki-dark:#ABB2BF">()</span><span style="color:#383A42;--shiki-dark:#C678DD">:</span><span style="color:#A626A4;--shiki-dark:#C678DD"> iterable</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">    {</span></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">        $timeZone</span><span style="color:#383A42;--shiki-dark:#C678DD"> =</span><span style="color:#C18401;--shiki-dark:#E5C07B"> TimeZone</span><span style="color:#383A42;--shiki-dark:#C678DD">::</span><span style="color:#4078F2;--shiki-dark:#61AFEF">utc</span><span style="color:#383A42;--shiki-dark:#ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">        yield</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> [</span><span style="color:#C18401;--shiki-dark:#E5C07B">ZonedDateTime</span><span style="color:#383A42;--shiki-dark:#C678DD">::</span><span style="color:#4078F2;--shiki-dark:#61AFEF">of</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#C18401;--shiki-dark:#E5C07B">LocalDateTime</span><span style="color:#383A42;--shiki-dark:#C678DD">::</span><span style="color:#4078F2;--shiki-dark:#61AFEF">of</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#986801;--shiki-dark:#D19A66">2021</span><span style="color:#383A42;--shiki-dark:#ABB2BF">, </span><span style="color:#986801;--shiki-dark:#D19A66">10</span><span style="color:#383A42;--shiki-dark:#ABB2BF">, </span><span style="color:#986801;--shiki-dark:#D19A66">12</span><span style="color:#383A42;--shiki-dark:#ABB2BF">, </span><span style="color:#986801;--shiki-dark:#D19A66">12</span><span style="color:#383A42;--shiki-dark:#ABB2BF">, </span><span style="color:#986801;--shiki-dark:#D19A66">0</span><span style="color:#383A42;--shiki-dark:#ABB2BF">), </span><span style="color:#E45649;--shiki-dark:#E06C75">$timeZone</span><span style="color:#383A42;--shiki-dark:#ABB2BF">), </span><span style="color:#986801;--shiki-dark:#D19A66">false</span><span style="color:#383A42;--shiki-dark:#ABB2BF">];</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">        yield</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> [</span><span style="color:#C18401;--shiki-dark:#E5C07B">ZonedDateTime</span><span style="color:#383A42;--shiki-dark:#C678DD">::</span><span style="color:#4078F2;--shiki-dark:#61AFEF">of</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#C18401;--shiki-dark:#E5C07B">LocalDateTime</span><span style="color:#383A42;--shiki-dark:#C678DD">::</span><span style="color:#4078F2;--shiki-dark:#61AFEF">of</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#986801;--shiki-dark:#D19A66">2021</span><span style="color:#383A42;--shiki-dark:#ABB2BF">, </span><span style="color:#986801;--shiki-dark:#D19A66">10</span><span style="color:#383A42;--shiki-dark:#ABB2BF">, </span><span style="color:#986801;--shiki-dark:#D19A66">12</span><span style="color:#383A42;--shiki-dark:#ABB2BF">, </span><span style="color:#986801;--shiki-dark:#D19A66">17</span><span style="color:#383A42;--shiki-dark:#ABB2BF">, </span><span style="color:#986801;--shiki-dark:#D19A66">30</span><span style="color:#383A42;--shiki-dark:#ABB2BF">), </span><span style="color:#E45649;--shiki-dark:#E06C75">$timeZone</span><span style="color:#383A42;--shiki-dark:#ABB2BF">), </span><span style="color:#986801;--shiki-dark:#D19A66">true</span><span style="color:#383A42;--shiki-dark:#ABB2BF">];</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">        yield</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> [</span><span style="color:#C18401;--shiki-dark:#E5C07B">ZonedDateTime</span><span style="color:#383A42;--shiki-dark:#C678DD">::</span><span style="color:#4078F2;--shiki-dark:#61AFEF">of</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#C18401;--shiki-dark:#E5C07B">LocalDateTime</span><span style="color:#383A42;--shiki-dark:#C678DD">::</span><span style="color:#4078F2;--shiki-dark:#61AFEF">of</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#986801;--shiki-dark:#D19A66">2021</span><span style="color:#383A42;--shiki-dark:#ABB2BF">, </span><span style="color:#986801;--shiki-dark:#D19A66">10</span><span style="color:#383A42;--shiki-dark:#ABB2BF">, </span><span style="color:#986801;--shiki-dark:#D19A66">12</span><span style="color:#383A42;--shiki-dark:#ABB2BF">, </span><span style="color:#986801;--shiki-dark:#D19A66">20</span><span style="color:#383A42;--shiki-dark:#ABB2BF">, </span><span style="color:#986801;--shiki-dark:#D19A66">0</span><span style="color:#383A42;--shiki-dark:#ABB2BF">), </span><span style="color:#E45649;--shiki-dark:#E06C75">$timeZone</span><span style="color:#383A42;--shiki-dark:#ABB2BF">), </span><span style="color:#986801;--shiki-dark:#D19A66">false</span><span style="color:#383A42;--shiki-dark:#ABB2BF">];</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">}</span></span></code></pre>
<p>We’ve got unit tests covered, but what if we want to add integration tests? We should go even further with the propagation of the dependency: there shouldn’t even be a single <code>new SystemClock()</code> in your application code. You should declare <code>Clock</code> as a dependency everywhere you need to be able to tell time, so that you can always configure a mock when you need to test a larger unit of code.</p>
<p>Eventually, at the top of the chain, you should configure the clock of choice in your dependency injection container, so that your application has a single source of truth when it comes to time-telling:</p>
<pre class="astro-code astro-code-themes OneLight OneDark" style="background-color:#FAFAFA;--shiki-dark-bg:#282C34;color:#383A42;--shiki-dark:#ABB2BF; overflow-x: auto;" tabindex="0" data-language="neon"><code><span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">services</span><span style="color:#383A42;--shiki-dark:#ABB2BF">:</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">	- </span><span style="color:#E45649;--shiki-dark:#E06C75">type</span><span style="color:#383A42;--shiki-dark:#ABB2BF">: </span><span style="color:#50A14F;--shiki-dark:#98C379">Brick\DateTime\Clock</span></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">	  factory</span><span style="color:#383A42;--shiki-dark:#ABB2BF">: </span><span style="color:#50A14F;--shiki-dark:#98C379">Brick\DateTime\Clock\SystemClock</span></span></code></pre>
<p>The choice of the right implementation is yours. Most of the time, I believe it makes sense to use the current time as reported by the operating system. But if, for example, your users are competing over a limited resource on the first-come, first-served basis, you might want to use a clock fixed to <code>$_SERVER['REQUEST_TIME']</code> to eliminate any infrastructure I/O latencies and keep the game fair.</p>
<p>If – and only if – you make thorough use of dependency injection, it is incredibly easy to switch the implementation of the clock, or even provide different clocks to different services based on their purpose and needs.</p>
<p>You might even encounter various third-party packages that expect some sort of a current time provider. Almost five years ago, I’ve argued about why <a href="/blog/clock-needs-an-interface">we need a clock abstraction</a>. Unfortunately, using <code>brick/date-time</code> and its clock doesn’t solve the problem from the original post: you still need to write wrappers and adapters for the clock interfaces of third-party packages.</p>
<p>In fact, you would need to write adapters even if there was some kind of a standard, because it would very likely be built upon PHP’s standard library and its <code>DateTime</code>. The only way out of this would be if a more robust date-and-time API replaced <code>DateTime</code> in the standard library, as is going to be the case with <a href="https://github.com/tc39/proposal-temporal">JavaScript</a>.</p>
<p>But let’s be grateful that despite the absence of an interoperable abstraction, more and more project maintainers are aware of the need of a clock, and that we can therefore have a truly single, reliable source of <em>now</em> in our applications.</p> </div> <div class="comments" data-astro-cid-relfimn4> <div id="giscus-container"></div> <script type="module">const t=document.createElement("script");t.src="https://giscus.app/client.js";t.crossOrigin="anonymous";t.async=!0;t.setAttribute("data-repo","jiripudil/jiripudil.cz");t.setAttribute("data-repo-id","MDEwOlJlcG9zaXRvcnkyNTI5NzY3Nw==");t.setAttribute("data-category","Blog discussions");t.setAttribute("data-category-id","DIC_kwDOAYIDDc4CAfUM");t.setAttribute("data-mapping","og:title");t.setAttribute("data-reactions-enabled","1");t.setAttribute("data-emit-metadata","0");t.setAttribute("data-theme","preferred_color_scheme");t.setAttribute("data-lang","en");t.setAttribute("data-loading","lazy");const e=document.getElementById("giscus-container");e.appendChild(t);</script> </div> </div>  </div>   <div class="footer" data-astro-cid-sz7xmlte> <div class="container" data-astro-cid-d6puh33w> 
Content licensed under
<a href="https://creativecommons.org/licenses/by/4.0/" title="Creative Commons Attribution 4.0 International" aria-label="Creative Commons Attribution 4.0 International" data-astro-cid-sz7xmlte> <svg width="0.97em" height="1em" data-astro-cid-sz7xmlte="true" data-icon="fa6-brands:creative-commons">   <symbol id="ai:fa6-brands:creative-commons" viewBox="0 0 496 512"><path fill="currentColor" d="m245.83 214.87l-33.22 17.28c-9.43-19.58-25.24-19.93-27.46-19.93c-22.13 0-33.22 14.61-33.22 43.84c0 23.57 9.21 43.84 33.22 43.84c14.47 0 24.65-7.09 30.57-21.26l30.55 15.5c-6.17 11.51-25.69 38.98-65.1 38.98c-22.6 0-73.96-10.32-73.96-77.05c0-58.69 43-77.06 72.63-77.06c30.72-.01 52.7 11.95 65.99 35.86m143.05 0l-32.78 17.28c-9.5-19.77-25.72-19.93-27.9-19.93c-22.14 0-33.22 14.61-33.22 43.84c0 23.55 9.23 43.84 33.22 43.84c14.45 0 24.65-7.09 30.54-21.26l31 15.5c-2.1 3.75-21.39 38.98-65.09 38.98c-22.69 0-73.96-9.87-73.96-77.05c0-58.67 42.97-77.06 72.63-77.06c30.71-.01 52.58 11.95 65.56 35.86M247.56 8.05C104.74 8.05 0 123.11 0 256.05c0 138.49 113.6 248 247.56 248c129.93 0 248.44-100.87 248.44-248c0-137.87-106.62-248-248.44-248m.87 450.81c-112.54 0-203.7-93.04-203.7-202.81c0-105.42 85.43-203.27 203.72-203.27c112.53 0 202.82 89.46 202.82 203.26c-.01 121.69-99.68 202.82-202.84 202.82"/></symbol><use href="#ai:fa6-brands:creative-commons"></use>  </svg> <svg width="0.97em" height="1em" data-astro-cid-sz7xmlte="true" data-icon="fa6-brands:creative-commons-by">   <symbol id="ai:fa6-brands:creative-commons-by" viewBox="0 0 496 512"><path fill="currentColor" d="M314.9 194.4v101.4h-28.3v120.5h-77.1V295.9h-28.3V194.4c0-4.4 1.6-8.2 4.6-11.3c3.1-3.1 6.9-4.7 11.3-4.7H299c4.1 0 7.8 1.6 11.1 4.7c3.1 3.2 4.8 6.9 4.8 11.3m-101.5-63.7c0-23.3 11.5-35 34.5-35s34.5 11.7 34.5 35q0 34.5-34.5 34.5c-34.5 0-34.5-11.5-34.5-34.5M247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8m.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3"/></symbol><use href="#ai:fa6-brands:creative-commons-by"></use>  </svg> </a>  </div>  </div>  </body></html> 