<!DOCTYPE html><html lang="en"> <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><title>What&#39;s new in Naja 1.1.0 – Blog – Jiří Pudil</title><style>.body[data-astro-cid-relfimn4]{padding:1.5rem 0}h1[data-astro-cid-relfimn4]{text-wrap:balance}.metadata[data-astro-cid-relfimn4]{display:flex;align-items:start;justify-content:space-between;gap:1rem;margin-bottom:3rem;ul{margin:0;padding:0;list-style:none;display:flex;flex-wrap:wrap;gap:0 .5rem;font-size:.9rem;a{color:var(--body-diminished-color);&:hover{color:var(--body-text-color)}}}time{flex-shrink:0;color:var(--body-diminished-color)}}.perex[data-astro-cid-relfimn4]{font-size:1.15rem}.content[data-astro-cid-relfimn4]{h2{margin-top:3rem}h3{margin-top:2.25rem}p{text-wrap:pretty;hyphens:auto}:is(ul,ol) li{line-height:1.6;margin-bottom:.5rem}blockquote{position:relative;&:before{content:"“";position:absolute;left:-2.25rem;top:0;color:var(--body-accent-color);font-size:4rem}}img{max-width:100%;height:auto}iframe{max-width:100%;aspect-ratio:16 / 9}code{hyphens:none}.astro-code{margin:.5rem 0;padding:.5rem;font-size:.9rem;tab-size:4}}.comments[data-astro-cid-relfimn4]{margin-top:3rem}@media (max-width: 40rem){.metadata[data-astro-cid-relfimn4]{flex-direction:column;align-items:start;justify-content:start}}
</style><link rel="stylesheet" href="/_astro/about.BrkH-_VM.css"><meta name="generator" content="Astro v5.7.8"><meta name="theme-color" content="#fff" media="(prefers-color-scheme: light)"><meta name="theme-color" content="#242428" media="(prefers-color-scheme: dark)"><link rel="sitemap" href="/sitemap-index.xml"><link rel="alternate" type="application/rss+xml" title="Blog – Jiří Pudil" href="/blog/rss.xml"><link rel="alternate" type="application/rss+xml" title="Notes – Jiří Pudil" href="/notes/rss.xml"><link rel="webmention" href="https://webmention.io/jiripudil.cz/webmention"><meta name="google-site-verification" content="7fHBkeNq7LXO24W8IjCc37NT9MX-6RJxD3Co5F-bRQw"><meta property="og:site_name" content="Jiří Pudil"><meta property="og:title" content="What's new in Naja 1.1.0 – Blog"><meta property="og:type" content="article"><meta property="article:published_time" content="2017-10-27T19:08:00.000Z"><meta property="article:tag" content="ajax"><meta property="article:tag" content="frontend"><meta property="article:tag" content="javascript"><meta property="article:tag" content="naja"><meta property="article:tag" content="nettefw"><meta property="article:tag" content="open-source"><meta property="article:tag" content="testing"><link rel="manifest" href="/manifest.webmanifest"><meta name="mobile-web-app-capable" content="yes"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#fff"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#000"><meta name="application-name" content="Jiří Pudil"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-precomposed.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#fff"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="apple-mobile-web-app-title" content="Jiří Pudil"><link rel="icon" type="image/x-icon" href="/favicon.ico"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="48x48" href="/favicon-48x48.png"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><meta name="msapplication-TileColor" content="#fff"><meta name="msapplication-TileImage" content="/mstile-144x144.png"><meta name="msapplication-config" content="/browserconfig.xml"><link rel="yandex-tableau-widget" href="/yandex-browser-manifest.json"></head> <body> <div class="header" data-astro-cid-3ef6ksr2> <div class="container" data-astro-cid-d6puh33w>  <nav class="menu" data-astro-cid-3ef6ksr2> <ul data-astro-cid-3ef6ksr2> <li class="name" data-astro-cid-3ef6ksr2> <a href="/" title="Home" data-astro-cid-3ef6ksr2>
Jiří Pudil
</a> </li> <li data-astro-cid-3ef6ksr2> <a href="/about" data-astro-cid-3ef6ksr2>
About
</a> </li> <li data-astro-cid-3ef6ksr2> <a href="/projects" data-astro-cid-3ef6ksr2>
Projects
</a> </li> <li data-astro-cid-3ef6ksr2> <a href="/blog" class="active" data-astro-cid-3ef6ksr2>
Blog
</a> </li> <li data-astro-cid-3ef6ksr2> <a href="/notes" data-astro-cid-3ef6ksr2>
Notes
</a> </li> <li data-astro-cid-3ef6ksr2> <a href="/talks" data-astro-cid-3ef6ksr2>
Talks
</a> </li> </ul> </nav>  </div>  </div>    <div class="container" data-astro-cid-d6puh33w>  <div class="body" data-astro-cid-relfimn4> <h1 data-astro-cid-relfimn4>What&#39;s new in Naja 1.1.0</h1> <div class="metadata" data-astro-cid-relfimn4> <ul data-astro-cid-relfimn4> <li data-astro-cid-relfimn4><a href="/blog/tag/ajax" data-astro-cid-relfimn4>#ajax</a></li><li data-astro-cid-relfimn4><a href="/blog/tag/frontend" data-astro-cid-relfimn4>#frontend</a></li><li data-astro-cid-relfimn4><a href="/blog/tag/javascript" data-astro-cid-relfimn4>#javascript</a></li><li data-astro-cid-relfimn4><a href="/blog/tag/naja" data-astro-cid-relfimn4>#naja</a></li><li data-astro-cid-relfimn4><a href="/blog/tag/nettefw" data-astro-cid-relfimn4>#nettefw</a></li><li data-astro-cid-relfimn4><a href="/blog/tag/open-source" data-astro-cid-relfimn4>#open-source</a></li><li data-astro-cid-relfimn4><a href="/blog/tag/testing" data-astro-cid-relfimn4>#testing</a></li> </ul> <time datetime="2017-10-27T19:08:00.000Z" data-astro-cid-relfimn4> Oct 27, 2017 </time> </div> <p class="perex" data-astro-cid-relfimn4>In the course of the last few weeks, I have invested some time into Naja. You might recall my previous announcement in which I stated that there was still one big thing left to do. Well, now it is done!</p> <div class="content" data-astro-cid-relfimn4> <h2 id="the-small-steps">The small steps</h2>
<p>But let me first go through the list of small changes that I’ve done:</p>
<h3 id="proper-promise-resolutionrejection">Proper promise resolution/rejection</h3>
<p>While <code>makeRequest()</code> <em>did</em> return a promise, it was somewhat useless, as it carried no information about the
request; not even whether it was successful. That is no longer true: the returned promise is now resolved with
the parsed response body, or rejected with the thrown error.</p>
<p>Now if you dispatch the request manually, you can chain custom behavior after the response is processed by Naja:</p>
<pre class="astro-code astro-code-themes OneLight OneDark" style="background-color:#FAFAFA;--shiki-dark-bg:#282C34;color:#383A42;--shiki-dark:#ABB2BF; overflow-x: auto;" tabindex="0" data-language="js"><code><span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">naja.</span><span style="color:#4078F2;--shiki-dark:#61AFEF">makeRequest</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(method, url)</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">	.</span><span style="color:#4078F2;--shiki-dark:#61AFEF">then</span><span style="color:#383A42;--shiki-dark:#ABB2BF">((response) </span><span style="color:#A626A4;--shiki-dark:#C678DD">=></span><span style="color:#383A42;--shiki-dark:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic">		// ...</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">	})</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">	.</span><span style="color:#4078F2;--shiki-dark:#61AFEF">catch</span><span style="color:#383A42;--shiki-dark:#ABB2BF">((error) </span><span style="color:#A626A4;--shiki-dark:#C678DD">=></span><span style="color:#383A42;--shiki-dark:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic">		// ...</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">	});</span></span></code></pre>
<h3 id="aborted-request-is-not-an-error">Aborted request is not an error</h3>
<p>Another change concerns aborted requests. Naja used to (mistakenly) trigger the error handling for aborted requests,
whereas the circumstances that lead to aborting the request do only rarely indicate an erroneous state. Usually it’s
just the user navigating away, or Naja’s UniqueExtension kicking in because another request was dispatched.</p>
<p>Therefore aborted requests no longer trigger <code>error</code> event, and should be processed – if ever needed – in a
specific <code>abort</code> event. Note that aborted requests also trigger the <code>complete</code> event.</p>
<h3 id="history-under-your-control">History under your control</h3>
<p><code>HistoryHandler</code>, a core component responsible for modifying the browser’s history, can now be configured on the
front-end side via a <code>history</code> key in the <code>options</code> object or <code>data-naja-history</code> attribute on the AJAXified element.
By default, Naja pushes a new state to the history, but you can instruct it:</p>
<ul>
<li>to replace the current state instead of pushing a new one, by setting <code>options.history</code> to ‘replace’<code>or  </code>data-naja-history=“replace”`, or</li>
<li>to keep the request off-the-record and not modify the history state at all, by setting <code>options.history</code>
to <code>false</code> or <code>data-naja-history="off"</code>.</li>
</ul>
<h3 id="custom-selector">Custom selector</h3>
<p>Last but not least, the bound selector was hard-coded to <code>.ajax</code>, a default taken from nette.ajax.js library.
To accommodate for a wider range of use cases, the selector can now be changed:</p>
<pre class="astro-code astro-code-themes OneLight OneDark" style="background-color:#FAFAFA;--shiki-dark-bg:#282C34;color:#383A42;--shiki-dark:#ABB2BF; overflow-x: auto;" tabindex="0" data-language="js"><code><span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">naja.</span><span style="color:#E45649;--shiki-dark:#E06C75">uiHandler</span><span style="color:#383A42;--shiki-dark:#ABB2BF">.</span><span style="color:#E45649;--shiki-dark:#E06C75">selector</span><span style="color:#0184BC;--shiki-dark:#56B6C2"> =</span><span style="color:#50A14F;--shiki-dark:#98C379"> '[data-naja]'</span><span style="color:#383A42;--shiki-dark:#ABB2BF">;</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">naja.</span><span style="color:#E45649;--shiki-dark:#E06C75">uiHandler</span><span style="color:#383A42;--shiki-dark:#ABB2BF">.</span><span style="color:#E45649;--shiki-dark:#E06C75">selector</span><span style="color:#0184BC;--shiki-dark:#56B6C2"> =</span><span style="color:#50A14F;--shiki-dark:#98C379"> ':not(.synchronous)'</span><span style="color:#383A42;--shiki-dark:#ABB2BF">;</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">naja.</span><span style="color:#E45649;--shiki-dark:#E06C75">uiHandler</span><span style="color:#383A42;--shiki-dark:#ABB2BF">.</span><span style="color:#E45649;--shiki-dark:#E06C75">selector</span><span style="color:#0184BC;--shiki-dark:#56B6C2"> =</span><span style="color:#50A14F;--shiki-dark:#98C379"> ''</span><span style="color:#383A42;--shiki-dark:#ABB2BF">;</span></span></code></pre>
<p>As you can see, you can easily switch the scheme from opt-in asynchronicity to <em>opt-out</em> asynchronicity, which
gives you far more opportunities to shoot yourself in the foot by dispatching cross-origin AJAX requests (and
believe me, those are tricky).</p>
<p>To alleviate this, UIHandler now checks the target URL and does not dispatch the request asynchronously if it
points to an external resource with a disallowed origin. You can of course configure the allowed origins:</p>
<pre class="astro-code astro-code-themes OneLight OneDark" style="background-color:#FAFAFA;--shiki-dark-bg:#282C34;color:#383A42;--shiki-dark:#ABB2BF; overflow-x: auto;" tabindex="0" data-language="js"><code><span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">naja.</span><span style="color:#E45649;--shiki-dark:#E06C75">uiHandler</span><span style="color:#383A42;--shiki-dark:#ABB2BF">.</span><span style="color:#E45649;--shiki-dark:#E06C75">allowedOrigins</span><span style="color:#383A42;--shiki-dark:#ABB2BF">.</span><span style="color:#4078F2;--shiki-dark:#61AFEF">push</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#50A14F;--shiki-dark:#98C379">'https://trusted.origin.com:4000'</span><span style="color:#383A42;--shiki-dark:#ABB2BF">);</span></span></code></pre>
<p>The current origin is allowed by default, so you can point asynchronous links to absolute URLs as well.</p>
<h2 id="the-big-leap">The big leap</h2>
<p>Now to the big change. It’s funny because it does not much affect the code of Naja itself, but still has a lot
of practical implications: <strong>the tests now run in the browser.</strong></p>
<p>Yes, in the end I’ve managed to make them run in the browser instead of Node. I’ve used
<a href="https://karma-runner.github.io">Karma</a> and set up an OSS account on <a href="https://saucelabs.com">SauceLabs</a> so that
the whole test suite is executed on a wide range of browsers including Internet Explorer and mobile device
simulators, for every push.</p>
<p>I’ve invested a tremendous amount of time into it – something close to a whole weekend and a half – but the benefits
have already outweighed the cost: it has helped me discover a few incompatibilities in quite critical sections
of the code; surprisingly not only with old Internet Explorers, but also recent versions of Safari.</p>
<p>Besides, I’ve learnt so much in the process, which is always a good thing!</p>
<p>I’m really excited about this new release and I hope you will enjoy it as much as I do. Go and give it a try,
it’s just one <code>npm update</code> away :)</p> </div> <div class="comments" data-astro-cid-relfimn4> <div id="giscus-container"></div> <script type="module">const t=document.createElement("script");t.src="https://giscus.app/client.js";t.crossOrigin="anonymous";t.async=!0;t.setAttribute("data-repo","jiripudil/jiripudil.cz");t.setAttribute("data-repo-id","MDEwOlJlcG9zaXRvcnkyNTI5NzY3Nw==");t.setAttribute("data-category","Blog discussions");t.setAttribute("data-category-id","DIC_kwDOAYIDDc4CAfUM");t.setAttribute("data-mapping","og:title");t.setAttribute("data-reactions-enabled","1");t.setAttribute("data-emit-metadata","0");t.setAttribute("data-theme","preferred_color_scheme");t.setAttribute("data-lang","en");t.setAttribute("data-loading","lazy");const e=document.getElementById("giscus-container");e.appendChild(t);</script> </div> </div>  </div>   <div class="footer" data-astro-cid-sz7xmlte> <div class="container" data-astro-cid-d6puh33w> 
Content licensed under
<a href="https://creativecommons.org/licenses/by/4.0/" title="Creative Commons Attribution 4.0 International" aria-label="Creative Commons Attribution 4.0 International" data-astro-cid-sz7xmlte> <svg width="0.97em" height="1em" data-astro-cid-sz7xmlte="true" data-icon="fa6-brands:creative-commons">   <symbol id="ai:fa6-brands:creative-commons" viewBox="0 0 496 512"><path fill="currentColor" d="m245.83 214.87l-33.22 17.28c-9.43-19.58-25.24-19.93-27.46-19.93c-22.13 0-33.22 14.61-33.22 43.84c0 23.57 9.21 43.84 33.22 43.84c14.47 0 24.65-7.09 30.57-21.26l30.55 15.5c-6.17 11.51-25.69 38.98-65.1 38.98c-22.6 0-73.96-10.32-73.96-77.05c0-58.69 43-77.06 72.63-77.06c30.72-.01 52.7 11.95 65.99 35.86m143.05 0l-32.78 17.28c-9.5-19.77-25.72-19.93-27.9-19.93c-22.14 0-33.22 14.61-33.22 43.84c0 23.55 9.23 43.84 33.22 43.84c14.45 0 24.65-7.09 30.54-21.26l31 15.5c-2.1 3.75-21.39 38.98-65.09 38.98c-22.69 0-73.96-9.87-73.96-77.05c0-58.67 42.97-77.06 72.63-77.06c30.71-.01 52.58 11.95 65.56 35.86M247.56 8.05C104.74 8.05 0 123.11 0 256.05c0 138.49 113.6 248 247.56 248c129.93 0 248.44-100.87 248.44-248c0-137.87-106.62-248-248.44-248m.87 450.81c-112.54 0-203.7-93.04-203.7-202.81c0-105.42 85.43-203.27 203.72-203.27c112.53 0 202.82 89.46 202.82 203.26c-.01 121.69-99.68 202.82-202.84 202.82"/></symbol><use href="#ai:fa6-brands:creative-commons"></use>  </svg> <svg width="0.97em" height="1em" data-astro-cid-sz7xmlte="true" data-icon="fa6-brands:creative-commons-by">   <symbol id="ai:fa6-brands:creative-commons-by" viewBox="0 0 496 512"><path fill="currentColor" d="M314.9 194.4v101.4h-28.3v120.5h-77.1V295.9h-28.3V194.4c0-4.4 1.6-8.2 4.6-11.3c3.1-3.1 6.9-4.7 11.3-4.7H299c4.1 0 7.8 1.6 11.1 4.7c3.1 3.2 4.8 6.9 4.8 11.3m-101.5-63.7c0-23.3 11.5-35 34.5-35s34.5 11.7 34.5 35q0 34.5-34.5 34.5c-34.5 0-34.5-11.5-34.5-34.5M247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8m.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3"/></symbol><use href="#ai:fa6-brands:creative-commons-by"></use>  </svg> </a>  </div>  </div>  </body></html> 