<!DOCTYPE html><html lang="en"> <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><title>Blazing fast file upload through Nginx – Blog – Jiří Pudil</title><style>.body[data-astro-cid-relfimn4]{padding:1.5rem 0}h1[data-astro-cid-relfimn4]{text-wrap:balance}.metadata[data-astro-cid-relfimn4]{display:flex;align-items:start;justify-content:space-between;gap:1rem;margin-bottom:3rem;ul{margin:0;padding:0;list-style:none;display:flex;flex-wrap:wrap;gap:0 .5rem;font-size:.9rem;a{color:var(--body-diminished-color);&:hover{color:var(--body-text-color)}}}time{flex-shrink:0;color:var(--body-diminished-color)}}.perex[data-astro-cid-relfimn4]{font-size:1.15rem}.content[data-astro-cid-relfimn4]{h2{margin-top:3rem}h3{margin-top:2.25rem}p{text-wrap:pretty;hyphens:auto}:is(ul,ol) li{line-height:1.6;margin-bottom:.5rem}blockquote{position:relative;&:before{content:"“";position:absolute;left:-2.25rem;top:0;color:var(--body-accent-color);font-size:4rem}}img{max-width:100%;height:auto}iframe{max-width:100%;aspect-ratio:16 / 9}code{hyphens:none}.astro-code{margin:.5rem 0;padding:.5rem;font-size:.9rem;tab-size:4}}.comments[data-astro-cid-relfimn4]{margin-top:3rem}@media (max-width: 40rem){.metadata[data-astro-cid-relfimn4]{flex-direction:column;align-items:start;justify-content:start}}
</style><link rel="stylesheet" href="/_astro/about.BrkH-_VM.css"><meta name="generator" content="Astro v5.7.8"><meta name="theme-color" content="#fff" media="(prefers-color-scheme: light)"><meta name="theme-color" content="#242428" media="(prefers-color-scheme: dark)"><link rel="sitemap" href="/sitemap-index.xml"><link rel="alternate" type="application/rss+xml" title="Blog – Jiří Pudil" href="/blog/rss.xml"><link rel="alternate" type="application/rss+xml" title="Notes – Jiří Pudil" href="/notes/rss.xml"><link rel="webmention" href="https://webmention.io/jiripudil.cz/webmention"><meta name="google-site-verification" content="7fHBkeNq7LXO24W8IjCc37NT9MX-6RJxD3Co5F-bRQw"><meta property="og:site_name" content="Jiří Pudil"><meta property="og:title" content="Blazing fast file upload through Nginx – Blog"><meta property="og:type" content="article"><meta property="article:published_time" content="2014-10-25T16:00:00.000Z"><meta property="article:tag" content="nettefw"><meta property="article:tag" content="nginx"><meta property="article:tag" content="php"><meta property="article:tag" content="upload"><link rel="manifest" href="/manifest.webmanifest"><meta name="mobile-web-app-capable" content="yes"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#fff"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#000"><meta name="application-name" content="Jiří Pudil"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-precomposed.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#fff"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="apple-mobile-web-app-title" content="Jiří Pudil"><link rel="icon" type="image/x-icon" href="/favicon.ico"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="48x48" href="/favicon-48x48.png"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><meta name="msapplication-TileColor" content="#fff"><meta name="msapplication-TileImage" content="/mstile-144x144.png"><meta name="msapplication-config" content="/browserconfig.xml"><link rel="yandex-tableau-widget" href="/yandex-browser-manifest.json"></head> <body> <div class="header" data-astro-cid-3ef6ksr2> <div class="container" data-astro-cid-d6puh33w>  <nav class="menu" data-astro-cid-3ef6ksr2> <ul data-astro-cid-3ef6ksr2> <li class="name" data-astro-cid-3ef6ksr2> <a href="/" title="Home" data-astro-cid-3ef6ksr2>
Jiří Pudil
</a> </li> <li data-astro-cid-3ef6ksr2> <a href="/about" data-astro-cid-3ef6ksr2>
About
</a> </li> <li data-astro-cid-3ef6ksr2> <a href="/projects" data-astro-cid-3ef6ksr2>
Projects
</a> </li> <li data-astro-cid-3ef6ksr2> <a href="/blog" class="active" data-astro-cid-3ef6ksr2>
Blog
</a> </li> <li data-astro-cid-3ef6ksr2> <a href="/notes" data-astro-cid-3ef6ksr2>
Notes
</a> </li> <li data-astro-cid-3ef6ksr2> <a href="/talks" data-astro-cid-3ef6ksr2>
Talks
</a> </li> </ul> </nav>  </div>  </div>    <div class="container" data-astro-cid-d6puh33w>  <div class="body" data-astro-cid-relfimn4> <h1 data-astro-cid-relfimn4>Blazing fast file upload through Nginx</h1> <div class="metadata" data-astro-cid-relfimn4> <ul data-astro-cid-relfimn4> <li data-astro-cid-relfimn4><a href="/blog/tag/nettefw" data-astro-cid-relfimn4>#nettefw</a></li><li data-astro-cid-relfimn4><a href="/blog/tag/nginx" data-astro-cid-relfimn4>#nginx</a></li><li data-astro-cid-relfimn4><a href="/blog/tag/php" data-astro-cid-relfimn4>#php</a></li><li data-astro-cid-relfimn4><a href="/blog/tag/upload" data-astro-cid-relfimn4>#upload</a></li> </ul> <time datetime="2014-10-25T16:00:00.000Z" data-astro-cid-relfimn4> Oct 25, 2014 </time> </div> <p class="perex" data-astro-cid-relfimn4>Implementing a shiny new feature for one of our clients, we faced a challenging task. We needed to handle uploads of loads of files. Effectively. Without torturing the server with unnecessary stuff.</p> <div class="content" data-astro-cid-relfimn4> <p>The default behavior of file uploads in what still is the standard stack for web applications - Apache and PHP - is
pretty straight-forward. The web server reads the incoming POST request, buffering the uploaded file onto the disk,
and passes the request on to the PHP backend which, in turn, reads the request and saves the file <em>again</em> to <em>its</em>
temporary directory. Sounds like too much overhead, doesn’t it?</p>
<p>Now imagine you need to handle tens or even hundreds of 1 to 10 MB files at once. If we send them in one request,
the overhead described above effectively blocks both a web server process and a PHP process for a long time,
rendering them unavailable to handle other requests. If we send the files one by one in separate requests, it gets
a bit better as the processes are occupied for a shorter time and can handle other requests inbetween the uploads.
But there’s still plenty of room for improvement.</p>
<p>The improvement is called <a href="http://www.grid.net.ru/nginx/upload.en.html">Nginx Upload Module</a>. It simply skips the part
where the file is passed to PHP backend to be read and written once again. It saves the uploaded file to a temporary
directory and only provides <em>information</em> about the file to PHP via POST variables that you can configure. (Besides,
if you’ve been using Apache so far, you should get quite a performance boost just by employing Nginx.)</p>
<h2 id="setting-it-up">Setting it up</h2>
<p>How to set the whole thing up? First, you need to compile Nginx with the upload module, since it’s not a built-in part
of the distribution. The module can be downloaded from its website or via cloning its <a href="https://github.com/vkholodkov/nginx-upload-module/">Github repo</a>.
(Make sure you use the <code>2.2</code> branch, <code>master</code> doesn’t work with recent versions of Nginx!) You can add a module to Nginx
via a compile-time option:</p>
<pre class="astro-code astro-code-themes OneLight OneDark" style="background-color:#FAFAFA;--shiki-dark-bg:#282C34;color:#383A42;--shiki-dark:#ABB2BF; overflow-x: auto;" tabindex="0" data-language="sh"><code><span class="line"><span style="color:#4078F2;--shiki-dark:#61AFEF">$</span><span style="color:#50A14F;--shiki-dark:#98C379"> ./configure</span><span style="color:#986801;--shiki-dark:#D19A66"> --add-module=/path/to/upload/module</span></span></code></pre>
<p>Then it’s just a matter of configuration. First, it’s necessary to raise <code>client_max_body_size</code> as its default value
is ridiculously small. This directive goes into the <code>server</code> block. (If you’re not familiar with the way Nginx is
configured, you should read my <a href="http://jiripudil.cz/blog/configuring-nginx-php-fpm-nette">previous post</a> and the articles
I linked from there.) Second and last, create a <code>location</code> block for the URL that should process the upload. The whole
magic then goes there:</p>
<pre class="astro-code astro-code-themes OneLight OneDark" style="background-color:#FAFAFA;--shiki-dark-bg:#282C34;color:#383A42;--shiki-dark:#ABB2BF; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>server {</span></span>
<span class="line"><span>	# previous server configuration stays here</span></span>
<span class="line"><span></span></span>
<span class="line"><span>	client_max_body_size 100m;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>	location /process-upload {</span></span>
<span class="line"><span>		upload_pass @upload;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>		# store uploaded files in hashed directories /tmp/upload/0 through /tmp/upload/9</span></span>
<span class="line"><span>		upload_store /tmp/upload 1;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>		# set read permissions for uploaded files</span></span>
<span class="line"><span>		upload_store_access user:r group:r;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>		# define information that should be passed to backend</span></span>
<span class="line"><span>		upload_set_form_field $upload_field_name[name] "$upload_file_name";</span></span>
<span class="line"><span>		upload_set_form_field $upload_field_name[type] "$upload_content_type";</span></span>
<span class="line"><span>		upload_set_form_field $upload_field_name[path] "$upload_tmp_path";</span></span>
<span class="line"><span>		upload_aggregate_form_field $upload_field_name[size] "$upload_file_size";</span></span>
<span class="line"><span>		upload_aggregate_form_field $upload_field_name[md5] "$upload_file_md5";</span></span>
<span class="line"><span>		upload_pass_form_field "submit";</span></span>
<span class="line"><span></span></span>
<span class="line"><span>		# remove the uploaded files if backend returns one of these HTTP status codes</span></span>
<span class="line"><span>		upload_cleanup 400 404 499 500-505;</span></span>
<span class="line"><span>	}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>	location @upload {</span></span>
<span class="line"><span>		rewrite ^ /index.php last;</span></span>
<span class="line"><span>	}</span></span>
<span class="line"><span>}</span></span></code></pre>
<p>The <code>upload_pass</code> directive passes the modified request to a named location which in turn rewrites the request to
<code>index.php</code>. Now your application will receive a request for <code>/process-upload</code> with all files already uploaded via
Nginx, and with the necessary information about them in POST. You can utilize Nette (or Symfony or whatever thing
you use) routing and direct the request to an action in a presenter/controller:</p>
<pre class="astro-code astro-code-themes OneLight OneDark" style="background-color:#FAFAFA;--shiki-dark-bg:#282C34;color:#383A42;--shiki-dark:#ABB2BF; overflow-x: auto;" tabindex="0" data-language="php"><code><span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">class</span><span style="color:#C18401;--shiki-dark:#E5C07B"> UploadPresenter</span><span style="color:#A626A4;--shiki-dark:#C678DD"> extends</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> Nette\Application\UI\</span><span style="color:#C18401;--shiki-dark:#E5C07B">Presenter</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">{</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">	public</span><span style="color:#A626A4;--shiki-dark:#C678DD"> function</span><span style="color:#4078F2;--shiki-dark:#61AFEF"> actionProcessUpload</span><span style="color:#383A42;--shiki-dark:#ABB2BF">()</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">	{</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">		foreach</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> (</span><span style="color:#E45649;--shiki-dark:#E06C75">$this</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">getHttpRequest</span><span style="color:#383A42;--shiki-dark:#ABB2BF">()</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">getPost</span><span style="color:#383A42;--shiki-dark:#ABB2BF">() </span><span style="color:#383A42;--shiki-dark:#C678DD">as</span><span style="color:#E45649;--shiki-dark:#E06C75"> $field</span><span style="color:#383A42;--shiki-dark:#C678DD"> =></span><span style="color:#E45649;--shiki-dark:#E06C75"> $file</span><span style="color:#383A42;--shiki-dark:#ABB2BF">) {</span></span>
<span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic">			// this is just an example, do whatever you want with the files</span></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">			$fileUpload</span><span style="color:#383A42;--shiki-dark:#C678DD"> =</span><span style="color:#A626A4;--shiki-dark:#C678DD"> new</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> Nette\Http\</span><span style="color:#C18401;--shiki-dark:#E5C07B">FileUpload</span><span style="color:#383A42;--shiki-dark:#ABB2BF">([</span></span>
<span class="line"><span style="color:#50A14F;--shiki-dark:#98C379">				'name'</span><span style="color:#383A42;--shiki-dark:#C678DD"> =></span><span style="color:#E45649;--shiki-dark:#E06C75"> $file</span><span style="color:#383A42;--shiki-dark:#ABB2BF">[</span><span style="color:#50A14F;--shiki-dark:#98C379">'name'</span><span style="color:#383A42;--shiki-dark:#ABB2BF">],</span></span>
<span class="line"><span style="color:#50A14F;--shiki-dark:#98C379">				'type'</span><span style="color:#383A42;--shiki-dark:#C678DD"> =></span><span style="color:#E45649;--shiki-dark:#E06C75"> $file</span><span style="color:#383A42;--shiki-dark:#ABB2BF">[</span><span style="color:#50A14F;--shiki-dark:#98C379">'type'</span><span style="color:#383A42;--shiki-dark:#ABB2BF">],</span></span>
<span class="line"><span style="color:#50A14F;--shiki-dark:#98C379">				'tmp_name'</span><span style="color:#383A42;--shiki-dark:#C678DD"> =></span><span style="color:#E45649;--shiki-dark:#E06C75"> $file</span><span style="color:#383A42;--shiki-dark:#ABB2BF">[</span><span style="color:#50A14F;--shiki-dark:#98C379">'path'</span><span style="color:#383A42;--shiki-dark:#ABB2BF">],</span></span>
<span class="line"><span style="color:#50A14F;--shiki-dark:#98C379">				'size'</span><span style="color:#383A42;--shiki-dark:#C678DD"> =></span><span style="color:#383A42;--shiki-dark:#ABB2BF"> (</span><span style="color:#A626A4;--shiki-dark:#C678DD">int</span><span style="color:#383A42;--shiki-dark:#ABB2BF">) </span><span style="color:#E45649;--shiki-dark:#E06C75">$file</span><span style="color:#383A42;--shiki-dark:#ABB2BF">[</span><span style="color:#50A14F;--shiki-dark:#98C379">'size'</span><span style="color:#383A42;--shiki-dark:#ABB2BF">],</span></span>
<span class="line"><span style="color:#50A14F;--shiki-dark:#98C379">				'error'</span><span style="color:#383A42;--shiki-dark:#C678DD"> =></span><span style="color:#0184BC;--shiki-dark:#56B6C2"> empty</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#E45649;--shiki-dark:#E06C75">$file</span><span style="color:#383A42;--shiki-dark:#ABB2BF">) </span><span style="color:#383A42;--shiki-dark:#C678DD">?</span><span style="color:#986801;--shiki-dark:#D19A66"> UPLOAD_ERR_NO_FILE</span><span style="color:#383A42;--shiki-dark:#C678DD"> :</span><span style="color:#986801;--shiki-dark:#D19A66"> UPLOAD_ERR_OK</span><span style="color:#383A42;--shiki-dark:#ABB2BF">,</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">			]);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">			$this</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#E45649;--shiki-dark:#E06C75">uploader</span><span style="color:#383A42;--shiki-dark:#C678DD">-></span><span style="color:#4078F2;--shiki-dark:#61AFEF">process</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#E45649;--shiki-dark:#E06C75">$fileUpload</span><span style="color:#383A42;--shiki-dark:#ABB2BF">);</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">		}</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">	}</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">}</span></span></code></pre>
<p>The <code>upload_set_form_field</code>, <code>upload_aggregate_form_field</code>, and <code>upload_pass_form_field</code> directives allow you to
configure what the POST data that your application receives will look like. I pass them in an array as it’s convenient
to process on the PHP side. Special care must be taken if you use multiple file upload via <code>&#x3C;input type="file" multiple></code>,
as the upload module and PHP in combination don’t play nice with those square brackets in the field name. You should
turn on the <code>upload_tame_arrays</code> flag - which strips the brackets - and modify passed field names accordingly, adding
the file’s ordinal number manually:</p>
<pre class="astro-code astro-code-themes OneLight OneDark" style="background-color:#FAFAFA;--shiki-dark-bg:#282C34;color:#383A42;--shiki-dark:#ABB2BF; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>upload_tame_arrays on;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>upload_set_form_field $upload_field_name[$upload_file_number][name] "$upload_file_name";</span></span>
<span class="line"><span># modify the rest similarly</span></span></code></pre>
<p>That’s it. You now have everything set up for Nginx to save the uploaded files, skipping PHP’s implementation altogether,
and gaining a nice performance boost. Now let the files come.</p>
<p><strong>Update 2017-02-22:</strong> The module seems to be abandoned since 2014. You should use
<a href="https://github.com/vkholodkov/nginx-upload-module/issues/79#issuecomment-260528628">Austinb’s fork</a> to make it work
with latest mainline nginx (tested with 1.11.10)</p> </div> <div class="comments" data-astro-cid-relfimn4> <div id="giscus-container"></div> <script type="module">const t=document.createElement("script");t.src="https://giscus.app/client.js";t.crossOrigin="anonymous";t.async=!0;t.setAttribute("data-repo","jiripudil/jiripudil.cz");t.setAttribute("data-repo-id","MDEwOlJlcG9zaXRvcnkyNTI5NzY3Nw==");t.setAttribute("data-category","Blog discussions");t.setAttribute("data-category-id","DIC_kwDOAYIDDc4CAfUM");t.setAttribute("data-mapping","og:title");t.setAttribute("data-reactions-enabled","1");t.setAttribute("data-emit-metadata","0");t.setAttribute("data-theme","preferred_color_scheme");t.setAttribute("data-lang","en");t.setAttribute("data-loading","lazy");const e=document.getElementById("giscus-container");e.appendChild(t);</script> </div> </div>  </div>   <div class="footer" data-astro-cid-sz7xmlte> <div class="container" data-astro-cid-d6puh33w> 
Content licensed under
<a href="https://creativecommons.org/licenses/by/4.0/" title="Creative Commons Attribution 4.0 International" aria-label="Creative Commons Attribution 4.0 International" data-astro-cid-sz7xmlte> <svg width="0.97em" height="1em" data-astro-cid-sz7xmlte="true" data-icon="fa6-brands:creative-commons">   <symbol id="ai:fa6-brands:creative-commons" viewBox="0 0 496 512"><path fill="currentColor" d="m245.83 214.87l-33.22 17.28c-9.43-19.58-25.24-19.93-27.46-19.93c-22.13 0-33.22 14.61-33.22 43.84c0 23.57 9.21 43.84 33.22 43.84c14.47 0 24.65-7.09 30.57-21.26l30.55 15.5c-6.17 11.51-25.69 38.98-65.1 38.98c-22.6 0-73.96-10.32-73.96-77.05c0-58.69 43-77.06 72.63-77.06c30.72-.01 52.7 11.95 65.99 35.86m143.05 0l-32.78 17.28c-9.5-19.77-25.72-19.93-27.9-19.93c-22.14 0-33.22 14.61-33.22 43.84c0 23.55 9.23 43.84 33.22 43.84c14.45 0 24.65-7.09 30.54-21.26l31 15.5c-2.1 3.75-21.39 38.98-65.09 38.98c-22.69 0-73.96-9.87-73.96-77.05c0-58.67 42.97-77.06 72.63-77.06c30.71-.01 52.58 11.95 65.56 35.86M247.56 8.05C104.74 8.05 0 123.11 0 256.05c0 138.49 113.6 248 247.56 248c129.93 0 248.44-100.87 248.44-248c0-137.87-106.62-248-248.44-248m.87 450.81c-112.54 0-203.7-93.04-203.7-202.81c0-105.42 85.43-203.27 203.72-203.27c112.53 0 202.82 89.46 202.82 203.26c-.01 121.69-99.68 202.82-202.84 202.82"/></symbol><use href="#ai:fa6-brands:creative-commons"></use>  </svg> <svg width="0.97em" height="1em" data-astro-cid-sz7xmlte="true" data-icon="fa6-brands:creative-commons-by">   <symbol id="ai:fa6-brands:creative-commons-by" viewBox="0 0 496 512"><path fill="currentColor" d="M314.9 194.4v101.4h-28.3v120.5h-77.1V295.9h-28.3V194.4c0-4.4 1.6-8.2 4.6-11.3c3.1-3.1 6.9-4.7 11.3-4.7H299c4.1 0 7.8 1.6 11.1 4.7c3.1 3.2 4.8 6.9 4.8 11.3m-101.5-63.7c0-23.3 11.5-35 34.5-35s34.5 11.7 34.5 35q0 34.5-34.5 34.5c-34.5 0-34.5-11.5-34.5-34.5M247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8m.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3"/></symbol><use href="#ai:fa6-brands:creative-commons-by"></use>  </svg> </a>  </div>  </div>  </body></html> 