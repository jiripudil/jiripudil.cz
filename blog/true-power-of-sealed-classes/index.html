<!DOCTYPE html><html lang="en"> <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><title>The true power of sealed classes – Blog – Jiří Pudil</title><style>.body[data-astro-cid-relfimn4]{padding:1.5rem 0}h1[data-astro-cid-relfimn4]{text-wrap:balance}.metadata[data-astro-cid-relfimn4]{display:flex;align-items:start;justify-content:space-between;gap:1rem;margin-bottom:3rem;ul{margin:0;padding:0;list-style:none;display:flex;flex-wrap:wrap;gap:0 .5rem;font-size:.9rem;a{color:var(--body-diminished-color);&:hover{color:var(--body-text-color)}}}time{flex-shrink:0;color:var(--body-diminished-color)}}.perex[data-astro-cid-relfimn4]{font-size:1.15rem}.content[data-astro-cid-relfimn4]{h2{margin-top:3rem}h3{margin-top:2.25rem}p{text-wrap:pretty;hyphens:auto}:is(ul,ol) li{line-height:1.6;margin-bottom:.5rem}blockquote{position:relative;&:before{content:"“";position:absolute;left:-2.25rem;top:0;color:var(--body-accent-color);font-size:4rem}}img{max-width:100%;height:auto}iframe{max-width:100%;aspect-ratio:16 / 9}code{hyphens:none}.astro-code{margin:.5rem 0;padding:.5rem;font-size:.9rem;tab-size:4}}.comments[data-astro-cid-relfimn4]{margin-top:3rem}@media (max-width: 40rem){.metadata[data-astro-cid-relfimn4]{flex-direction:column;align-items:start;justify-content:start}}
</style><link rel="stylesheet" href="/_astro/about.BrkH-_VM.css"><meta name="generator" content="Astro v5.7.8"><meta name="theme-color" content="#fff" media="(prefers-color-scheme: light)"><meta name="theme-color" content="#242428" media="(prefers-color-scheme: dark)"><link rel="sitemap" href="/sitemap-index.xml"><link rel="alternate" type="application/rss+xml" title="Blog – Jiří Pudil" href="/blog/rss.xml"><link rel="alternate" type="application/rss+xml" title="Notes – Jiří Pudil" href="/notes/rss.xml"><link rel="webmention" href="https://webmention.io/jiripudil.cz/webmention"><meta name="google-site-verification" content="7fHBkeNq7LXO24W8IjCc37NT9MX-6RJxD3Co5F-bRQw"><meta property="og:site_name" content="Jiří Pudil"><meta property="og:title" content="The true power of sealed classes – Blog"><meta property="og:type" content="article"><meta property="article:published_time" content="2022-11-15T09:30:00.000Z"><meta property="article:tag" content="php"><meta property="article:tag" content="phpstan"><meta property="article:tag" content="sealed-classes"><meta property="article:tag" content="static-analysis"><link rel="manifest" href="/manifest.webmanifest"><meta name="mobile-web-app-capable" content="yes"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#fff"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#000"><meta name="application-name" content="Jiří Pudil"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-precomposed.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#fff"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="apple-mobile-web-app-title" content="Jiří Pudil"><link rel="icon" type="image/x-icon" href="/favicon.ico"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="48x48" href="/favicon-48x48.png"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><meta name="msapplication-TileColor" content="#fff"><meta name="msapplication-TileImage" content="/mstile-144x144.png"><meta name="msapplication-config" content="/browserconfig.xml"><link rel="yandex-tableau-widget" href="/yandex-browser-manifest.json"></head> <body> <div class="header" data-astro-cid-3ef6ksr2> <div class="container" data-astro-cid-d6puh33w>  <nav class="menu" data-astro-cid-3ef6ksr2> <ul data-astro-cid-3ef6ksr2> <li class="name" data-astro-cid-3ef6ksr2> <a href="/" title="Home" data-astro-cid-3ef6ksr2>
Jiří Pudil
</a> </li> <li data-astro-cid-3ef6ksr2> <a href="/about" data-astro-cid-3ef6ksr2>
About
</a> </li> <li data-astro-cid-3ef6ksr2> <a href="/projects" data-astro-cid-3ef6ksr2>
Projects
</a> </li> <li data-astro-cid-3ef6ksr2> <a href="/blog" class="active" data-astro-cid-3ef6ksr2>
Blog
</a> </li> <li data-astro-cid-3ef6ksr2> <a href="/notes" data-astro-cid-3ef6ksr2>
Notes
</a> </li> <li data-astro-cid-3ef6ksr2> <a href="/talks" data-astro-cid-3ef6ksr2>
Talks
</a> </li> </ul> </nav>  </div>  </div>    <div class="container" data-astro-cid-d6puh33w>  <div class="body" data-astro-cid-relfimn4> <h1 data-astro-cid-relfimn4>The true power of sealed classes</h1> <div class="metadata" data-astro-cid-relfimn4> <ul data-astro-cid-relfimn4> <li data-astro-cid-relfimn4><a href="/blog/tag/php" data-astro-cid-relfimn4>#php</a></li><li data-astro-cid-relfimn4><a href="/blog/tag/phpstan" data-astro-cid-relfimn4>#phpstan</a></li><li data-astro-cid-relfimn4><a href="/blog/tag/sealed-classes" data-astro-cid-relfimn4>#sealed-classes</a></li><li data-astro-cid-relfimn4><a href="/blog/tag/static-analysis" data-astro-cid-relfimn4>#static-analysis</a></li> </ul> <time datetime="2022-11-15T09:30:00.000Z" data-astro-cid-relfimn4> Nov 15, 2022 </time> </div> <p class="perex" data-astro-cid-relfimn4>In my recent post, I've introduced a PHPStan extension that brings support for sealed classes and interfaces to statically analyzed PHP. Looking back, I feel I haven't stressed the main benefit enough, so here I am doing it justice.</p> <div class="content" data-astro-cid-relfimn4> <p>First of all, I’d kindly ask you to go read <a href="/blog/seal-your-classes-with-phpstan">the announcement</a> if you haven’t already. Late in the post, I have shown an example of a sealed interface hierarchy. Let’s build up on that example:</p>
<blockquote>
<p>Consider an appointment-planning application: you can <em>request</em> an appointment on a given day, the other party <em>offers</em> you a set of times they are available, you <em>pick</em> one of them, and the other party eventually <em>confirms</em> the appointment, or <em>offers</em> you a new set of times in case the one you’ve chosen is no longer available.</p>
</blockquote>
<p>This is an approximation of one way we could model such concept in domain code:</p>
<pre class="astro-code astro-code-themes OneLight OneDark" style="background-color:#FAFAFA;--shiki-dark-bg:#282C34;color:#383A42;--shiki-dark:#ABB2BF; overflow-x: auto;" tabindex="0" data-language="php"><code><span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">interface</span><span style="color:#C18401;--shiki-dark:#E5C07B"> AppointmentState</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> {}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">class</span><span style="color:#C18401;--shiki-dark:#E5C07B"> RequestedAppointment</span><span style="color:#A626A4;--shiki-dark:#C678DD"> implements</span><span style="color:#C18401;--shiki-dark:#E5C07B"> AppointmentState</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> { </span><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic">/* ... */</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> }</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">class</span><span style="color:#C18401;--shiki-dark:#E5C07B"> OfferedAppointment</span><span style="color:#A626A4;--shiki-dark:#C678DD"> implements</span><span style="color:#C18401;--shiki-dark:#E5C07B"> AppointmentState</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> { </span><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic">/* ... */</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> }</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">class</span><span style="color:#C18401;--shiki-dark:#E5C07B"> ProposedAppointment</span><span style="color:#A626A4;--shiki-dark:#C678DD"> implements</span><span style="color:#C18401;--shiki-dark:#E5C07B"> AppointmentState</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> { </span><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic">/* ... */</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> }</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">class</span><span style="color:#C18401;--shiki-dark:#E5C07B"> ConfirmedAppointment</span><span style="color:#A626A4;--shiki-dark:#C678DD"> implements</span><span style="color:#C18401;--shiki-dark:#E5C07B"> AppointmentState</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> { </span><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic">/* ... */</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> }</span></span></code></pre>
<p>But applications aren’t all domain code. On top of the core business logic, there is always an API or a UI layer, a part of which might be this tiny function that converts the appointment state into a short, human-readable description:</p>
<pre class="astro-code astro-code-themes OneLight OneDark" style="background-color:#FAFAFA;--shiki-dark-bg:#282C34;color:#383A42;--shiki-dark:#ABB2BF; overflow-x: auto;" tabindex="0" data-language="php"><code><span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">function</span><span style="color:#4078F2;--shiki-dark:#61AFEF"> describe</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#C18401;--shiki-dark:#E5C07B">AppointmentState</span><span style="color:#E45649;--shiki-dark:#E06C75"> $state</span><span style="color:#383A42;--shiki-dark:#ABB2BF">)</span><span style="color:#383A42;--shiki-dark:#C678DD">:</span><span style="color:#A626A4;--shiki-dark:#C678DD"> string</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">{</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">    return</span><span style="color:#A626A4;--shiki-dark:#C678DD"> match</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> (</span><span style="color:#986801;--shiki-dark:#D19A66">true</span><span style="color:#383A42;--shiki-dark:#ABB2BF">) {</span></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">        $state</span><span style="color:#383A42;--shiki-dark:#C678DD"> instanceof</span><span style="color:#C18401;--shiki-dark:#E5C07B"> RequestedAppointment</span><span style="color:#A626A4;--shiki-dark:#C678DD"> =></span><span style="color:#50A14F;--shiki-dark:#98C379"> 'requested'</span><span style="color:#383A42;--shiki-dark:#ABB2BF">,</span></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">        $state</span><span style="color:#383A42;--shiki-dark:#C678DD"> instanceof</span><span style="color:#C18401;--shiki-dark:#E5C07B"> OfferedAppointment</span><span style="color:#A626A4;--shiki-dark:#C678DD"> =></span><span style="color:#50A14F;--shiki-dark:#98C379"> 'times offered'</span><span style="color:#383A42;--shiki-dark:#ABB2BF">,</span></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">        $state</span><span style="color:#383A42;--shiki-dark:#C678DD"> instanceof</span><span style="color:#C18401;--shiki-dark:#E5C07B"> ProposedAppointment</span><span style="color:#A626A4;--shiki-dark:#C678DD"> =></span><span style="color:#50A14F;--shiki-dark:#98C379"> 'time proposed'</span><span style="color:#383A42;--shiki-dark:#ABB2BF">,</span></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">        $state</span><span style="color:#383A42;--shiki-dark:#C678DD"> instanceof</span><span style="color:#C18401;--shiki-dark:#E5C07B"> ConfirmedAppointment</span><span style="color:#A626A4;--shiki-dark:#C678DD"> =></span><span style="color:#50A14F;--shiki-dark:#98C379"> 'confirmed'</span><span style="color:#383A42;--shiki-dark:#ABB2BF">,</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">    };</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">}</span></span></code></pre>
<p>If we let PHPStan analyze this code, we’ll get a cryptic error:</p>
<pre class="astro-code astro-code-themes OneLight OneDark" style="background-color:#FAFAFA;--shiki-dark-bg:#282C34;color:#383A42;--shiki-dark:#ABB2BF; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>------ --------------------------------------------------------</span></span>
<span class="line"><span> Line   describe.php</span></span>
<span class="line"><span>------ --------------------------------------------------------</span></span>
<span class="line"><span> 5      Match expression does not handle remaining value: true</span></span>
<span class="line"><span>------ --------------------------------------------------------</span></span>
<span class="line"><span></span></span>
<span class="line"><span>[ERROR] Found 1 error</span></span></code></pre>
<p>The message is only cryptic due to how I’ve chosen to write the <code>match</code>. All it’s saying is that the <code>match</code> doesn’t cover all possible situations. As far as PHPStan is concerned, any other implementation of the <code>AppointmentState</code> interface can make its way into the codebase and, in turn, the <code>describe</code> function. And we’re forgetting to handle it.</p>
<p>The fix is simple, yet tedious:</p>
<pre class="astro-code astro-code-themes OneLight OneDark" style="background-color:#FAFAFA;--shiki-dark-bg:#282C34;color:#383A42;--shiki-dark:#ABB2BF; overflow-x: auto;" tabindex="0" data-language="php"><code><span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">function</span><span style="color:#4078F2;--shiki-dark:#61AFEF"> describe</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#C18401;--shiki-dark:#E5C07B">AppointmentState</span><span style="color:#E45649;--shiki-dark:#E06C75"> $state</span><span style="color:#383A42;--shiki-dark:#ABB2BF">)</span><span style="color:#383A42;--shiki-dark:#C678DD">:</span><span style="color:#A626A4;--shiki-dark:#C678DD"> string</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">{</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">    return</span><span style="color:#A626A4;--shiki-dark:#C678DD"> match</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> (</span><span style="color:#986801;--shiki-dark:#D19A66">true</span><span style="color:#383A42;--shiki-dark:#ABB2BF">) {</span></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">        $state</span><span style="color:#383A42;--shiki-dark:#C678DD"> instanceof</span><span style="color:#C18401;--shiki-dark:#E5C07B"> RequestedAppointment</span><span style="color:#A626A4;--shiki-dark:#C678DD"> =></span><span style="color:#50A14F;--shiki-dark:#98C379"> 'requested'</span><span style="color:#383A42;--shiki-dark:#ABB2BF">,</span></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">        $state</span><span style="color:#383A42;--shiki-dark:#C678DD"> instanceof</span><span style="color:#C18401;--shiki-dark:#E5C07B"> OfferedAppointment</span><span style="color:#A626A4;--shiki-dark:#C678DD"> =></span><span style="color:#50A14F;--shiki-dark:#98C379"> 'times offered'</span><span style="color:#383A42;--shiki-dark:#ABB2BF">,</span></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">        $state</span><span style="color:#383A42;--shiki-dark:#C678DD"> instanceof</span><span style="color:#C18401;--shiki-dark:#E5C07B"> ProposedAppointment</span><span style="color:#A626A4;--shiki-dark:#C678DD"> =></span><span style="color:#50A14F;--shiki-dark:#98C379"> 'time proposed'</span><span style="color:#383A42;--shiki-dark:#ABB2BF">,</span></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">        $state</span><span style="color:#383A42;--shiki-dark:#C678DD"> instanceof</span><span style="color:#C18401;--shiki-dark:#E5C07B"> ConfirmedAppointment</span><span style="color:#A626A4;--shiki-dark:#C678DD"> =></span><span style="color:#50A14F;--shiki-dark:#98C379"> 'confirmed'</span><span style="color:#383A42;--shiki-dark:#ABB2BF">,</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">        default</span><span style="color:#A626A4;--shiki-dark:#C678DD"> =></span><span style="color:#A626A4;--shiki-dark:#C678DD"> throw</span><span style="color:#A626A4;--shiki-dark:#C678DD"> new</span><span style="color:#C18401;--shiki-dark:#E5C07B"> ThisShouldNotHappen</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(),</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">    };</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">}</span></span></code></pre>
<p>Or we could instruct PHPStan to ignore this error. It’s all the same. We’re doing this only for the sake of PHPStan. Just to make it happy. Just to make it shut up. Just because it doesn’t understand the code in as much depth as we developers do. Well, with sealed classes and interfaces, turns out it <em>can</em> understand the code better:</p>
<pre class="astro-code astro-code-themes OneLight OneDark" style="background-color:#FAFAFA;--shiki-dark-bg:#282C34;color:#383A42;--shiki-dark:#ABB2BF; overflow-x: auto;" tabindex="0" data-language="php"><code><span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">#[Sealed(permits: [</span></span>
<span class="line"><span style="color:#C18401;--shiki-dark:#E5C07B">    RequestedAppointment</span><span style="color:#383A42;--shiki-dark:#C678DD">::</span><span style="color:#A626A4;--shiki-dark:#C678DD">class</span><span style="color:#383A42;--shiki-dark:#ABB2BF">,</span></span>
<span class="line"><span style="color:#C18401;--shiki-dark:#E5C07B">    OfferedAppointment</span><span style="color:#383A42;--shiki-dark:#C678DD">::</span><span style="color:#A626A4;--shiki-dark:#C678DD">class</span><span style="color:#383A42;--shiki-dark:#ABB2BF">,</span></span>
<span class="line"><span style="color:#C18401;--shiki-dark:#E5C07B">    ProposedAppointment</span><span style="color:#383A42;--shiki-dark:#C678DD">::</span><span style="color:#A626A4;--shiki-dark:#C678DD">class</span><span style="color:#383A42;--shiki-dark:#ABB2BF">,</span></span>
<span class="line"><span style="color:#C18401;--shiki-dark:#E5C07B">    ConfirmedAppointment</span><span style="color:#383A42;--shiki-dark:#C678DD">::</span><span style="color:#A626A4;--shiki-dark:#C678DD">class</span><span style="color:#383A42;--shiki-dark:#ABB2BF">,</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">])]</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">interface</span><span style="color:#C18401;--shiki-dark:#E5C07B"> AppointmentState</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> {}</span></span></code></pre>
<p>With the interface marked as sealed over the four known implementations, we can safely remove the <code>default</code> case from the <code>match</code> expression, and PHPStan will be satisfied with it. In fact, we <em>must</em> remove the <code>default</code> case because if we don’t, we’ll get an error:</p>
<pre class="astro-code astro-code-themes OneLight OneDark" style="background-color:#FAFAFA;--shiki-dark-bg:#282C34;color:#383A42;--shiki-dark:#ABB2BF; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>------ ----------------------------------------------------------------------</span></span>
<span class="line"><span> Line   describe.php</span></span>
<span class="line"><span>------ ----------------------------------------------------------------------</span></span>
<span class="line"><span> 5      Match arm is unreachable because previous comparison is always true.</span></span>
<span class="line"><span>------ ----------------------------------------------------------------------</span></span>
<span class="line"><span></span></span>
<span class="line"><span>[ERROR] Found 1 error</span></span></code></pre>
<p>By this, PHPStan is trying to tell us we no longer need the <code>default</code> because all possibilites are already accounted for. So let’s remove it:</p>
<pre class="astro-code astro-code-themes OneLight OneDark" style="background-color:#FAFAFA;--shiki-dark-bg:#282C34;color:#383A42;--shiki-dark:#ABB2BF; overflow-x: auto;" tabindex="0" data-language="php"><code><span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">function</span><span style="color:#4078F2;--shiki-dark:#61AFEF"> describe</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#C18401;--shiki-dark:#E5C07B">AppointmentState</span><span style="color:#E45649;--shiki-dark:#E06C75"> $state</span><span style="color:#383A42;--shiki-dark:#ABB2BF">)</span><span style="color:#383A42;--shiki-dark:#C678DD">:</span><span style="color:#A626A4;--shiki-dark:#C678DD"> string</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">{</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">    return</span><span style="color:#A626A4;--shiki-dark:#C678DD"> match</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> (</span><span style="color:#986801;--shiki-dark:#D19A66">true</span><span style="color:#383A42;--shiki-dark:#ABB2BF">) {</span></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">        $state</span><span style="color:#383A42;--shiki-dark:#C678DD"> instanceof</span><span style="color:#C18401;--shiki-dark:#E5C07B"> RequestedAppointment</span><span style="color:#A626A4;--shiki-dark:#C678DD"> =></span><span style="color:#50A14F;--shiki-dark:#98C379"> 'requested'</span><span style="color:#383A42;--shiki-dark:#ABB2BF">,</span></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">        $state</span><span style="color:#383A42;--shiki-dark:#C678DD"> instanceof</span><span style="color:#C18401;--shiki-dark:#E5C07B"> OfferedAppointment</span><span style="color:#A626A4;--shiki-dark:#C678DD"> =></span><span style="color:#50A14F;--shiki-dark:#98C379"> 'times offered'</span><span style="color:#383A42;--shiki-dark:#ABB2BF">,</span></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">        $state</span><span style="color:#383A42;--shiki-dark:#C678DD"> instanceof</span><span style="color:#C18401;--shiki-dark:#E5C07B"> ProposedAppointment</span><span style="color:#A626A4;--shiki-dark:#C678DD"> =></span><span style="color:#50A14F;--shiki-dark:#98C379"> 'time proposed'</span><span style="color:#383A42;--shiki-dark:#ABB2BF">,</span></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">        $state</span><span style="color:#383A42;--shiki-dark:#C678DD"> instanceof</span><span style="color:#C18401;--shiki-dark:#E5C07B"> ConfirmedAppointment</span><span style="color:#A626A4;--shiki-dark:#C678DD"> =></span><span style="color:#50A14F;--shiki-dark:#98C379"> 'confirmed'</span><span style="color:#383A42;--shiki-dark:#ABB2BF">,</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">    };</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">}</span></span></code></pre>
<p>We’re back at where we were with this function. The difference is that PHPStan now knows that there won’t ever be any other implementation of the <code>AppointmentState</code> interface. We’ve removed the shut-up-for-once-I-know-what-I-am-doing <code>default</code>, and replaced it with a wink-wink-we-both-understand-what-is-going-on awareness of the situation.</p>
<p>We’ve managed to give PHPStan the same knowledge we have, <strong>and more:</strong> PHPStan now has our back covered.</p>
<p>Let me revisit my original post:</p>
<blockquote>
<p>Finally, introducing a new state into the mix, such as <em>canceled</em>, alters all these rules and often requires non-trivial changes in code.</p>
</blockquote>
<p>I’m pretty sure that in our appointment-planning application, this business requirement will come sooner rather than later. And when it does, PHPStan is ready to help us:</p>
<pre class="astro-code astro-code-themes OneLight OneDark" style="background-color:#FAFAFA;--shiki-dark-bg:#282C34;color:#383A42;--shiki-dark:#ABB2BF; overflow-x: auto;" tabindex="0" data-language="php"><code><span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">class</span><span style="color:#C18401;--shiki-dark:#E5C07B"> CanceledAppointment</span><span style="color:#A626A4;--shiki-dark:#C678DD"> implements</span><span style="color:#C18401;--shiki-dark:#E5C07B"> AppointmentState</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> { </span><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#5C6370;--shiki-dark-font-style:italic">/* ... */</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> }</span></span></code></pre>
<p>This code alone will produce an error:</p>
<pre class="astro-code astro-code-themes OneLight OneDark" style="background-color:#FAFAFA;--shiki-dark-bg:#282C34;color:#383A42;--shiki-dark:#ABB2BF; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>------ ------------------------------------------------------------------------------</span></span>
<span class="line"><span> Line   canceled.php</span></span>
<span class="line"><span>------ ------------------------------------------------------------------------------</span></span>
<span class="line"><span> 3      Type CanceledAppointment is not allowed to be a subtype of AppointmentState.</span></span>
<span class="line"><span>------ ------------------------------------------------------------------------------</span></span>
<span class="line"><span></span></span>
<span class="line"><span>[ERROR] Found 1 error</span></span></code></pre>
<p>Of course. We have to add this new implementation to the list of permitted subtypes of the sealed interface:</p>
<pre class="astro-code astro-code-themes OneLight OneDark" style="background-color:#FAFAFA;--shiki-dark-bg:#282C34;color:#383A42;--shiki-dark:#ABB2BF; overflow-x: auto;" tabindex="0" data-language="php"><code><span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">#[Sealed(permits: [</span></span>
<span class="line"><span style="color:#C18401;--shiki-dark:#E5C07B">    RequestedAppointment</span><span style="color:#383A42;--shiki-dark:#C678DD">::</span><span style="color:#A626A4;--shiki-dark:#C678DD">class</span><span style="color:#383A42;--shiki-dark:#ABB2BF">,</span></span>
<span class="line"><span style="color:#C18401;--shiki-dark:#E5C07B">    OfferedAppointment</span><span style="color:#383A42;--shiki-dark:#C678DD">::</span><span style="color:#A626A4;--shiki-dark:#C678DD">class</span><span style="color:#383A42;--shiki-dark:#ABB2BF">,</span></span>
<span class="line"><span style="color:#C18401;--shiki-dark:#E5C07B">    ProposedAppointment</span><span style="color:#383A42;--shiki-dark:#C678DD">::</span><span style="color:#A626A4;--shiki-dark:#C678DD">class</span><span style="color:#383A42;--shiki-dark:#ABB2BF">,</span></span>
<span class="line"><span style="color:#C18401;--shiki-dark:#E5C07B">    ConfirmedAppointment</span><span style="color:#383A42;--shiki-dark:#C678DD">::</span><span style="color:#A626A4;--shiki-dark:#C678DD">class</span><span style="color:#383A42;--shiki-dark:#ABB2BF">,</span></span>
<span class="line"><span style="color:#C18401;--shiki-dark:#E5C07B">    CanceledAppointment</span><span style="color:#383A42;--shiki-dark:#C678DD">::</span><span style="color:#A626A4;--shiki-dark:#C678DD">class</span><span style="color:#383A42;--shiki-dark:#ABB2BF">,</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">])]</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">interface</span><span style="color:#C18401;--shiki-dark:#E5C07B"> AppointmentState</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> {}</span></span></code></pre>
<p>As soon as we do this, our cryptic error message from before makes a comeback:</p>
<pre class="astro-code astro-code-themes OneLight OneDark" style="background-color:#FAFAFA;--shiki-dark-bg:#282C34;color:#383A42;--shiki-dark:#ABB2BF; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>------ --------------------------------------------------------</span></span>
<span class="line"><span> Line   describe.php</span></span>
<span class="line"><span>------ --------------------------------------------------------</span></span>
<span class="line"><span> 5      Match expression does not handle remaining value: true</span></span>
<span class="line"><span>------ --------------------------------------------------------</span></span>
<span class="line"><span></span></span>
<span class="line"><span>[ERROR] Found 1 error</span></span></code></pre>
<p>However, while the wording is the same, the meaning is different now. We’re not forgetting to handle just <em>any</em> old case that we can remedy by throwing in an artificial exception in the <code>default</code> branch of the <code>match</code>; this time, we’re forgetting to handle the one specific case that we’ve just added: <code>CanceledAppointment</code>.</p>
<p>This is what I meant by ‘PHPStan now has our back covered.’ It will tirelessly analyze our whole codebase and pinpoint every single place where we’re expecting <code>AppointmentState</code> and neglecting to handle the eventuality of the appointment getting canceled. We can go through the report, error by error, and fix it the right way:</p>
<pre class="astro-code astro-code-themes OneLight OneDark" style="background-color:#FAFAFA;--shiki-dark-bg:#282C34;color:#383A42;--shiki-dark:#ABB2BF; overflow-x: auto;" tabindex="0" data-language="php"><code><span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">function</span><span style="color:#4078F2;--shiki-dark:#61AFEF"> describe</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#C18401;--shiki-dark:#E5C07B">AppointmentState</span><span style="color:#E45649;--shiki-dark:#E06C75"> $state</span><span style="color:#383A42;--shiki-dark:#ABB2BF">)</span><span style="color:#383A42;--shiki-dark:#C678DD">:</span><span style="color:#A626A4;--shiki-dark:#C678DD"> string</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">{</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">    return</span><span style="color:#A626A4;--shiki-dark:#C678DD"> match</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> (</span><span style="color:#986801;--shiki-dark:#D19A66">true</span><span style="color:#383A42;--shiki-dark:#ABB2BF">) {</span></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">        $state</span><span style="color:#383A42;--shiki-dark:#C678DD"> instanceof</span><span style="color:#C18401;--shiki-dark:#E5C07B"> RequestedAppointment</span><span style="color:#A626A4;--shiki-dark:#C678DD"> =></span><span style="color:#50A14F;--shiki-dark:#98C379"> 'requested'</span><span style="color:#383A42;--shiki-dark:#ABB2BF">,</span></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">        $state</span><span style="color:#383A42;--shiki-dark:#C678DD"> instanceof</span><span style="color:#C18401;--shiki-dark:#E5C07B"> OfferedAppointment</span><span style="color:#A626A4;--shiki-dark:#C678DD"> =></span><span style="color:#50A14F;--shiki-dark:#98C379"> 'times offered'</span><span style="color:#383A42;--shiki-dark:#ABB2BF">,</span></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">        $state</span><span style="color:#383A42;--shiki-dark:#C678DD"> instanceof</span><span style="color:#C18401;--shiki-dark:#E5C07B"> ProposedAppointment</span><span style="color:#A626A4;--shiki-dark:#C678DD"> =></span><span style="color:#50A14F;--shiki-dark:#98C379"> 'time proposed'</span><span style="color:#383A42;--shiki-dark:#ABB2BF">,</span></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">        $state</span><span style="color:#383A42;--shiki-dark:#C678DD"> instanceof</span><span style="color:#C18401;--shiki-dark:#E5C07B"> ConfirmedAppointment</span><span style="color:#A626A4;--shiki-dark:#C678DD"> =></span><span style="color:#50A14F;--shiki-dark:#98C379"> 'confirmed'</span><span style="color:#383A42;--shiki-dark:#ABB2BF">,</span></span>
<span class="line"><span style="color:#E45649;--shiki-dark:#E06C75">        $state</span><span style="color:#383A42;--shiki-dark:#C678DD"> instanceof</span><span style="color:#C18401;--shiki-dark:#E5C07B"> CanceledAppointment</span><span style="color:#A626A4;--shiki-dark:#C678DD"> =></span><span style="color:#50A14F;--shiki-dark:#98C379"> 'canceled'</span><span style="color:#383A42;--shiki-dark:#ABB2BF">,</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">    };</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">}</span></span></code></pre>
<p>This is the true power of sealed classes and interfaces.</p> </div> <div class="comments" data-astro-cid-relfimn4> <div id="giscus-container"></div> <script type="module">const t=document.createElement("script");t.src="https://giscus.app/client.js";t.crossOrigin="anonymous";t.async=!0;t.setAttribute("data-repo","jiripudil/jiripudil.cz");t.setAttribute("data-repo-id","MDEwOlJlcG9zaXRvcnkyNTI5NzY3Nw==");t.setAttribute("data-category","Blog discussions");t.setAttribute("data-category-id","DIC_kwDOAYIDDc4CAfUM");t.setAttribute("data-mapping","og:title");t.setAttribute("data-reactions-enabled","1");t.setAttribute("data-emit-metadata","0");t.setAttribute("data-theme","preferred_color_scheme");t.setAttribute("data-lang","en");t.setAttribute("data-loading","lazy");const e=document.getElementById("giscus-container");e.appendChild(t);</script> </div> </div>  </div>   <div class="footer" data-astro-cid-sz7xmlte> <div class="container" data-astro-cid-d6puh33w> 
Content licensed under
<a href="https://creativecommons.org/licenses/by/4.0/" title="Creative Commons Attribution 4.0 International" aria-label="Creative Commons Attribution 4.0 International" data-astro-cid-sz7xmlte> <svg width="0.97em" height="1em" data-astro-cid-sz7xmlte="true" data-icon="fa6-brands:creative-commons">   <symbol id="ai:fa6-brands:creative-commons" viewBox="0 0 496 512"><path fill="currentColor" d="m245.83 214.87l-33.22 17.28c-9.43-19.58-25.24-19.93-27.46-19.93c-22.13 0-33.22 14.61-33.22 43.84c0 23.57 9.21 43.84 33.22 43.84c14.47 0 24.65-7.09 30.57-21.26l30.55 15.5c-6.17 11.51-25.69 38.98-65.1 38.98c-22.6 0-73.96-10.32-73.96-77.05c0-58.69 43-77.06 72.63-77.06c30.72-.01 52.7 11.95 65.99 35.86m143.05 0l-32.78 17.28c-9.5-19.77-25.72-19.93-27.9-19.93c-22.14 0-33.22 14.61-33.22 43.84c0 23.55 9.23 43.84 33.22 43.84c14.45 0 24.65-7.09 30.54-21.26l31 15.5c-2.1 3.75-21.39 38.98-65.09 38.98c-22.69 0-73.96-9.87-73.96-77.05c0-58.67 42.97-77.06 72.63-77.06c30.71-.01 52.58 11.95 65.56 35.86M247.56 8.05C104.74 8.05 0 123.11 0 256.05c0 138.49 113.6 248 247.56 248c129.93 0 248.44-100.87 248.44-248c0-137.87-106.62-248-248.44-248m.87 450.81c-112.54 0-203.7-93.04-203.7-202.81c0-105.42 85.43-203.27 203.72-203.27c112.53 0 202.82 89.46 202.82 203.26c-.01 121.69-99.68 202.82-202.84 202.82"/></symbol><use href="#ai:fa6-brands:creative-commons"></use>  </svg> <svg width="0.97em" height="1em" data-astro-cid-sz7xmlte="true" data-icon="fa6-brands:creative-commons-by">   <symbol id="ai:fa6-brands:creative-commons-by" viewBox="0 0 496 512"><path fill="currentColor" d="M314.9 194.4v101.4h-28.3v120.5h-77.1V295.9h-28.3V194.4c0-4.4 1.6-8.2 4.6-11.3c3.1-3.1 6.9-4.7 11.3-4.7H299c4.1 0 7.8 1.6 11.1 4.7c3.1 3.2 4.8 6.9 4.8 11.3m-101.5-63.7c0-23.3 11.5-35 34.5-35s34.5 11.7 34.5 35q0 34.5-34.5 34.5c-34.5 0-34.5-11.5-34.5-34.5M247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8m.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3"/></symbol><use href="#ai:fa6-brands:creative-commons-by"></use>  </svg> </a>  </div>  </div>  </body></html> 